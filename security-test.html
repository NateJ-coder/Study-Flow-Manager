<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self';
      script-src 'self';
      style-src 'self' 'unsafe-inline';
      img-src 'self' data: https:;
      font-src 'self' data:;
      media-src 'self' https:;
      object-src 'none';
      base-uri 'self';
      frame-ancestors 'none';
    ">
    <title>StudyFlow Security Test Suite</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f8ff; }
        .test-section { margin: 20px 0; padding: 15px; border-radius: 8px; }
        .pass { background: #d4edda; border-left: 4px solid #28a745; }
        .fail { background: #f8d7da; border-left: 4px solid #dc3545; }
        .info { background: #d1ecf1; border-left: 4px solid #17a2b8; }
        h1 { color: #2c3e50; }
        h2 { color: #34495e; }
        code { background: #f1f1f1; padding: 2px 6px; border-radius: 3px; }
        .test-result { font-weight: bold; }
        .console-output { background: #222; color: #0f0; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üîí StudyFlow Security Verification Suite</h1>
    <p>This page tests all implemented security features.</p>

    <div id="test-results">
        <div class="test-section info">
            <h2>Running Security Tests...</h2>
            <p>Please wait while all security features are validated.</p>
        </div>
    </div>

    <script src="js/core.js"></script>
    
    <script type="module">
        import { loadSettings, saveSettings, applyThemeSettings } from "./js/animation-frame.js";
        import { initializeTimerButtons } from "./js/timer-module.js";
        
        const results = [];
        
        function addResult(test, passed, details) {
            results.push({ test, passed, details });
            updateDisplay();
        }
        
        function updateDisplay() {
            const container = document.getElementById('test-results');
            container.innerHTML = '<h2>üîí Security Test Results</h2>';
            
            let passCount = 0;
            let totalCount = results.length;
            
            results.forEach(result => {
                if (result.passed) passCount++;
                
                const div = document.createElement('div');
                div.className = `test-section ${result.passed ? 'pass' : 'fail'}`;
                div.innerHTML = `
                    <h3>${result.passed ? '‚úÖ' : '‚ùå'} ${result.test}</h3>
                    <p class="test-result">${result.passed ? 'PASS' : 'FAIL'}</p>
                    <p>${result.details}</p>
                `;
                container.appendChild(div);
            });
            
            // Add summary
            const summary = document.createElement('div');
            summary.className = `test-section ${passCount === totalCount ? 'pass' : 'fail'}`;
            summary.innerHTML = `
                <h3>üìä Test Summary</h3>
                <p><strong>${passCount}/${totalCount} tests passed</strong></p>
                <p>Security Status: ${passCount === totalCount ? '‚úÖ SECURE' : '‚ö†Ô∏è NEEDS ATTENTION'}</p>
            `;
            container.appendChild(summary);
        }
        
        // Run all security tests
        document.addEventListener('DOMContentLoaded', () => {
            runSecurityTests();
        });
        
        async function runSecurityTests() {
            console.log("üîí Starting StudyFlow Security Test Suite");
            
            // Test 1: CSP Header Present
            try {
                const cspMeta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
                const hasCsp = cspMeta && cspMeta.content.includes('object-src');
                addResult(
                    'Content Security Policy (CSP)', 
                    hasCsp,
                    hasCsp ? 'CSP header found with object-src restriction' : 'CSP header missing or incomplete'
                );
            } catch (e) {
                addResult('Content Security Policy (CSP)', false, 'Error checking CSP: ' + e.message);
            }
            
            // Test 2: Legacy Core.js Loaded
            try {
                const hasState = typeof STATE !== 'undefined';
                addResult(
                    'Legacy Core Module Loading', 
                    hasState,
                    hasState ? 'STATE object found - legacy core.js loaded successfully' : 'STATE object missing - core.js failed to load'
                );
            } catch (e) {
                addResult('Legacy Core Module Loading', false, 'Error: ' + e.message);
            }
            
            // Test 3: ES6 Module Loading
            try {
                // This will throw if modules don't load
                const moduleTest = true; // We're running inside a module, so this works
                addResult(
                    'ES6 Module System', 
                    moduleTest,
                    'ES6 imports working - core-modern.js loaded successfully'
                );
            } catch (e) {
                addResult('ES6 Module System', false, 'Module loading failed: ' + e.message);
            }
            
            // Test 4: Settings Security (Whitelisting)
            try {
                // Test if we can import settings functions
                const { loadSettings } = await import('./js/settings.js');
                const settings = loadSettings();
                
                // Check if settings have version
                const hasVersion = settings && typeof settings.version === 'number';
                addResult(
                    'Settings Versioning & Validation', 
                    hasVersion,
                    hasVersion ? `Settings loaded with version ${settings.version}` : 'Settings missing version field'
                );
            } catch (e) {
                addResult('Settings Versioning & Validation', false, 'Settings test failed: ' + e.message);
            }
            
            // Test 5: Event Listener Guards
            try {
                const testBtn = document.createElement('button');
                testBtn.id = 'test-btn';
                document.body.appendChild(testBtn);
                
                // Test idempotent binding
                const { initializeTimerButtons } = await import('./js/timer-module.js');
                // This should be safe to call multiple times
                initializeTimerButtons();
                initializeTimerButtons();
                
                document.body.removeChild(testBtn);
                addResult(
                    'Event Listener Idempotency', 
                    true,
                    'Timer button initialization is idempotent - no duplicate listeners'
                );
            } catch (e) {
                addResult('Event Listener Idempotency', false, 'Event guard test failed: ' + e.message);
            }
            
            // Test 6: Reduced Motion Support
            try {
                // Test if prefers-reduced-motion is detected and respected
                const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                const cssLoaded = Array.from(document.styleSheets).some(sheet => 
                    sheet.href && sheet.href.includes('style.css')
                );
                
                // Check if accessibility attributes are present on buttons
                const startBtn = document.getElementById('btn-start');
                const resetBtn = document.getElementById('btn-reset');
                const hasAriaLabels = startBtn?.getAttribute('aria-label') && resetBtn?.getAttribute('aria-label');
                
                addResult(
                    'Accessibility Compliance', 
                    cssLoaded && hasAriaLabels,
                    `CSS: ${cssLoaded ? '‚úÖ' : '‚ùå'}, ARIA Labels: ${hasAriaLabels ? '‚úÖ' : '‚ùå'}, Reduced Motion Detected: ${prefersReducedMotion ? '‚úÖ' : 'N/A'}`
                );
            } catch (e) {
                addResult('Accessibility Compliance', false, 'Accessibility test failed: ' + e.message);
            }
            
            // Test 7: LocalStorage Size Limits
            try {
                const { saveSettings } = await import('./js/settings.js');
                
                // Test saving normal settings
                const normalSettings = { version: 1, season: 'summer', background_brightness: 75 };
                const saveResult = saveSettings(normalSettings);
                
                addResult(
                    'LocalStorage Security', 
                    saveResult,
                    saveResult ? 'Settings saved successfully with validation' : 'Settings save validation failed'
                );
            } catch (e) {
                addResult('LocalStorage Security', false, 'Storage test failed: ' + e.message);
            }
            
            // Test 8: Safe SVG Insertion
            try {
                // Check if SVG utility functions are available
                const { safeInsertSVG } = await import('./js/svg-utils.js');
                const hasSafeSVG = typeof safeInsertSVG === 'function';
                
                addResult(
                    'Safe SVG Insertion', 
                    hasSafeSVG,
                    hasSafeSVG ? 'SVG sanitization utility available - XSS protection active' : 'SVG sanitization missing - potential XSS risk'
                );
            } catch (e) {
                addResult('Safe SVG Insertion', false, 'SVG safety check failed: ' + e.message);
            }
            
            // Test 9: DOM Injection Safety  
            try {
                // Check that timer buttons have proper accessibility
                const startBtn = document.getElementById('btn-start');
                const resetBtn = document.getElementById('btn-reset');
                
                const hasTabIndex = startBtn?.tabIndex >= 0 && resetBtn?.tabIndex >= 0;
                const hasAriaLabels = startBtn?.getAttribute('aria-label') && resetBtn?.getAttribute('aria-label');
                
                addResult(
                    'DOM Safety & Accessibility', 
                    hasTabIndex && hasAriaLabels,
                    `Keyboard Navigation: ${hasTabIndex ? '‚úÖ' : '‚ùå'}, Screen Reader Support: ${hasAriaLabels ? '‚úÖ' : '‚ùå'}`
                );
            } catch (e) {
                addResult('DOM Safety & Accessibility', false, 'DOM safety check failed: ' + e.message);
            }
            
            console.log("‚úÖ Security test suite completed");
        }
    </script>
</body>
</html>