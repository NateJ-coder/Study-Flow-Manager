<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="StudyFlow Manager - Pomodoro Timer">
  <title>StudyFlow Timer</title>
  
  <!-- Critical CSS Inline -->
  <style>
    /* Using system fonts for performance */
    :root {
      --primary-bg: #0f1419;
      --text-color: #e7eaee;
      --accent-color: #64ffda;
      --card-bg: rgba(15, 20, 25, 0.85); /* Semi-transparent dark background */
      --btn-bg: #1c232d;
      --btn-hover: #293440;
      --timer-text-size: 5rem;
      --timer-mode-size: 1.5rem;
      --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    }

    /* Theme-specific Overrides (set by JS) */
    .autumn-theme { --particle-color: rgba(255, 140, 0, 0.7); } /* Dark Orange/Red for leaves */
    .winter-theme { --particle-color: rgba(200, 230, 255, 0.9); } /* Light Blue/White for snowflakes */
    .summer-theme { --particle-color: rgba(255, 255, 0, 0.5); } /* Yellow/Gold for fireflies/glow */

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family);
      background: var(--primary-bg);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: background-color 0.5s;
    }

    /* Background and Particle Containers */
    #bg-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      z-index: -2;
    }
    
    #background-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0.9;
      transition: opacity 1.5s ease-in-out;
    }

    #particle-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }
    
    /* Header (Logo and Clock) */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      z-index: 10;
    }

    .studyflow-logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent-color);
    }
    
    .clock-container {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.1rem;
    }

    /* Main Timer Card */
    .container {
      padding: 2rem 1rem;
      max-width: 90%;
      width: 450px;
    }
    
    .timer-card {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 2.5rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      position: relative;
      text-align: center;
    }
    
    /* Utility Icons */
    .card-icon {
      position: absolute;
      top: 1.5rem;
      cursor: pointer;
      width: 24px;
      height: 24px;
      fill: var(--text-color);
      transition: fill 0.2s, transform 0.1s;
    }

    .card-icon:hover {
      fill: var(--accent-color);
      transform: scale(1.05);
    }
    
    .calendar-icon { right: 1.5rem; }
    .settings-icon { right: 4.5rem; }

    .back-btn {
      position: absolute;
      top: 1.2rem;
      left: 1.5rem;
      background: #8b4513; /* Wooden style color */
      color: #fff;
      padding: 0.3rem 0.8rem;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      border: 2px solid #5a2e0a;
      box-shadow: 0 3px 5px rgba(0, 0, 0, 0.4);
      transition: background 0.2s, transform 0.1s;
    }

    .back-btn:hover {
      background: #9d5220;
    }
    
    /* Timer Content */
    .timer-mode {
      font-size: var(--timer-mode-size);
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: var(--accent-color);
      text-transform: uppercase;
    }
    
    .timer-display {
      font-size: var(--timer-text-size);
      font-weight: 700;
      margin: 0.5rem 0 1.5rem;
      letter-spacing: 0.1rem;
    }
    
    .timer-controls {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
    }
    
    .control-btn {
      background: var(--btn-bg);
      color: var(--text-color);
      border: none;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .control-btn:hover {
      background: var(--btn-hover);
      transform: translateY(-2px);
    }

    .control-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    }

    .session-info {
      margin-top: 1.5rem;
      font-size: 0.9rem;
      color: #b0b0b0;
    }

    /* Loading Indicator */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--primary-bg);
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--accent-color);
      font-size: 1.5rem;
      z-index: 100;
      transition: opacity 0.5s;
    }

    /* Settings Modal (Placeholder) */
    .settings-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
      z-index: 20;
      max-width: 400px;
      width: 90%;
      display: none;
    }

    .settings-modal.show { display: block; }
    
    .settings-modal h2 { margin-bottom: 1.5rem; font-size: 1.8rem; }
    
    .setting-group {
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .setting-group label {
      font-size: 1rem;
      margin-right: 1rem;
    }

    .setting-group select {
      background: var(--btn-bg);
      color: var(--text-color);
      border: 1px solid var(--btn-hover);
      padding: 0.5rem;
      border-radius: 8px;
      cursor: pointer;
    }
    
    .settings-close-btn {
      margin-top: 1.5rem;
      background: var(--accent-color);
      color: var(--primary-bg);
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: opacity 0.2s;
    }

    .settings-close-btn:hover { opacity: 0.8; }


    /* Responsive Mobile Adaptations */
    @media (max-width: 768px) {
      :root {
        --timer-text-size: 4rem;
        --timer-mode-size: 1.2rem;
      }
      .header {
        padding: 0.75rem 1rem;
      }
      .studyflow-logo {
        font-size: 1.2rem;
      }
      .clock-container {
        font-size: 0.9rem;
      }
      .timer-card {
        padding: 2rem 1.5rem;
      }
      .timer-controls {
        flex-direction: column;
        gap: 0.75rem;
      }
      .control-btn {
        width: 100%;
        padding: 0.8rem 1rem;
      }
      .back-btn {
        top: 0.75rem;
        left: 0.75rem;
      }
      .calendar-icon { right: 0.75rem; }
      .settings-icon { right: 3.5rem; }
    }
    
  </style>
</head>
<body>

  <!-- Loading Overlay -->
  <div id="loading-overlay">Initializing StudyFlow...</div>

  <!-- Background Layer -->
  <div id="bg-container">
    <img id="background-image" src="" alt="Dynamic StudyFlow Background" />
    <canvas id="particle-canvas"></canvas>
  </div>
  
  <!-- Header -->
  <header class="header">
    <div class="studyflow-logo">StudyFlow</div>
    <div class="clock-container">
      <!-- Clock Icon SVG -->
      <svg class="clock-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.58 20 4 16.42 4 12C4 7.58 7.58 4 12 4C16.42 4 20 7.58 20 12C20 16.42 16.42 20 12 20ZM12.5 7H11V13L16.2 16.1L16.9 14.9L12.5 12.3V7Z" fill="currentColor"/>
      </svg>
      <div id="perpetual-clock">00:00:00</div>
    </div>
  </header>

  <!-- Main Content Container -->
  <div class="container">
    <div class="timer-card">
      <button class="back-btn" onclick="window.location.href='welcome.html'">
        &larr; Back
      </button>

      <!-- Calendar Icon SVG -->
      <svg class="card-icon calendar-icon" onclick="showCalendarModal()" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M19 4H18V2H16V4H8V2H6V4H5C3.89 4 3 4.9 3 6V20C3 21.1 3.89 22 5 22H19C20.1 22 21 21.1 21 20V6C21 4.9 20.1 4 19 4ZM19 20H5V10H19V20ZM19 8H5V6H19V8Z" fill="currentColor"/>
      </svg>
      
      <!-- Settings Icon SVG -->
      <svg class="card-icon settings-icon" id="settingsButton" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M19.4 12.98C19.4 12.56 19.44 12.28 19.44 12C19.44 11.72 19.4 11.44 19.4 11.02L21.54 9.38C21.73 9.24 21.77 8.97 21.66 8.76L19.5 5.14C19.39 4.94 19.1 4.88 18.89 4.97L16.41 5.95C15.84 5.48 15.22 5.06 14.54 4.74L14.15 2.21C14.11 1.95 13.88 1.76 13.61 1.76H10.39C10.12 1.76 9.89 1.95 9.85 2.21L9.46 4.74C8.78 5.06 8.16 5.48 7.59 5.95L5.11 4.97C4.9 4.88 4.61 4.94 4.5 5.14L2.34 8.76C2.23 8.97 2.27 9.24 2.46 9.38L4.6 11.02C4.6 11.44 4.56 11.72 4.56 12C4.56 12.28 4.6 12.56 4.6 12.98L2.46 14.62C2.27 14.76 2.23 15.03 2.34 15.24L4.5 18.86C4.61 19.06 4.9 19.12 5.11 19.03L7.59 18.05C8.16 18.52 8.78 18.94 9.46 19.26L9.85 21.79C9.89 22.05 10.12 22.24 10.39 22.24H13.61C13.88 22.24 14.11 22.05 14.15 21.79L14.54 19.26C15.22 18.94 15.84 18.52 16.41 18.05L18.89 19.03C19.1 19.12 19.39 19.06 19.5 18.86L21.66 15.24C21.77 15.03 21.73 14.76 21.54 14.62L19.4 12.98ZM12 16C9.79 16 8 14.21 8 12C8 9.79 9.79 8 12 8C14.21 8 16 9.79 16 12C16 14.21 14.21 16 12 16Z" fill="currentColor"/>
      </svg>

      <div id="timer-mode" class="timer-mode">Focus Session</div>
      <div id="timer-display" class="timer-display">25:00</div>
      
      <div class="timer-controls">
        <button id="startButton" class="control-btn">Start</button>
        <button id="resetButton" class="control-btn" disabled>Reset</button>
      </div>

      <p class="session-info">Time to dive into deep work. Good luck!</p>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="settings-modal" id="settingsModal">
    <h2>Settings</h2>
    
    <div class="setting-group">
      <label for="theme-select">Seasonal Theme</label>
      <select id="theme-select">
        <option value="autumn">Autumn 🍂</option>
        <option value="winter">Winter ❄️</option>
        <option value="summer">Summer ☀️</option>
      </select>
    </div>

    <div class="setting-group">
      <label for="focus-duration">Focus Duration (min)</label>
      <select id="focus-duration">
        <option value="25">25</option>
        <option value="30">30</option>
        <option value="45">45</option>
        <option value="60">60</option>
      </select>
    </div>
    
    <!-- Placeholder for other settings like audio volume -->
    <button class="settings-close-btn" onclick="toggleSettingsModal(false)">Close</button>
  </div>

  <!-- Firebase and Core Logic -->
  <script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global Firebase Variables
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app;
    let db;
    let auth;
    let userId = null;
    let isAuthReady = false;

    // --- APPLICATION STATE AND CONFIGURATION ---
    
    // Theme and Background Config based on BACKGROUND_SYSTEM_SPEC.md
    const BACKGROUND_CONFIG = {
      summer: {
        images: {
          day: Array.from({ length: 8 }, (_, i) => `assets/images/summer-day-${i + 1}.png`),
          night: Array.from({ length: 8 }, (_, i) => `assets/images/summer-night-${i + 1}.png`),
        },
        particles: { count: 30, size: 2, speed: 0.5, type: 'glow' } // Subtle summer glow
      },
      autumn: {
        images: {
          day: Array.from({ length: 8 }, (_, i) => `assets/images/autumn-day-${i + 1}.png`),
          night: Array.from({ length: 8 }, (_, i) => `assets/images/autumn-night-${i + 1}.png`),
        },
        particles: { count: 50, size: 6, speed: 1.5, type: 'leaf' } // Falling leaves
      },
      winter: {
        images: {
          day: Array.from({ length: 7 }, (_, i) => `assets/images/winter-day-${i + 1}.png`),
          night: Array.from({ length: 7 }, (_, i) => `assets/images/winter-night-${i + 1}.png`),
        },
        particles: { count: 70, size: 4, speed: 1, type: 'snow' } // Snowflakes
      }
    };

    // Default Settings
    let appSettings = {
      theme: 'autumn',
      bgIndex: 0,
      focusDuration: 25, // minutes
    };

    // Timer State
    let timerInterval = null;
    let totalSeconds = appSettings.focusDuration * 60;
    let isRunning = false;
    let isFocusSession = true; // Placeholder for future Pomodoro logic


    // --- FIREBASE AND AUTHENTICATION ---

    async function initializeFirebase() {
      try {
        if (Object.keys(firebaseConfig).length === 0) {
          console.warn("Firebase config is empty. Functionality will be limited.");
          return;
        }
        
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        // Custom token sign-in for Canvas environment
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
            console.log('Firebase user authenticated. User ID:', userId);
          } else {
            // Fallback for extremely rare cases or sign-out
            userId = crypto.randomUUID();
            console.log('Firebase signed out/anonymous. Using temporary ID:', userId);
          }
          isAuthReady = true;
          loadSettings();
          // Hide loading overlay once settings are loaded and app is ready
          document.getElementById('loading-overlay').style.opacity = '0';
          setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 500);
        });

      } catch (error) {
        console.error("Error initializing Firebase or signing in:", error);
        userId = crypto.randomUUID(); // Use temporary ID if Firebase fails entirely
        isAuthReady = true;
        loadSettings();
        document.getElementById('loading-overlay').style.opacity = '0';
        setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 500);
      }
    }


    // --- SETTINGS PERSISTENCE (Firestore) ---

    function getSettingsDocRef() {
      if (!db || !userId) return null;
      // Using private data path: /artifacts/{appId}/users/{userId}/settings/{documentId}
      return doc(db, 'artifacts', appId, 'users', userId, 'settings', 'user-prefs');
    }

    async function saveSettings() {
      if (!isAuthReady || !userId) {
        console.warn("Auth not ready, cannot save settings.");
        return;
      }
      const docRef = getSettingsDocRef();
      if (docRef) {
        try {
          await setDoc(docRef, appSettings, { merge: true });
          console.log('Settings saved to Firestore successfully.');
        } catch (error) {
          console.error('Error saving settings to Firestore:', error);
        }
      }
    }

    async function loadSettings() {
      if (!isAuthReady || !userId) {
        // If auth isn't ready, this is called by onAuthStateChanged later.
        return;
      }
      const docRef = getSettingsDocRef();
      if (docRef) {
        try {
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            const loadedSettings = docSnap.data();
            appSettings = { ...appSettings, ...loadedSettings };
            console.log('Settings loaded from Firestore:', appSettings);
          } else {
            console.log('No existing settings found in Firestore. Using defaults.');
          }
        } catch (error) {
          console.error('Error loading settings from Firestore:', error);
        }
      }
      
      // Apply loaded or default settings
      applySettings();
    }

    function applySettings() {
      // 1. Apply Theme
      document.body.className = `${appSettings.theme}-theme`;
      document.getElementById('theme-select').value = appSettings.theme;

      // 2. Apply Background (Force update to use loaded index)
      initializeBackgroundSystem(true); 

      // 3. Apply Timer Duration
      totalSeconds = appSettings.focusDuration * 60;
      document.getElementById('focus-duration').value = appSettings.focusDuration;
      updateDisplay();
    }


    // --- BACKGROUND SYSTEM LOGIC ---

    const backgroundImageElement = document.getElementById('background-image');
    let isNight = false;

    function isNightTime() {
      const now = new Date();
      const hour = now.getHours();
      // Day is 06:00 (6) to 17:59 (17). Night is 18:00 (18) to 05:59 (5).
      return hour >= 18 || hour < 6;
    }

    function getCurrentImageAssets() {
      const themeConfig = BACKGROUND_CONFIG[appSettings.theme];
      const timeOfDay = isNight ? 'night' : 'day';
      return themeConfig.images[timeOfDay];
    }

    function preloadImage(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(url);
        img.onerror = () => reject(new Error(`Failed to load image: ${url}`));
        img.src = url;
      });
    }

    async function updateBackground(forceUpdate = false) {
      isNight = isNightTime();
      const assets = getCurrentImageAssets();
      const oldIndex = appSettings.bgIndex;
      
      if (!forceUpdate) {
        // Cycle to the next image
        appSettings.bgIndex = (appSettings.bgIndex + 1) % assets.length;
      } else if (appSettings.bgIndex >= assets.length) {
         // Reset index if the theme changed and the old index is out of bounds
         appSettings.bgIndex = 0;
      }

      const nextImage = assets[appSettings.bgIndex];

      if (backgroundImageElement.src.includes(nextImage) && !forceUpdate) {
          // Image hasn't changed (day/night boundary crossed or first run with correct image)
          console.log(`🖼️ Background skipped. Current: ${nextImage.split('/').pop()}`);
          return;
      }

      console.log(`🖼️ Loading background: ${nextImage.split('/').pop()} (Index: ${appSettings.bgIndex})`);

      try {
        // Preload the next image before setting it
        await preloadImage(nextImage);
        
        // Smooth transition
        backgroundImageElement.style.opacity = '0.1';
        setTimeout(() => {
          backgroundImageElement.src = nextImage;
          backgroundImageElement.style.opacity = '0.9';
        }, 300); // Transition time for opacity fade out
        
        // Save the new index/theme
        if (oldIndex !== appSettings.bgIndex || forceUpdate) {
          saveSettings();
        }

      } catch (error) {
        console.error(error.message);
      }
    }
    
    // Function to run when the theme changes (called by settings modal)
    function changeTheme(newTheme) {
        if (appSettings.theme !== newTheme) {
            appSettings.theme = newTheme;
            appSettings.bgIndex = 0; // Reset index on theme change
            document.body.className = `${newTheme}-theme`;
            
            // Reinitialize with force update and new particles
            initializeBackgroundSystem(true); 
        }
    }

    // Main initialisation function for the background system
    function initializeBackgroundSystem(force = false) {
      const isInitialLoad = !timerInterval && !force; // Only run slideshow interval once
      
      // Update background immediately
      updateBackground(true); 
      
      // Set up the background slideshow to run every 30 minutes
      if (isInitialLoad) {
        // Check day/night boundary every minute to ensure the correct image set is used.
        setInterval(() => {
          if (isNight !== isNightTime()) {
            // Day/Night transition detected, force an immediate update and reset index
            console.log(`🌓 Day/Night transition detected. Switching image set.`);
            appSettings.bgIndex = 0;
            updateBackground(true);
          }
        }, 60000); // Check every minute

        // Cycle through images every 30 minutes (1,800,000 ms)
        setInterval(() => updateBackground(false), 1800000);
      }
      
      // Initialize Particles based on current theme
      initializeParticles(BACKGROUND_CONFIG[appSettings.theme].particles);
    }
    

    // --- PARTICLE SYSTEM (Canvas) ---
    const canvas = document.getElementById('particle-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    let animationFrameId;

    function initializeParticles(config) {
        // Stop any running animation
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            particles = [];
        }

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        for (let i = 0; i < config.count; i++) {
            particles.push(createParticle(config));
        }

        drawParticles(config);
    }

    function createParticle(config) {
      return {
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        size: config.size + Math.random() * 2,
        speed: config.speed * (0.5 + Math.random()),
        // Angle only relevant for leaf/snow to give slight horizontal drift
        angle: Math.random() * 360, 
      };
    }

    function drawParticles(config) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--particle-color').trim() || '#fff';
      
      particles.forEach(p => {
        // Update position
        p.y += p.speed;
        
        if (config.type === 'leaf' || config.type === 'snow') {
            // Add slight horizontal sway for snow/leaves
            p.x += Math.sin(p.y / 100) * 0.5;
        } else if (config.type === 'glow') {
            // Subtle random drift for glow/fireflies
            p.x += (Math.random() - 0.5) * 0.5;
        }

        // Wrap around when it falls off screen
        if (p.y > canvas.height) {
          p.y = -p.size;
          p.x = Math.random() * canvas.width; // Reset horizontal position too
        }

        // Draw particle
        ctx.beginPath();
        if (config.type === 'snow') {
            ctx.arc(p.x, p.y, p.size / 2, 0, Math.PI * 2); // Simple circles for snow
        } else if (config.type === 'leaf') {
            ctx.fillRect(p.x, p.y, p.size, p.size * 0.5); // Rectangular shape for simple leaf
        } else {
            // Glow effect (Subtle circle)
            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            // Optional: add a blur/shadow for a better glow effect
            ctx.shadowColor = ctx.fillStyle;
            ctx.shadowBlur = p.size * 3;
        }
        ctx.fill();
        ctx.shadowBlur = 0; // Reset shadow for next draw
      });

      animationFrameId = requestAnimationFrame(() => drawParticles(config));
    }
    
    // Handle canvas resize
    window.addEventListener('resize', () => {
        if (canvas) {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            // Re-initialize particles to fit the new size
            initializeParticles(BACKGROUND_CONFIG[appSettings.theme].particles);
        }
    });


    // --- PERPETUAL CLOCK ---

    function updatePerpetualClock() {
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      const s = String(now.getSeconds()).padStart(2, '0');
      document.getElementById('perpetual-clock').textContent = `${h}:${m}:${s}`;
    }

    // Update the clock every second
    setInterval(updatePerpetualClock, 1000);
    updatePerpetualClock();


    // --- TIMER LOGIC (Placeholder) ---

    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
    }

    function updateDisplay() {
      document.getElementById('timer-display').textContent = formatTime(totalSeconds);
      document.getElementById('timer-mode').textContent = isFocusSession ? 'Focus Session' : 'Short Break'; // Placeholder
    }

    function startTimer() {
      if (isRunning) {
        clearInterval(timerInterval);
        isRunning = false;
        document.getElementById('startButton').textContent = 'Resume';
      } else {
        isRunning = true;
        document.getElementById('startButton').textContent = 'Pause';
        document.getElementById('resetButton').disabled = false;

        timerInterval = setInterval(() => {
          totalSeconds--;
          updateDisplay();

          if (totalSeconds <= 0) {
            clearInterval(timerInterval);
            isRunning = false;
            document.getElementById('startButton').textContent = 'Start';
            document.getElementById('resetButton').disabled = true;
            console.log('Timer finished!');
            // TODO: Add notification and audio feedback here
          }
        }, 1000);
      }
    }

    function resetTimer() {
      clearInterval(timerInterval);
      isRunning = false;
      document.getElementById('startButton').textContent = 'Start';
      document.getElementById('resetButton').disabled = true;
      totalSeconds = appSettings.focusDuration * 60; // Reset to configured duration
      updateDisplay();
    }


    // --- EVENT LISTENERS AND MODALS ---
    
    function toggleSettingsModal(show) {
      const modal = document.getElementById('settingsModal');
      modal.classList.toggle('show', show);
    }
    
    function showCalendarModal() {
        // Placeholder for future calendar page/modal
        console.log('Calendar button clicked. Future navigation to calendar.html or modal logic here.');
    }

    // Hook up button handlers
    document.getElementById('startButton').addEventListener('click', startTimer);
    document.getElementById('resetButton').addEventListener('click', resetTimer);
    document.getElementById('settingsButton').addEventListener('click', () => toggleSettingsModal(true));
    
    // Settings change handlers
    document.getElementById('theme-select').addEventListener('change', (e) => {
        changeTheme(e.target.value);
    });
    
    document.getElementById('focus-duration').addEventListener('change', (e) => {
        appSettings.focusDuration = parseInt(e.target.value);
        saveSettings();
        // Reset timer to new duration if not running
        if (!isRunning) {
            resetTimer();
        }
    });


    // --- INITIALIZATION ---
    window.onload = initializeFirebase;

  </script>
</body>
</html>