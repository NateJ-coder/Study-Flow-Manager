<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StudyFlow Timer - Focus & Flow</title>
  
  <!-- Performance Preloads -->
  <link rel="preload" href="assets/images/autumn-day-8.png" as="image" fetchpriority="high">
  <link rel="preload" href="assets/audio/click.mp3" as="audio">
  <link rel="preload" href="assets/audio/splash.mp3" as="audio">
  
  <!-- Critical CSS Inline for Performance -->
  <style>
    /* ============================================ */
    /* CRITICAL CSS - Performance Optimized */
    /* ============================================ */
    
    :root {
      --primary-bg: #0f1419;
      --text-color: #e7eaee;
      --amber-300: #fcd34d;
      --amber-500: #f59e0b;
      --amber-600: #d97706;
      
      /* Seasonal Color Variables - Default: Autumn */
      --season-primary: #CD853F;
      --season-secondary: #D2691E;
      --season-accent: #FF8C00;
      --season-text: #FFF8DC;
      --season-border: rgba(205, 133, 63, 0.3);
    }
    
    /* Summer Theme Colors */
    body.summer-theme {
      --season-primary: #228B22;
      --season-secondary: #32CD32;
      --season-accent: #00FF7F;
      --season-text: #F0FFF0;
      --season-border: rgba(34, 139, 34, 0.3);
    }
    
    /* Winter Theme Colors */
    body.winter-theme {
      --season-primary: #F0F8FF;
      --season-secondary: #E6E6FA;
      --season-accent: #B0E0E6;
      --season-text: #2F4F4F;
      --season-border: rgba(240, 248, 255, 0.3);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--primary-bg);
      color: var(--text-color);
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* Background container with slideshow capability */
    .bg-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      filter: brightness(0.7) blur(1px);
      transition: opacity 1s ease-in-out;
      z-index: 0;
    }
    
    /* Main container */
    .container {
      position: relative;
      z-index: 10;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
      background: rgba(0, 0, 0, 0.4);
      padding: 2rem;
    }
    
    /* Timer interface card */
    .timer-card {
      background: rgba(0, 0, 0, 0.8);
      padding: 3rem;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border: 2px solid var(--season-border);
      max-width: 500px;
      width: 90%;
      position: relative;
    }
    
    /* StudyFlow title */
    .app-title {
      font-size: clamp(2.5rem, 6vw, 4rem);
      font-weight: 900;
      color: var(--season-primary);
      margin-bottom: 2rem;
      text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.3);
      animation: subtle-glow 3s ease-in-out infinite alternate;
    }
    
    @keyframes subtle-glow {
      0% { text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.3); }
      100% { text-shadow: 4px 4px 12px var(--season-border); }
    }
    
    /* Timer display */
    .timer-display {
      font-size: clamp(3rem, 8vw, 5rem);
      font-weight: 300;
      font-variant-numeric: tabular-nums;
      line-height: 1;
      margin: 2rem 0;
      color: var(--season-primary);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      font-family: 'Courier New', monospace;
      letter-spacing: 0.1em;
    }
    
    /* Timer mode indicator */
    .timer-mode {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1rem;
      opacity: 0.9;
      color: var(--season-secondary);
    }
    
    /* Button controls container */
    .timer-controls {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin: 2rem 0;
      flex-wrap: wrap;
    }
    
    /* Wooden-style buttons */
    .wooden-btn {
      position: relative;
      padding: 14px 28px;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      
      /* Wooden appearance */
      background: linear-gradient(145deg, #8B4513, #654321);
      color: var(--season-text);
      border: 2px solid #A0522D;
      box-shadow: 
        inset 2px 2px 5px rgba(160, 82, 45, 0.3),
        inset -2px -2px 5px rgba(0, 0, 0, 0.3),
        0 4px 8px rgba(0, 0, 0, 0.2);
      
      /* Wood grain effect */
      background-image: 
        linear-gradient(90deg, transparent 50%, rgba(0, 0, 0, 0.1) 50%),
        linear-gradient(45deg, transparent 25%, rgba(139, 69, 19, 0.3) 25%, rgba(139, 69, 19, 0.3) 75%, transparent 75%);
      background-size: 4px 4px, 8px 8px;
    }
    
    .wooden-btn:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 
        inset 2px 2px 5px rgba(160, 82, 45, 0.4),
        inset -2px -2px 5px rgba(0, 0, 0, 0.4),
        0 6px 12px rgba(0, 0, 0, 0.3);
    }
    
    .wooden-btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 
        inset 2px 2px 8px rgba(0, 0, 0, 0.3),
        inset -2px -2px 3px rgba(160, 82, 45, 0.2),
        0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    /* Perpetual Clock - Top Right */
    .perpetual-clock {
      position: fixed;
      top: 2rem;
      right: 2rem;
      z-index: 20;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--season-secondary);
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      font-family: 'Courier New', monospace;
      letter-spacing: 0.1em;
    }
    
    /* Settings icon */
    .settings-icon {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 32px;
      height: 32px;
      cursor: pointer;
      opacity: 0.6;
      transition: all 0.2s ease;
      background: none;
      border: none;
      color: var(--season-secondary);
    }
    
    .settings-icon:hover {
      opacity: 1;
      transform: rotate(45deg) scale(1.1);
    }
    
    /* Back button */
    .back-btn {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: var(--text-color);
      padding: 0.5rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }
    
    .back-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.05);
    }
    
    /* Settings modal */
    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(8px);
    }
    
    .settings-content {
      background: rgba(0, 0, 0, 0.9);
      padding: 2rem;
      border-radius: 20px;
      border: 2px solid var(--season-border);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .settings-group {
      margin-bottom: 2rem;
    }
    
    .settings-group h3 {
      color: var(--season-primary);
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }
    
    .settings-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      gap: 1rem;
    }
    
    .settings-input {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--season-border);
      border-radius: 8px;
      padding: 0.5rem;
      color: var(--text-color);
      width: 80px;
      text-align: center;
    }
    
    .theme-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .theme-option {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 1rem;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease;
    }
    
    .theme-option:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .theme-option.active {
      border-color: var(--season-secondary);
      background: var(--season-border);
    }
    
    /* Toggle switch */
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 24px;
      background: #ccc;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .toggle-switch.active {
      background: var(--season-secondary);
    }
    
    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }
    
    .toggle-switch.active::after {
      transform: translateX(26px);
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .timer-card {
        padding: 2rem;
        margin: 1rem;
      }
      
      .timer-controls {
        flex-direction: column;
        align-items: center;
      }
      
      .wooden-btn {
        width: 100%;
        max-width: 200px;
      }
      
      .perpetual-clock {
        top: 1rem;
        right: 1rem;
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body class="autumn-theme">
  <!-- Perpetual Clock -->
  <div class="perpetual-clock" id="perpetual-clock">00:00:00</div>
  
  <!-- Dynamic background container -->
  <div id="bg-container" class="bg-container" style="background-image: url('assets/images/autumn-day-8.png');"></div>
  
  <!-- Main application -->
  <div class="container">
    <div class="timer-card">
      <!-- Back button -->
      <a href="welcome.html" class="back-btn wooden-btn" onclick="playClickSound(event)">
        <span>←</span> Back
      </a>
      
      <!-- Settings icon -->
      <button class="settings-icon" onclick="openSettings(); playClickSound(event);" title="Settings">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
        </svg>
      </button>
      
      <!-- App title -->
      <h1 class="app-title">StudyFlow</h1>
      
      <!-- Timer mode -->
      <div class="timer-mode" id="timer-mode">Focus Session</div>
      
      <!-- Timer display -->
      <div class="timer-display" id="timer-display">25:00</div>
      
      <!-- Timer controls -->
      <div class="timer-controls">
        <button class="wooden-btn" id="startButton" onclick="toggleTimer(); playClickSound(event);">
          <span id="start-icon">▶</span>
          <span id="start-text">Start</span>
        </button>
        
        <button class="wooden-btn" id="resetButton" onclick="resetTimer(); playClickSound(event);">
          <span>↺</span>
          Reset
        </button>
      </div>
      
      <!-- Session info -->
      <div style="opacity: 0.7; font-size: 0.9rem; margin-top: 1rem;">
        <p>Session <span id="session-count">1</span> of <span id="total-sessions">4</span> • <span id="session-type">Focus</span></p>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="settings-modal" id="settings-modal">
    <div class="settings-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h2 style="color: var(--season-primary); margin: 0;">Timer Settings</h2>
        <button onclick="closeSettings(); playClickSound(event);" style="background: none; border: none; color: var(--text-color); font-size: 1.5rem; cursor: pointer;">×</button>
      </div>
      
      <!-- Pomodoro Settings -->
      <div class="settings-group">
        <h3>🍅 Pomodoro Settings</h3>
        <div class="settings-row">
          <label>Focus Time (minutes):</label>
          <input type="number" id="focus-time" class="settings-input" value="25" min="1" max="120">
        </div>
        <div class="settings-row">
          <label>Short Break (minutes):</label>
          <input type="number" id="short-break" class="settings-input" value="5" min="1" max="30">
        </div>
        <div class="settings-row">
          <label>Long Break (minutes):</label>
          <input type="number" id="long-break" class="settings-input" value="15" min="1" max="60">
        </div>
        <div class="settings-row">
          <label>Sessions until Long Break:</label>
          <input type="number" id="sessions-until-long" class="settings-input" value="4" min="2" max="8">
        </div>
      </div>
      
      <!-- Audio Settings -->
      <div class="settings-group">
        <h3>🔊 Audio Settings</h3>
        <div class="settings-row">
          <label>Timer Completion Sound:</label>
          <div class="toggle-switch" id="notification-audio-toggle" onclick="toggleAudioNotification(); playClickSound(event);">
          </div>
        </div>
        <div class="settings-row">
          <label>Button Click Sounds:</label>
          <div class="toggle-switch active" id="click-audio-toggle" onclick="toggleClickAudio(); playClickSound(event);">
          </div>
        </div>
      </div>
      
      <!-- Background Settings -->
      <div class="settings-group">
        <h3>🖼️ Background Settings</h3>
        <div class="settings-row">
          <label>Slideshow Transition (seconds):</label>
          <input type="number" id="slideshow-time" class="settings-input" value="20" min="5" max="120">
        </div>
      </div>
      
      <!-- Theme Settings -->
      <div class="settings-group">
        <h3>🎨 Theme</h3>
        <div class="theme-selector">
          <div class="theme-option active" data-theme="autumn" onclick="selectTheme('autumn'); playClickSound(event);">
            <div>🍂</div>
            <div>Autumn</div>
          </div>
          <div class="theme-option" data-theme="summer" onclick="selectTheme('summer'); playClickSound(event);">
            <div>🌿</div>
            <div>Summer</div>
          </div>
          <div class="theme-option" data-theme="winter" onclick="selectTheme('winter'); playClickSound(event);">
            <div>❄️</div>
            <div>Winter</div>
          </div>
        </div>
      </div>
      
      <!-- Save button -->
      <div style="text-align: center; margin-top: 2rem;">
        <button class="wooden-btn" onclick="saveSettings(); closeSettings(); playClickSound(event);">
          Save Settings
        </button>
      </div>
    </div>
  </div>

  <!-- Performance-Optimized Scripts -->
  <script src="assets/js/settings.js" defer></script>
  <script src="assets/js/timer.js" defer></script>
  
  <script>
    // ============================================
    // GLOBAL SETTINGS & STATE
    // ============================================
    
    window.timerSettings = {
      focusTime: 25,
      shortBreak: 5,
      longBreak: 15,
      sessionsUntilLong: 4,
      slideshowTime: 20,
      theme: 'autumn',
      notificationAudio: true,
      clickAudio: true
    };
    
    // ============================================
    // AUDIO & UI INTERACTIONS
    // ============================================
    
    function playClickSound(event) {
      if (!window.timerSettings.clickAudio) return;
      
      if (event) event.preventDefault();
      
      try {
        const audio = new Audio('assets/audio/click.mp3');
        audio.volume = 0.3;
        audio.currentTime = 0;
        audio.play().catch(() => console.log('Audio autoplay blocked'));
      } catch (e) {
        console.log('Audio unavailable');
      }
      
      // Continue with original action after audio
      if (event && event.target.tagName === 'A') {
        setTimeout(() => {
          window.location.href = event.target.href;
        }, 100);
      }
    }
    
    // ============================================
    // PERPETUAL CLOCK
    // ============================================
    
    function updatePerpetualClock() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('en-US', { 
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      
      const clockElement = document.getElementById('perpetual-clock');
      if (clockElement) {
        clockElement.textContent = timeString;
      }
    }
    
    // Update clock every second
    setInterval(updatePerpetualClock, 1000);
    updatePerpetualClock(); // Initial call
    
    // ============================================
    // THEME MANAGEMENT
    // ============================================
    
    function selectTheme(theme) {
      // Update theme selection UI
      document.querySelectorAll('.theme-option').forEach(option => {
        option.classList.remove('active');
      });
      document.querySelector(`[data-theme="${theme}"]`).classList.add('active');
      
      // Apply theme to body
      document.body.className = theme + '-theme';
      
      // Update settings
      window.timerSettings.theme = theme;
      
      // Apply theme to background manager if available
      if (window.StudyFlowSettings && window.StudyFlowSettings.backgroundManager) {
        window.StudyFlowSettings.backgroundManager.currentTheme = theme.toUpperCase();
        window.StudyFlowSettings.backgroundManager.loadInitialBackground();
      }
    }
    
    // ============================================
    // SETTINGS MODAL FUNCTIONS
    // ============================================
    
    function openSettings() {
      document.getElementById('settings-modal').style.display = 'flex';
      loadSettingsToUI();
    }
    
    function closeSettings() {
      document.getElementById('settings-modal').style.display = 'none';
    }
    
    function loadSettingsToUI() {
      document.getElementById('focus-time').value = window.timerSettings.focusTime;
      document.getElementById('short-break').value = window.timerSettings.shortBreak;
      document.getElementById('long-break').value = window.timerSettings.longBreak;
      document.getElementById('sessions-until-long').value = window.timerSettings.sessionsUntilLong;
      document.getElementById('slideshow-time').value = window.timerSettings.slideshowTime;
      
      // Update toggle switches
      const notificationToggle = document.getElementById('notification-audio-toggle');
      const clickToggle = document.getElementById('click-audio-toggle');
      
      if (window.timerSettings.notificationAudio) {
        notificationToggle.classList.add('active');
      } else {
        notificationToggle.classList.remove('active');
      }
      
      if (window.timerSettings.clickAudio) {
        clickToggle.classList.add('active');
      } else {
        clickToggle.classList.remove('active');
      }
    }
    
    function toggleAudioNotification() {
      window.timerSettings.notificationAudio = !window.timerSettings.notificationAudio;
      const toggle = document.getElementById('notification-audio-toggle');
      toggle.classList.toggle('active');
    }
    
    function toggleClickAudio() {
      window.timerSettings.clickAudio = !window.timerSettings.clickAudio;
      const toggle = document.getElementById('click-audio-toggle');
      toggle.classList.toggle('active');
    }
    
    function saveSettings() {
      // Get values from inputs
      window.timerSettings.focusTime = parseInt(document.getElementById('focus-time').value);
      window.timerSettings.shortBreak = parseInt(document.getElementById('short-break').value);
      window.timerSettings.longBreak = parseInt(document.getElementById('long-break').value);
      window.timerSettings.sessionsUntilLong = parseInt(document.getElementById('sessions-until-long').value);
      window.timerSettings.slideshowTime = parseInt(document.getElementById('slideshow-time').value);
      
      // Save to localStorage
      localStorage.setItem('studyflow-timer-settings', JSON.stringify(window.timerSettings));
      
      // Update timer if it exists
      if (window.pomodoroTimer) {
        window.pomodoroTimer.updateSettings(window.timerSettings);
      }
      
      // Update background slideshow timing
      if (window.StudyFlowSettings && window.StudyFlowSettings.backgroundManager) {
        window.StudyFlowSettings.backgroundManager.updateSlideshowTiming(window.timerSettings.slideshowTime * 1000);
      }
    }
    
    // ============================================
    // INITIALIZATION
    // ============================================
    
    document.addEventListener('DOMContentLoaded', function() {
      // Load saved settings
      try {
        const saved = localStorage.getItem('studyflow-timer-settings');
        if (saved) {
          window.timerSettings = { ...window.timerSettings, ...JSON.parse(saved) };
        }
      } catch (e) {
        console.log('Could not load saved settings');
      }
      
      // Apply saved theme
      selectTheme(window.timerSettings.theme);
      
      console.log('StudyFlow Timer initialized! 🍅');
    });
  </script>
</body>
</html>