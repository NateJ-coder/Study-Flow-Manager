<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StudyFlow Timer - Focus & Flow</title>
  
  <!-- Performance Preloads - LCP Optimized -->
  <link rel="preload" href="assets/images/autumn-day-8.png" as="image" fetchpriority="high">
  <link rel="preload" href="assets/images/summer-day-1.png" as="image" fetchpriority="low">
  <link rel="preload" href="assets/images/winter-day-1.png" as="image" fetchpriority="low">
  <link rel="preload" href="assets/audio/click.mp3" as="audio" fetchpriority="low">
  <link rel="preload" href="assets/audio/splash.mp3" as="audio" fetchpriority="low">
  
  <!-- Critical font preload -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- Critical CSS Inline for Performance -->
  <style>
    /* ============================================ */
    /* CRITICAL CSS - Performance Optimized */
    /* ============================================ */
    
    :root {
      --primary-bg: #0f1419;
      --text-color: #e7eaee;
      --amber-300: #fcd34d;
      --amber-500: #f59e0b;
      --amber-600: #d97706;
      
      /* Seasonal Color Variables - Default: Autumn */
      --season-primary: #CD853F;
      --season-secondary: #D2691E;
      --season-accent: #FF8C00;
      --season-text: #FFF8DC;
      --season-border: rgba(205, 133, 63, 0.3);
    }
    
    /* Summer Theme Colors */
    body.summer-theme {
      --season-primary: #228B22;
      --season-secondary: #32CD32;
      --season-accent: #00FF7F;
      --season-text: #F0FFF0;
      --season-border: rgba(34, 139, 34, 0.3);
    }
    
    /* Winter Theme Colors */
    body.winter-theme {
      --season-primary: #F0F8FF;
      --season-secondary: #E6E6FA;
      --season-accent: #B0E0E6;
      --season-text: #2F4F4F;
      --season-border: rgba(240, 248, 255, 0.3);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--primary-bg);
      color: var(--text-color);
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* Background container with slideshow capability - LCP Optimized */
    .bg-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-image: url('assets/images/autumn-day-8.png'); /* Default for LCP */
      filter: brightness(0.7) blur(1px);
      transition: background-image 1s ease-in-out, opacity 1s ease-in-out;
      z-index: 0;
      opacity: 1;
      will-change: background-image, opacity; /* GPU optimization */
      transform: translateZ(0); /* Force GPU layer */
    }
    
    /* Main container */
    .container {
      position: relative;
      z-index: 10;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(2px);
      background: rgba(0, 0, 0, 0.1);
      padding: 2rem;
    }
    
    /* Timer interface card */
    .timer-card {
      background: rgba(0, 0, 0, 0.2);
      padding: 3rem;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border: 2px solid var(--season-border);
      max-width: 500px;
      width: 90%;
      position: relative;
    }
    

    
    /* Timer display */
    .timer-display {
      font-size: clamp(3rem, 8vw, 5rem);
      font-weight: 300;
      font-variant-numeric: tabular-nums;
      line-height: 1;
      margin: 2rem 0;
      color: #ffffff !important;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      font-family: 'Courier New', monospace;
      letter-spacing: 0.1em;
    }
    
    /* Timer mode indicator */
    .timer-mode {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1rem;
      opacity: 0.9;
      color: var(--season-secondary);
    }
    
    /* Button controls container */
    .timer-controls {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin: 2rem 0;
      flex-wrap: wrap;
    }
    
    /* Wooden-style buttons */
    .wooden-btn {
      position: relative;
      padding: 14px 28px;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      
      /* Wooden appearance */
      background: linear-gradient(145deg, #8B4513, #654321);
      color: var(--season-text);
      border: 2px solid #A0522D;
      box-shadow: 
        inset 2px 2px 5px rgba(160, 82, 45, 0.3),
        inset -2px -2px 5px rgba(0, 0, 0, 0.3),
        0 4px 8px rgba(0, 0, 0, 0.2);
      
      /* Wood grain effect */
      background-image: 
        linear-gradient(90deg, transparent 50%, rgba(0, 0, 0, 0.1) 50%),
        linear-gradient(45deg, transparent 25%, rgba(139, 69, 19, 0.3) 25%, rgba(139, 69, 19, 0.3) 75%, transparent 75%);
      background-size: 4px 4px, 8px 8px;
    }
    
    .wooden-btn:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 
        inset 2px 2px 5px rgba(160, 82, 45, 0.4),
        inset -2px -2px 5px rgba(0, 0, 0, 0.4),
        0 6px 12px rgba(0, 0, 0, 0.3);
    }
    
    .wooden-btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 
        inset 2px 2px 8px rgba(0, 0, 0, 0.3),
        inset -2px -2px 3px rgba(160, 82, 45, 0.2),
        0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    /* StudyFlow Logo - Top Left */
    .studyflow-logo {
      position: fixed;
      top: 2rem;
      left: 2rem;
      z-index: 20;
      font-size: 1.5rem;
      font-weight: 700;
      color: #ffffff !important;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      letter-spacing: 0.05em;
    }

    /* Clock Container - Top Right */
    .clock-container {
      position: fixed;
      top: 2rem;
      right: 2rem;
      z-index: 20;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* Clock Icon */
    .clock-icon {
      width: 24px;
      height: 24px;
      cursor: pointer;
      opacity: 0.6;
      transition: all 0.2s ease;
      background: none;
      border: none;
      padding: 0;
    }
    
    .clock-icon:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    /* Perpetual Clock */
    .perpetual-clock {
      font-size: 1.5rem;
      font-weight: 600;
      color: #ffffff !important;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      font-family: 'Courier New', monospace;
      letter-spacing: 0.1em;
    }
    
    /* Calendar icon */
    .calendar-icon {
      position: absolute;
      top: 1rem;
      right: 4rem;
      width: 32px;
      height: 32px;
      cursor: pointer;
      opacity: 0.6;
      transition: all 0.2s ease;
      background: none;
      border: none;
      color: var(--season-secondary);
    }
    
    .calendar-icon:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    /* Settings icon */
    .settings-icon {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 32px;
      height: 32px;
      cursor: pointer;
      opacity: 0.6;
      transition: all 0.2s ease;
      background: none;
      border: none;
      color: var(--season-secondary);
    }
    
    .settings-icon:hover {
      opacity: 1;
      transform: rotate(45deg) scale(1.1);
    }
    
    /* Back button */
    .back-btn {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: var(--text-color);
      padding: 0.5rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }
    
    .back-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.05);
    }
    
    /* Settings modal */
    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(8px);
    }
    
    .settings-content {
      background: rgba(0, 0, 0, 0.9);
      padding: 2rem;
      border-radius: 20px;
      border: 2px solid var(--season-border);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .settings-group {
      margin-bottom: 2rem;
    }
    
    .settings-group h3 {
      color: var(--season-primary);
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }
    
    .settings-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      gap: 1rem;
    }
    
    .settings-input {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--season-border);
      border-radius: 8px;
      padding: 0.5rem;
      color: var(--text-color);
      width: 80px;
      text-align: center;
    }
    
    .theme-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .theme-option {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 1rem;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease;
    }
    
    .theme-option:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .theme-option.active {
      border-color: var(--season-secondary);
      background: var(--season-border);
    }
    
    /* Toggle switch */
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 24px;
      background: #ccc;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .toggle-switch.active {
      background: var(--season-secondary);
    }
    
    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }
    
    .toggle-switch.active::after {
      transform: translateX(26px);
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .timer-card {
        padding: 2rem;
        margin: 1rem;
      }
      
      .timer-controls {
        flex-direction: column;
        align-items: center;
      }
      
      .wooden-btn {
        width: 100%;
        max-width: 200px;
      }
      
      .studyflow-logo {
        top: 1rem;
        left: 1rem;
        font-size: 1.2rem;
      }

      .clock-container {
        top: 1rem;
        right: 1rem;
      }
      
      .perpetual-clock {
        font-size: 1.2rem;
      }
      
      .calendar-icon {
        right: 3rem;
        top: 0.5rem;
      }
    }
  </style>
</head>
<body class="autumn-theme">
  <!-- StudyFlow Logo - Top Left -->
  <div class="studyflow-logo">StudyFlow</div>

  <!-- Perpetual Clock with Icon -->
  <div class="clock-container">
    <button class="clock-icon" onclick="goToTimer(); playClickSound(event);" title="Timer">
      <svg width="24" height="24" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="30" cy="30" r="25" fill="#8B4513" stroke="#A0522D" stroke-width="2"/>
        <circle cx="30" cy="30" r="20" fill="none" stroke="#6F3B18" stroke-width="1"/>
        <path d="M30 15L30 30L40 35" stroke="#5A2D0C" stroke-width="2" stroke-linecap="round"/>
        <circle cx="30" cy="30" r="2" fill="#5A2D0C"/>
        <path d="M30 10V15" stroke="#6F3B18" stroke-width="1.5"/>
        <path d="M50 30H45" stroke="#6F3B18" stroke-width="1.5"/>
        <path d="M30 50V45" stroke="#6F3B18" stroke-width="1.5"/>
        <path d="M10 30H15" stroke="#6F3B18" stroke-width="1.5"/>
      </svg>
    </button>
    <div class="perpetual-clock" id="perpetual-clock">00:00:00</div>
  </div>
  
  <!-- Dynamic background container -->
  <div id="bg-container" class="bg-container" style="background-image: url('assets/images/autumn-day-8.png');"></div>
  
  <!-- Main application -->
  <div class="container">
    <div class="timer-card">
      <!-- Back button -->
      <a href="welcome.html" class="back-btn wooden-btn" onclick="playClickSound(event)">
        <span>←</span> Back
      </a>
      
      <!-- Calendar icon -->
      <button class="calendar-icon" onclick="goToCalendar(); playClickSound(event);" title="Calendar">
        <svg width="32" height="32" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="15" y="15" width="30" height="35" rx="5" fill="#A0522D"/>
          <rect x="18" y="10" width="24" height="8" rx="3" fill="#8B4513"/>
          <circle cx="23" cy="14" r="2" fill="#5A2D0C"/>
          <circle cx="37" cy="14" r="2" fill="#5A2D0C"/>
          <path d="M15 25H45" stroke="#6F3B18" stroke-width="1.5" stroke-linecap="round"/>
          <path d="M15 32H45" stroke="#6F3B18" stroke-width="1.5" stroke-linecap="round"/>
          <path d="M15 39H45" stroke="#6F3B18" stroke-width="1.5" stroke-linecap="round"/>
          <path d="M22 15V50" stroke="#6F3B18" stroke-width="1.5" stroke-linecap="round"/>
          <path d="M29 15V50" stroke="#6F3B18" stroke-width="1.5" stroke-linecap="round"/>
          <path d="M36 15V50" stroke="#6F3B18" stroke-width="1.5" stroke-linecap="round"/>
          <text x="25" y="47" font-family="Arial, sans-serif" font-size="14" fill="#E8D1B5" font-weight="bold">17</text>
          <path d="M17 20C19 18 25 18 27 20" stroke="#6F3B18" stroke-width="0.8" stroke-linecap="round"/>
          <path d="M38 30C40 28 40 32 38 34" stroke="#6F3B18" stroke-width="0.8" stroke-linecap="round"/>
        </svg>
      </button>

      <!-- Settings icon -->
      <button class="settings-icon" onclick="openSettings(); playClickSound(event);" title="Settings">
        <!-- Wooden Gear Icon (SVG) -->
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 128 128"
          width="32"
          height="32"
          role="img"
          aria-labelledby="title desc"
        >
          <title id="title">Settings</title>
          <desc id="desc">A wooden gear icon with subtle grain and bevel highlights.</desc>

          <!-- Easy theme variables -->
          <style>
            :root{
              --wood-base: #b98344;     /* main wood color */
              --wood-light: #e8bc7a;    /* highlight wood tone */
              --wood-dark: #7b5126;     /* shadow wood tone */
              --edge-stroke: rgba(0,0,0,0.35);
              --edge-stroke-inner: rgba(0,0,0,0.2);
              --specular: rgba(255,255,255,0.35);
              --shadow: rgba(0,0,0,0.2);
            }
          </style>

          <!-- Gradients for shading -->
          <defs>
            <!-- Radial light across the whole gear -->
            <radialGradient id="gRad" cx="35%" cy="30%" r="80%">
              <stop offset="0%"  stop-color="var(--wood-light)"/>
              <stop offset="55%" stop-color="var(--wood-base)"/>
              <stop offset="100%" stop-color="var(--wood-dark)"/>
            </radialGradient>

            <!-- Bevel for the teeth faces -->
            <linearGradient id="gBevel" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%"   stop-color="var(--wood-light)" />
              <stop offset="50%"  stop-color="var(--wood-base)" />
              <stop offset="100%" stop-color="var(--wood-dark)" />
            </linearGradient>

            <!-- Subtle specular sweep -->
            <linearGradient id="gSpec" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%"   stop-color="transparent"/>
              <stop offset="45%"  stop-color="transparent"/>
              <stop offset="60%"  stop-color="var(--specular)"/>
              <stop offset="100%" stop-color="transparent"/>
            </linearGradient>

            <!-- Wood grain filter (lightweight) -->
            <filter id="fGrain" x="-10%" y="-10%" width="120%" height="120%">
              <!-- Create organic streaks -->
              <feTurbulence type="fractalNoise" baseFrequency="0.015 0.25" numOctaves="2" seed="11" result="noise"/>
              <!-- Stretch streaks horizontally (wood-like) -->
              <feComponentTransfer in="noise" result="noise2">
                <feFuncR type="linear" slope="1.0" intercept="0"/>
                <feFuncG type="linear" slope="1.0" intercept="0"/>
                <feFuncB type="linear" slope="1.0" intercept="0"/>
                <feFuncA type="gamma" amplitude="0.7" exponent="1.2" offset="0"/>
              </feComponentTransfer>
              <!-- Slightly displace the underlying fill to mimic grain undulation -->
              <feDisplacementMap in="SourceGraphic" in2="noise2" scale="1.2" xChannelSelector="R" yChannelSelector="G"/>
            </filter>

            <!-- Inner shadow for the center hole -->
            <filter id="fInnerShadow" x="-50%" y="-50%" width="200%" height="200%">
              <feOffset dx="0" dy="0"/>
              <feGaussianBlur stdDeviation="1.2" result="b"/>
              <feComposite in="b" in2="SourceAlpha" operator="out" result="cut"/>
              <feColorMatrix in="cut" type="matrix"
                values="0 0 0 0 0
                        0 0 0 0 0
                        0 0 0 0 0
                        0 0 0 0.6 0" />
              <feBlend in="SourceGraphic" in2="cut" mode="normal"/>
            </filter>

            <!-- ClipPath to confine grain to the gear silhouette -->
            <clipPath id="clipGear">
              <path id="gearShape"
                    d="M64 16
                       a48 48 0 0 1 10.6 1.2l3.2-7.5 12.4 5.2-3.1 7.5a48.8 48.8 0 0 1 8.9 6.1l6.5-4.7 8.9 10.7-6.5 4.7a48.6 48.6 0 0 1 4.9 9.3l7.8-1.3 2.7 13.3-7.8 1.3a48.6 48.6 0 0 1 0 10.8l7.8 1.3-2.7 13.3-7.8-1.3a48.6 48.6 0 0 1-4.9 9.3l6.5 4.7-8.9 10.7-6.5-4.7a48.8 48.8 0 0 1-8.9 6.1l3.1 7.5-12.4 5.2-3.2-7.5A48 48 0 0 1 64 112a48 48 0 0 1-10.6-1.2l-3.2 7.5-12.4-5.2 3.1-7.5a48.8 48.8 0 0 1-8.9-6.1l-6.5 4.7-8.9-10.7 6.5-4.7a48.6 48.6 0 0 1-4.9-9.3l-7.8 1.3-2.7-13.3 7.8-1.3a48.6 48.6 0 0 1 0-10.8l-7.8-1.3 2.7-13.3 7.8 1.3a48.6 48.6 0 0 1 4.9-9.3l-6.5-4.7 8.9-10.7 6.5 4.7a48.8 48.8 0 0 1 8.9-6.1l-3.1-7.5 12.4-5.2 3.2 7.5A48 48 0 0 1 64 16Z
                       M64 44
                       a20 20 0 1 0 0 40a20 20 0 1 0 0-40Z" />
            </clipPath>
          </defs>

          <!-- Base gear body -->
          <g>
            <!-- Main silhouette with radial wood shading -->
            <use href="#gearShape" fill="url(#gRad)" stroke="var(--edge-stroke)" stroke-width="2"/>

            <!-- Teeth (subtle bevel overlay). 12 short rectangles rotated around -->
            <g transform="translate(64,64)">
              <!-- one tooth template -->
              <g id="tooth">
                <rect x="-6" y="-54" width="12" height="12" rx="2" ry="2" fill="url(#gBevel)" stroke="var(--edge-stroke)" stroke-width="1"/>
              </g>
              <!-- clone & rotate -->
              <use href="#tooth" transform="rotate(30)"/>
              <use href="#tooth" transform="rotate(60)"/>
              <use href="#tooth" transform="rotate(90)"/>
              <use href="#tooth" transform="rotate(120)"/>
              <use href="#tooth" transform="rotate(150)"/>
              <use href="#tooth" transform="rotate(180)"/>
              <use href="#tooth" transform="rotate(210)"/>
              <use href="#tooth" transform="rotate(240)"/>
              <use href="#tooth" transform="rotate(270)"/>
              <use href="#tooth" transform="rotate(300)"/>
              <use href="#tooth" transform="rotate(330)"/>
              <!-- original at 0deg is inherent -->
            </g>

            <!-- Wood grain confined to gear -->
            <g clip-path="url(#clipGear)" filter="url(#fGrain)">
              <rect x="0" y="0" width="128" height="128" fill="transparent"/>
            </g>

            <!-- Specular highlight sweep -->
            <use href="#gearShape" fill="url(#gSpec)" />

            <!-- Inner hole rim -->
            <circle cx="64" cy="64" r="20" fill="none" stroke="var(--edge-stroke-inner)" stroke-width="2" filter="url(#fInnerShadow)"/>

            <!-- Tiny center dot for polish -->
            <circle cx="64" cy="64" r="1.6" fill="var(--specular)" opacity="0.6"/>
          </g>
        </svg>
      </button>
      
      <!-- Timer mode -->
      <div class="timer-mode" id="timer-mode">Focus Session</div>
      
      <!-- Timer display -->
      <div class="timer-display" id="timer-display">25:00</div>
      
      <!-- Timer controls -->
      <div class="timer-controls">
        <button class="wooden-btn" id="startButton" onclick="toggleTimer(); playClickSound(event);">
          <span id="start-icon">▶</span>
          <span id="start-text">Start</span>
        </button>
        
        <button class="wooden-btn" id="resetButton" onclick="resetTimer(); playClickSound(event);">
          <span>↺</span>
          Reset
        </button>
      </div>
      
      <!-- Session info -->
      <div style="opacity: 0.7; font-size: 0.9rem; margin-top: 1rem;">
        <p>Session <span id="session-count">1</span> of <span id="total-sessions">4</span> • <span id="session-type">Focus</span></p>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="settings-modal" id="settings-modal">
    <div class="settings-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h2 style="color: var(--season-primary); margin: 0;">Timer Settings</h2>
        <button onclick="closeSettings(); playClickSound(event);" style="background: none; border: none; color: var(--text-color); font-size: 1.5rem; cursor: pointer;">×</button>
      </div>
      
      <!-- Pomodoro Settings -->
      <div class="settings-group">
        <h3>🍅 Pomodoro Settings</h3>
        <div class="settings-row">
          <label>Focus Time (minutes):</label>
          <input type="number" id="focus-time" class="settings-input" value="25" min="1" max="120">
        </div>
        <div class="settings-row">
          <label>Short Break (minutes):</label>
          <input type="number" id="short-break" class="settings-input" value="5" min="1" max="30">
        </div>
        <div class="settings-row">
          <label>Long Break (minutes):</label>
          <input type="number" id="long-break" class="settings-input" value="15" min="1" max="60">
        </div>
        <div class="settings-row">
          <label>Sessions until Long Break:</label>
          <input type="number" id="sessions-until-long" class="settings-input" value="4" min="2" max="8">
        </div>
      </div>
      
      <!-- Audio Settings -->
      <div class="settings-group">
        <h3>🔊 Audio Settings</h3>
        <div class="settings-row">
          <label>Timer Completion Sound:</label>
          <div class="toggle-switch" id="notification-audio-toggle" onclick="toggleAudioNotification(); playClickSound(event);">
          </div>
        </div>
        <div class="settings-row">
          <label>Button Click Sounds:</label>
          <div class="toggle-switch active" id="click-audio-toggle" onclick="toggleClickAudio(); playClickSound(event);">
          </div>
        </div>
      </div>
      
      <!-- Background Settings -->
      <div class="settings-group">
        <h3>🖼️ Background Settings</h3>
        <div class="settings-row">
          <label>Slideshow Transition (seconds):</label>
          <input type="number" id="slideshow-time" class="settings-input" value="20" min="20" max="120" step="1"
                 title="Minimum 20 seconds required for proper image preloading" 
                 onchange="if(this.value < 20) { this.value = 20; this.style.border = '2px solid #ff6b6b'; setTimeout(() => this.style.border = '', 2000); }"
                 oninput="if(this.value && this.value < 20) this.style.color = '#ff6b6b'; else this.style.color = '';">
          <small style="color: var(--season-accent); font-size: 0.8rem; margin-left: 0.5rem; font-weight: bold;">Min: 20s</small>
        </div>
      </div>
      
      <!-- Theme Settings -->
      <div class="settings-group">
        <h3>🎨 Theme</h3>
        <div class="theme-selector">
          <div class="theme-option active" data-theme="autumn" onclick="selectTheme('autumn'); playClickSound(event);">
            <div>🍂</div>
            <div>Autumn</div>
          </div>
          <div class="theme-option" data-theme="summer" onclick="selectTheme('summer'); playClickSound(event);">
            <div>🌿</div>
            <div>Summer</div>
          </div>
          <div class="theme-option" data-theme="winter" onclick="selectTheme('winter'); playClickSound(event);">
            <div>❄️</div>
            <div>Winter</div>
          </div>
        </div>
      </div>
      
      <!-- Save button -->
      <div style="text-align: center; margin-top: 2rem;">
        <button class="wooden-btn" onclick="saveSettings(); closeSettings(); playClickSound(event);">
          Save Settings
        </button>
        <br><br>
        <button class="wooden-btn" onclick="testBackgroundRotation(); playClickSound(event);" style="background: linear-gradient(145deg, #CD853F, #8B4513);">
          🔄 Test Background Rotation
        </button>
      </div>
    </div>
  </div>

  <!-- Performance-Optimized Scripts -->
  <script src="assets/js/core.js" defer></script>
  <script src="assets/js/settings.js" defer></script>
  <script src="assets/js/timer.js" defer></script>
  
  <script>
    // ============================================
    // GLOBAL SETTINGS & STATE
    // ============================================
    
    window.timerSettings = {
      focusTime: 25,
      shortBreak: 5,
      longBreak: 15,
      sessionsUntilLong: 4,
      slideshowTime: 20, // 20 seconds minimum - enforced
      theme: 'autumn',
      notificationAudio: true,
      clickAudio: true
    };
    
    // ============================================
    // AUDIO & UI INTERACTIONS
    // ============================================
    
    function playClickSound(event) {
      if (!window.timerSettings.clickAudio) return;
      
      if (event) event.preventDefault();
      
      try {
        const audio = new Audio('assets/audio/click.mp3');
        audio.volume = 0.3;
        audio.currentTime = 0;
        audio.play().catch(() => console.log('Audio autoplay blocked'));
      } catch (e) {
        console.log('Audio unavailable');
      }
      
      // Continue with original action after audio
      if (event && event.target.tagName === 'A') {
        setTimeout(() => {
          window.location.href = event.target.href;
        }, 100);
      }
    }
    
    // ============================================
    // PERPETUAL CLOCK
    // ============================================
    
    function updatePerpetualClock() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('en-US', { 
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      
      const clockElement = document.getElementById('perpetual-clock');
      if (clockElement) {
        clockElement.textContent = timeString;
      }
    }
    
    // Update clock every second
    setInterval(updatePerpetualClock, 1000);
    updatePerpetualClock(); // Initial call
    
    // ============================================
    // THEME MANAGEMENT
    // ============================================
    
    function selectTheme(theme) {
      // Update theme selection UI
      document.querySelectorAll('.theme-option').forEach(option => {
        option.classList.remove('active');
      });
      document.querySelector(`[data-theme="${theme}"]`).classList.add('active');
      
      // Apply theme to body
      document.body.className = theme + '-theme';
      
      // Update settings
      window.timerSettings.theme = theme;
      
      // Apply theme to background manager if available
      if (window.backgroundManager) {
        window.backgroundManager.currentTheme = theme.toUpperCase();
        window.backgroundManager.loadInitialBackground();
      }
    }
    
    // ============================================
    // NAVIGATION FUNCTIONS
    // ============================================
    
    function goToTimer() {
      // Already on timer page, could add visual feedback or refresh
      console.log('Already on timer page');
    }
    
    function goToCalendar() {
      playClickSound();
      window.location.href = 'calendar.html';
    }
    
    // ============================================
    // TEST FUNCTIONS
    // ============================================
    
    function testBackgroundRotation() {
      console.log('🧪 Testing background rotation...');
      if (window.backgroundManager) {
        console.log('✅ BackgroundManager found, triggering rotation');
        console.log('🧪 Current theme:', window.backgroundManager.currentTheme);
        console.log('🧪 Current index:', window.backgroundManager.currentIndex);
        console.log('🧪 Available images:', window.backgroundManager.getThemeImages().length);
        console.log('🧪 Theme data keys:', Object.keys(window.backgroundManager.themeData));
        
        // Force rotation
        window.backgroundManager.rotateBackground();
      } else {
        console.error('❌ BackgroundManager not found');
        console.log('Available window objects:', Object.keys(window).filter(key => key.includes('background') || key.includes('Background')));
        
        // Try to initialize manually
        if (typeof BackgroundManager !== 'undefined') {
          console.log('🧪 Attempting manual BackgroundManager initialization...');
          window.backgroundManager = new BackgroundManager();
          if (window.timerSettings && window.timerSettings.theme) {
            window.backgroundManager.currentTheme = window.timerSettings.theme.toUpperCase();
          }
          window.backgroundManager.init();
          console.log('🧪 Manual initialization complete, trying rotation...');
          window.backgroundManager.rotateBackground();
        }
      }
    }
    
    // Test function to manually set background
    function testSetBackground(imagePath) {
      console.log(`🧪 Testing direct background set to: ${imagePath}`);
      const bgContainer = document.getElementById('bg-container');
      if (bgContainer) {
        bgContainer.style.backgroundImage = `url('${imagePath}')`;
        console.log('✅ Background set directly');
      } else {
        console.error('❌ bg-container not found');
      }
    }
    
    // Add keyboard shortcut for testing
    document.addEventListener('keydown', function(e) {
      if (e.key === 'r' && e.ctrlKey) {
        e.preventDefault();
        testBackgroundRotation();
      } else if (e.key === 't' && e.ctrlKey) {
        e.preventDefault();
        testSetBackground('assets/images/summer-day-1.png');
      } else if (e.key === '1') {
        testSetBackground('assets/images/autumn-day-1.png');
      } else if (e.key === '2') {
        testSetBackground('assets/images/autumn-day-2.png');
      } else if (e.key === '3') {
        testSetBackground('assets/images/summer-day-1.png');
      } else if (e.key === '4') {
        testSetBackground('assets/images/winter-day-1.png');
      }
    });
    
    // Note: Simple test slideshow removed - using proper 20-second BackgroundManager system
    
    // ============================================
    // SETTINGS MODAL FUNCTIONS
    // ============================================
    
    function openSettings() {
      document.getElementById('settings-modal').style.display = 'flex';
      loadSettingsToUI();
    }
    
    function closeSettings() {
      document.getElementById('settings-modal').style.display = 'none';
    }
    
    function loadSettingsToUI() {
      document.getElementById('focus-time').value = window.timerSettings.focusTime;
      document.getElementById('short-break').value = window.timerSettings.shortBreak;
      document.getElementById('long-break').value = window.timerSettings.longBreak;
      document.getElementById('sessions-until-long').value = window.timerSettings.sessionsUntilLong;
      document.getElementById('slideshow-time').value = window.timerSettings.slideshowTime;
      
      // Update toggle switches
      const notificationToggle = document.getElementById('notification-audio-toggle');
      const clickToggle = document.getElementById('click-audio-toggle');
      
      if (window.timerSettings.notificationAudio) {
        notificationToggle.classList.add('active');
      } else {
        notificationToggle.classList.remove('active');
      }
      
      if (window.timerSettings.clickAudio) {
        clickToggle.classList.add('active');
      } else {
        clickToggle.classList.remove('active');
      }
    }
    
    function toggleAudioNotification() {
      window.timerSettings.notificationAudio = !window.timerSettings.notificationAudio;
      const toggle = document.getElementById('notification-audio-toggle');
      toggle.classList.toggle('active');
    }
    
    function toggleClickAudio() {
      window.timerSettings.clickAudio = !window.timerSettings.clickAudio;
      const toggle = document.getElementById('click-audio-toggle');
      toggle.classList.toggle('active');
    }
    
    function saveSettings() {
      // Get values from inputs
      window.timerSettings.focusTime = parseInt(document.getElementById('focus-time').value);
      window.timerSettings.shortBreak = parseInt(document.getElementById('short-break').value);
      window.timerSettings.longBreak = parseInt(document.getElementById('long-break').value);
      window.timerSettings.sessionsUntilLong = parseInt(document.getElementById('sessions-until-long').value);
      
      // Enforce strict minimum slideshow timing - cannot be bypassed
      const requestedTime = parseInt(document.getElementById('slideshow-time').value);
      const MIN_SLIDESHOW_TIME = 20; // Absolute minimum for proper preloading
      const safeTime = Math.max(requestedTime, MIN_SLIDESHOW_TIME);
      
      if (requestedTime < MIN_SLIDESHOW_TIME) {
        // Force the safe value
        window.timerSettings.slideshowTime = MIN_SLIDESHOW_TIME;
        document.getElementById('slideshow-time').value = MIN_SLIDESHOW_TIME;
        
        // Show strong visual feedback
        const slideshowInput = document.getElementById('slideshow-time');
        slideshowInput.style.border = '3px solid #ff6b6b';
        slideshowInput.style.backgroundColor = 'rgba(255, 107, 107, 0.1)';
        
        setTimeout(() => {
          slideshowInput.style.border = '2px solid var(--season-accent)';
          slideshowInput.style.backgroundColor = '';
          setTimeout(() => {
            slideshowInput.style.border = '';
          }, 1000);
        }, 2000);
        
        console.warn(`🚫 BLOCKED: Slideshow time ${requestedTime}s rejected. Minimum ${MIN_SLIDESHOW_TIME}s enforced.`);
      } else {
        window.timerSettings.slideshowTime = safeTime;
        console.log(`✅ Slideshow time set to ${safeTime}s`);
      }
      
      // Save to localStorage
      localStorage.setItem('studyflow-timer-settings', JSON.stringify(window.timerSettings));
      
      // Update timer if it exists
      if (window.pomodoroTimer) {
        window.pomodoroTimer.updateSettings(window.timerSettings);
      }
      
      // Update background slideshow timing
      if (window.backgroundManager) {
        const actualInterval = window.backgroundManager.updateSlideshowTiming(window.timerSettings.slideshowTime * 1000);
        // Update the setting to reflect actual interval used
        window.timerSettings.slideshowTime = actualInterval / 1000;
      }
    }
    
    // ============================================
    // INITIALIZATION
    // ============================================
    
    document.addEventListener('DOMContentLoaded', function() {
      // Load saved settings
      try {
        const saved = localStorage.getItem('studyflow-timer-settings');
        if (saved) {
          window.timerSettings = { ...window.timerSettings, ...JSON.parse(saved) };
        }
      } catch (e) {
        console.log('Could not load saved settings');
      }
      
      // Initialize Background Manager for seasonal images
      console.log('🚀 Checking BackgroundManager availability...');
      console.log('BackgroundManager available:', typeof BackgroundManager !== 'undefined');
      console.log('SETTINGS_CONFIG available:', typeof SETTINGS_CONFIG !== 'undefined');
      console.log('THEME_DATA available:', typeof THEME_DATA !== 'undefined');
      
      if (typeof BackgroundManager !== 'undefined' && typeof SETTINGS_CONFIG !== 'undefined') {
        console.log('✅ Initializing BackgroundManager...');
        window.backgroundManager = new BackgroundManager();
        window.backgroundManager.currentTheme = window.timerSettings.theme.toUpperCase();
        
        console.log('🎨 Theme set to:', window.backgroundManager.currentTheme);
        
        // Enforce minimum slideshow timing before initialization
        const requestedInterval = window.timerSettings.slideshowTime * 1000;
        const minInterval = 20000; // 20 seconds minimum
        const safeInterval = Math.max(requestedInterval, minInterval);
        
        if (requestedInterval < minInterval) {
          console.warn(`🚫 Settings slideshow time ${requestedInterval/1000}s below minimum. Using ${minInterval/1000}s.`);
          window.timerSettings.slideshowTime = 20;
        }
        
        SETTINGS_CONFIG.themes.backgroundRotation.interval = safeInterval;
        console.log(`🔄 Slideshow interval set to ${safeInterval/1000}s (enforced minimum: 20s)`);
        
        // Store the safe interval back to settings
        localStorage.setItem('studyflow-timer-settings', JSON.stringify(window.timerSettings));
        
        console.log('🚀 Starting BackgroundManager initialization...');
        window.backgroundManager.init();
        console.log('✅ BackgroundManager initialized');
      } else {
        console.error('❌ BackgroundManager or SETTINGS_CONFIG not available');
        console.log('Available globals:', Object.keys(window).filter(key => key.includes('Background') || key.includes('THEME') || key.includes('SETTINGS')));
      }
      
      // Apply saved theme
      selectTheme(window.timerSettings.theme);
      
      console.log('StudyFlow Timer initialized! 🍅');
    });
  </script>
</body>
</html>