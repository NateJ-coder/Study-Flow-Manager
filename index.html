<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StudyFlow</title>

  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext y='50' x='8' font-size='48'%3E%F0%9F%8F%93%3C/text%3E%3C/svg%3E">

  <!-- Tailwind + Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- preload links removed: using JS preloader instead -->

  <!-- Base theme vars -->
  <style>
    :root{
      --primary:#4A3DF2;           /* main accent (overridden by season) */
      --x-color:#ffffff;           /* calendar X color (user setting)   */
      --sand:#f2d16b;              /* hourglass sand (season-linked)    */
      --scrim:0.28;                /* bg dim overlay                    */
      --ui-primary-color:var(--primary);
      --ui-sand-color:var(--sand);
    }
    .glass{background:rgba(255,255,255,0.18); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,.18)}
    .view{animation:fade .25s} @keyframes fade{from{opacity:0}to{opacity:1}}
  </style>
  <style>
  /* Calendar cross animation (drawn by pen) */
  @keyframes x1{to{stroke-dashoffset:0}}
  @keyframes x2{to{stroke-dashoffset:0}}
  .cross{stroke:var(--x-color); stroke-width:8; stroke-linecap:round; fill:none;
         stroke-dasharray:120; stroke-dashoffset:120; filter: drop-shadow(0 2px 6px rgba(0,0,0,.35))}
  /* when a day is crossed, animate line A then B */
  .day-cell.cross-anim .cross.a{animation:x1 .35s ease-out forwards}
  .day-cell.cross-anim .cross.b{animation:x2 .35s .15s ease-out forwards}
  </style>
  <style>
    /* Inactivity collapse */
    #minimalTimer{display:none}
    /* Rain “shock” */
    @keyframes shake{0%,100%{transform:translate(0)}10%,30%,50%,70%,90%{transform:translate(-3px)}20%,40%,60%,80%{transform:translate(3px)}}
    .shocked{animation:shake .45s}
    /* Ripple pulse on click (used in rain mode) */
    .ripple{position:relative;overflow:hidden}
    .ripple::before{
      content:""; position:absolute; opacity:0; pointer-events:none;
      border:2px solid #fff; border-radius:9999px; transform:scale(0);
      left:var(--rx); top:var(--ry); width:var(--rsize); height:var(--rsize);
      margin-left:calc(var(--rsize) * -0.5); margin-top:calc(var(--rsize) * -0.5);
    }
    .ripple.pulse::before{opacity:.7;animation:rip .6s ease-out}
    @keyframes rip{to{transform:scale(1);opacity:0}}
    /* Auto-hide side nav */
    #sideNav{transition:opacity .2s} #sideNav.hiddenish{opacity:0}
    /* Night tint */
    .night { filter: brightness(.9) contrast(1.05) }
    .rain  { filter: brightness(.8) }
    /* Wet effect when raining */
    .rain .glass {
      filter: saturate(1.1) brightness(0.95) drop-shadow(0 10px 16px rgba(0,0,0,.5));
      border-color: rgba(255,255,255,.35);

      /* droplet overlay */
      background-image: url("assets/images/rain-drops-overlay.png");
      background-size: cover;
      background-repeat: no-repeat;
      background-blend-mode: overlay;
      
      animation: drip 20s linear infinite;
    }
    @keyframes drip {
      0%   { background-position: center top; }
      100% { background-position: center bottom; }
    }
    @keyframes flipY { 0%{transform:rotateY(0)} 100%{transform:rotateY(180deg)} }
    #hourglass.flip { animation: flipY .6s ease; transform-origin:50% 50%; }
    /* Remove border on the main timer panel, add a softer drop shadow */
    #timerView.glass { border: 0 !important; box-shadow: 0 24px 80px rgba(0,0,0,.35); }

    /* dark form controls for Settings */
    #settings select,
    #settings input[type="number"],
    #settings input[type="time"],
    #settings input[type="text"],
    #settings input[type="color"]{
      background: rgba(0,0,0,.65) !important;
      color: #fff !important;
      border: 1px solid rgba(255,255,255,.18);
    }
    #settings select option{
      background:#111; color:#fff;
    }
    #settings label { color: #fff; }
  </style>

  <!-- Firebase (paste your config below in the JS where marked) -->
  <style>
  #toastHost{position:fixed;right:16px;bottom:16px;z-index:9999;display:grid;gap:10px}
  .toast{background:#111827dd;color:#fff;padding:.8rem 1rem;border-radius:10px;box-shadow:0 10px 30px #0006;opacity:0;transform:translateY(10px);animation:toastIn .18s forwards}
  @keyframes toastIn{to{opacity:1;transform:none}}
  </style>
  <style>
  /* Removed old .calendar .day.crossed::after CSS */
  </style>
  <style>
  /* Calendar X SVG overlay (updated) */
  .day-cell{ position:relative }
  .day-x{ position:absolute; inset:0; pointer-events:none; opacity:0; transition:opacity .15s }
  .day-cell.crossed .day-x{ opacity:1 }
  .day-x line{ stroke: var(--x-color, #ef4444); stroke-width:8; stroke-linecap:round; filter: drop-shadow(0 2px 6px rgba(0,0,0,.35)) }
  @keyframes xpop{0%{transform:scale(.9);opacity:.2}100%{transform:none;opacity:1}}
  .day-cell.cross-anim .day-x{ animation:xpop .18s ease-out }
  </style>
  <style>
  /* Cross-fade background layers */
  .bg-layer{
    position: fixed; inset: 0; z-index: -1;
    background-position: center; background-size: cover; background-repeat: no-repeat;
    opacity: 0; transition: opacity .45s ease; will-change: opacity;
  }
  .bg-layer.show{ opacity: 1; }
  </style>
</head>
<body class="min-h-screen bg-gray-900 text-gray-50 overflow-x-hidden relative">
  <div id="toastHost" aria-live="polite"></div>

  <!-- Background layers & scrim (two layers for cross-fade) -->
  <div id="bgA" class="bg-layer"></div>
  <div id="bgB" class="bg-layer"></div>
  <div id="scrim" class="fixed inset-0 bg-black" style="opacity:var(--scrim)"></div>

  <!-- Particles canvas (leaves/snow/fireflies/rain) -->
  <canvas id="fx" class="fixed inset-0 pointer-events-none z-10"></canvas>

  <!-- Header -->
  <header class="relative z-20 flex items-center justify-between p-4 md:p-6">
    <h1 class="text-xl font-bold tracking-wide">StudyFlow</h1>
    <div class="relative">
      <button id="clockBtn" class="flex items-center gap-1 text-lg opacity-80">
        <span id="clock">--:--</span>
        <i data-lucide="chevron-down" class="w-5 h-5"></i>
      </button>

      <!-- Reminders panel -->
      <div id="remPanel" class="absolute right-0 mt-2 w-[min(92vw,360px)] z-40 glass rounded-xl p-3 hidden">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Reminders</h3>
          <button id="remNew" class="px-3 py-1 rounded-full bg-[color:var(--primary)] text-white text-sm">New</button>
        </div>
        <div id="remList" class="space-y-2 text-sm"></div>
      </div>
    </div>
  </header>

  <!-- Side nav (auto-hides) -->
  <nav id="sideNav" class="z-30 fixed top-1/2 -translate-y-1/2 right-4 flex flex-col gap-2">
    <button id="goTimer"   class="glass p-2 rounded-full" title="Timer"><i data-lucide="hourglass"></i></button>
    <button id="goCalendar" class="glass p-2 rounded-full" title="Calendar"><i data-lucide="calendar"></i></button>
    <button id="goSettings" class="glass p-2 rounded-full" title="Settings"><i data-lucide="settings"></i></button>
  </nav>

  <!-- Main Views -->
  <main class="relative z-20 p-4 md:p-8 grid place-items-center">
    <!-- TIMER -->
    <section id="timerView" class="view w-full max-w-xl glass rounded-2xl p-6 space-y-6">
      <div class="flex items-center justify-between">
        <h2 id="modeLabel" class="text-2xl font-semibold text-[color:var(--primary)]">Work</h2>
        <p id="sessionLabel" class="opacity-70">Session 1 of 4</p>
      </div>

      <!-- Hourglass -->
      <div class="mx-auto" style="width:120px;height:200px">
        <svg id="hourglass" viewBox="0 0 120 200" class="w-full h-full block">
          <!-- Frame -->
          <defs>
            <linearGradient id="frame" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="var(--ui-primary-color)"/>
              <stop offset="1" stop-color="#99bbff"/>
            </linearGradient>
            <linearGradient id="sand" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0" stop-color="var(--ui-sand-color)"/>
              <stop offset="1" stop-color="#e5c066"/>
            </linearGradient>
            <clipPath id="topGlass"><path d="M20 20 H100 V80 C78 92 70 96 60 108 C50 96 42 92 20 80 Z"/></clipPath>
            <clipPath id="botGlass"><path d="M20 180 V120 C42 108 50 104 60 92 C70 104 78 108 100 120 V180 Z"/></clipPath>
          </defs>
          <path d="M20 20 H100 V80 C78 92 70 96 60 108 C50 96 42 92 20 80 Z" fill="none" stroke="url(#frame)" stroke-width="4" />
          <path d="M20 180 V120 C42 108 50 104 60 92 C70 104 78 108 100 120 V180 Z" fill="none" stroke="url(#frame)" stroke-width="4" />
          <!-- Sand (top/bottom) -->
          <rect id="sandTop" x="22" y="22" width="76" height="56" fill="url(#sand)" clip-path="url(#topGlass)"/>
          <rect id="sandBot" x="22" y="124" width="76" height="56" fill="url(#sand)" clip-path="url(#botGlass)"/>
          <!-- Stream -->
          <line id="sandStream" x1="60" y1="108" x2="60" y2="120" stroke="url(#sand)" stroke-width="2" stroke-linecap="round" style="opacity:.9;display:none"/>
        </svg>
      </div>

      <!-- Countdown (full) -->
      <div id="fullTimer" class="text-center">
        <div id="countdown" class="text-7xl font-mono font-extrabold">25:00</div>
        <div class="mt-6 flex items-center justify-center gap-3">
          <button id="btnStart" class="px-5 py-2 rounded-full bg-[color:var(--primary)] text-white font-semibold">Start</button>
          <button id="btnPause" class="px-5 py-2 rounded-full glass" hidden>Pause</button>
          <button id="btnReset" class="p-2 rounded-full glass" title="Reset"><i data-lucide="rotate-ccw"></i></button>
          <button id="btnReminder" class="text-sm opacity-80">Set Reminder</button>
        </div>
      </div>

      <!-- Countdown (minimal, appears after 2 min inactivity) -->
      <div id="minimalTimer" class="text-center">
        <div id="minMode" class="opacity-80">Work</div>
        <div id="minTime" class="text-5xl font-mono font-extrabold">25:00</div>
        <div id="minSess" class="opacity-60 text-sm mt-2">1 of 4</div>
      </div>

  <audio id="sfx-splash"   preload="auto"></audio>
  <audio id="sfx-drawing"  preload="auto"></audio>
  <audio id="sfx-rain"     preload="auto" loop></audio>

      <!-- Reminder Modal -->
      <div id="remModal" class="hidden fixed inset-0 bg-black/60 z-40 grid place-items-center">
        <div class="glass p-4 rounded-xl w-[min(92vw,420px)]">
          <h3 class="font-semibold mb-3">Set a Reminder</h3>
          <div class="space-y-3">
            <label class="block text-sm">
              Time
              <input id="remTime" type="time" class="w-full mt-1 p-2 bg-white/10 rounded-lg">
            </label>
            <label class="block text-sm">
              Message
              <input id="remText" type="text" placeholder="Stretch / Switch tasks / etc." class="w-full mt-1 p-2 bg-white/10 rounded-lg">
            </label>
          </div>
          <div class="mt-4 flex justify-end gap-2">
            <button id="remCancel" class="glass px-4 py-2 rounded-lg">Cancel</button>
            <button id="remSaveBtn" class="px-5 py-2 rounded-full bg-[color:var(--primary)] text-white">Save</button>
          </div>
        </div>
      </div>
    </section>

    <!-- CALENDAR -->
    <section id="calendarView" class="view w-full max-w-3xl glass rounded-2xl p-6 hidden">
      <div class="flex items-center justify-between mb-4">
        <button id="prevMonth" class="glass p-2 rounded-full" title="Prev"><i data-lucide="chevron-left"></i></button>
        <h2 id="calTitle" class="text-xl font-semibold">—</h2>
        <button id="nextMonth" class="glass p-2 rounded-full" title="Next"><i data-lucide="chevron-right"></i></button>
      </div>
      <div id="calGrid" class="grid grid-cols-7 gap-2"></div>
      <!-- tiny modal placeholder -->
      <div id="taskModal" class="hidden fixed inset-0 bg-black/60 grid place-items-center z-40">
        <div class="glass p-4 rounded-xl w-[min(92vw,480px)]">
          <h3 class="font-semibold mb-2">Tasks for <span id="taskDate"></span></h3>
          <div id="taskBody" class="space-y-2 text-sm"></div>
          <div class="mt-4 text-right"><button id="taskClose" class="glass px-4 py-2 rounded-lg">Close</button></div>
        </div>
      </div>
    </section>

  <!-- SETTINGS -->
  <section id="settingsView" class="view w-full max-w-xl glass rounded-2xl p-6 hidden relative max-h-[75vh] overflow-auto">
      <div id="rainBlocker" class="absolute inset-0 hidden cursor-not-allowed z-10" title="It's raining! Don't touch the electronics! You will get shocked!"></div>
      <h2 class="text-2xl font-semibold mb-4">Settings</h2>
      <form id="settings" class="space-y-5">
        <fieldset class="border-t border-white/20 pt-4">
          <legend class="text-[color:var(--primary)] font-medium">Timer</legend>
          <div class="grid grid-cols-2 gap-3">
            <label>Work (min) <input id="setWork" type="number" min="1" class="w-full mt-1 p-2 bg-white/10 rounded-lg"></label>
            <label>Short (min) <input id="setShort" type="number" min="1" class="w-full mt-1 p-2 bg-white/10 rounded-lg"></label>
            <label>Long (min)  <input id="setLong"  type="number" min="1" class="w-full mt-1 p-2 bg-white/10 rounded-lg"></label>
            <label>Long every N sessions <input id="setInterval" type="number" min="2" class="w-full mt-1 p-2 bg-white/10 rounded-lg"></label>
          </div>
          <label class="flex items-center gap-2 mt-3">
            <input id="setAutostart" type="checkbox" class="h-5 w-5 accent-[color:var(--primary)]"> Auto-start next session
          </label>
        </fieldset>

        <fieldset class="border-t border-white/20 pt-4">
          <legend class="text-[color:var(--primary)] font-medium">Theme & Background</legend>
          <div class="grid grid-cols-2 gap-3">
            <label>Season
              <select id="setSeason" class="w-full mt-1 p-2 bg-white/10 rounded-lg">
                <option value="summer">Summer</option>
                <option value="autumn">Autumn</option>
                <option value="winter">Winter</option>
              </select>
            </label>
            <label>Timezone
              <select id="setTZ" class="w-full mt-1 p-2 bg-white/10 rounded-lg">
                <option value="Africa/Johannesburg">Africa/Johannesburg</option>
                <option value="UTC">UTC</option>
                <option value="Europe/London">Europe/London</option>
                <option value="America/New_York">America/New_York</option>
                <option value="Asia/Tokyo">Asia/Tokyo</option>
              </select>
            </label>
            <label>Slideshow <input id="setSlide" type="checkbox" checked class="h-5 w-5 accent-[color:var(--primary)]"></label>
            <label>Slide interval (sec) <input id="setSlideInt" type="number" min="20" class="w-full mt-1 p-2 bg-white/10 rounded-lg"></label>
            <label>Dim background (%) <input id="setDim" type="range" min="0" max="70" step="1" class="w-full mt-1"></label>
          </div>
        </fieldset>

        <fieldset class="border-t border-white/20 pt-4">
          <legend class="text-[color:var(--primary)] font-medium">Weather & Rain</legend>
          <div class="grid grid-cols-2 gap-3">
            <label>Rain mode
              <select id="setRainMode" class="w-full mt-1 p-2 bg-white/10 rounded-lg">
                <option value="fixed-slots">Fixed times (clock)</option>
                <option value="clock-2h">Every 2 hours (clock)</option>
                <option value="runtime-2h">Every 2 hours (runtime)</option>
                <option value="random">Random 45-min showers</option>
                <option value="off">Off (spend credits)</option>
              </select>
            </label>
            <label>Credits (hours)
              <input id="setCredits" type="number" min="0" class="w-full mt-1 p-2 bg-white/10 rounded-lg" />
            </label>
          </div>
          <p class="text-xs opacity-70 mt-2">
            Turning rain <em>Off</em> costs 3 credits (temporary placeholder until the currency system lands).
          </p>
          <label class="flex items-center gap-2 mt-3">
            <input id="setRainTest" type="checkbox" class="scale-125">
            <span>Test rain (no lockout)</span>
          </label>
        </fieldset>

        <fieldset class="border-t border-white/20 pt-4">
          <legend class="text-[color:var(--primary)] font-medium">Calendar X</legend>
          <label class="flex items-center gap-2">
            <input id="setXMatchTheme" type="checkbox" class="scale-125" checked>
            <span>Match theme color (default)</span>
          </label>
          <label class="block mt-2">X color (manual)
            <input id="setXColor" type="color" value="#ffffff" class="mt-1 w-24 h-9 bg-white/10 rounded"
                   style="accent-color: var(--ui-primary-color)">
          </label>
        </fieldset>

        <div class="text-right">
          <button class="px-5 py-2 rounded-full bg-[color:var(--primary)] text-white">Save</button>
        </div>
      </form>
    </section>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded-full glass opacity-0 pointer-events-none transition-opacity">
    Settings saved ✔
  </div>

  <!-- Core App -->
  <script type="module">
// Use site-relative URLs so GitHub Pages serves assets directly
function siteBase(){
  const base = document.querySelector('base')?.href || (location.origin + location.pathname.replace(/[^/]*$/,''));
  return base.endsWith('/') ? base : base + '/';
}
const ASSET_ROOT = "assets";
const cdn = (p) => siteBase() + p.replace(/^\.?\//,'');



// Point audio to CDN during init
document.getElementById('sfx-splash').src = cdn(`${ASSET_ROOT}/audio/splash.mp3`);
document.getElementById('sfx-drawing').src = cdn(`${ASSET_ROOT}/audio/drawing.mp3`);
document.getElementById('sfx-rain').src    = cdn(`${ASSET_ROOT}/audio/rainfall.mp3`);

// --- Toast helper ---
function toast(msg, ms=2800){
  const host = document.getElementById('toastHost');
  if(!host) return;
  const el = document.createElement('div');
  el.className='toast'; el.textContent = msg;
  host.appendChild(el);
  setTimeout(()=> el.remove(), ms);
}

// NOTE: scheduleTick and reminder UI wiring will run after KV & helper declarations further down

    // ===== Icons =====
    lucide.createIcons();

    // --- Local key/value (Firestore replacement) ---
    const KV = {
      get(key, fallback){ try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; } },
      set(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
    };

    // Settings helpers
    const SETTINGS_KEY = 'sf_settings_v1';
    function loadSettings(defaults){ return KV.get(SETTINGS_KEY, defaults); }
    function saveSettings(obj){ KV.set(SETTINGS_KEY, obj); }

    // Reminders (local)
    const REM_KEY = 'sf_reminders_v1';
    const reminders = new Map(KV.get(REM_KEY, []));
    function saveReminders(){ KV.set(REM_KEY, [...reminders.entries()]); }

  // Calendar crossed days
  const X_KEY = 'sf_crossed_days_v1';
  const crossed = new Set(KV.get(X_KEY, []));
  function persistCrossed(){ KV.set(X_KEY, [...crossed]); }

  // Per-day tasks (localStorage) — single canonical pair
  function tasksKey(dateISO){ return `sf_tasks_${dateISO}`; }
  function readDayTasks(dateISO){ return JSON.parse(localStorage.getItem(tasksKey(dateISO)) || '[]'); }
  function writeDayTasks(dateISO, arr){ localStorage.setItem(tasksKey(dateISO), JSON.stringify(arr)); }

    // schedule tick for reminders (uses KV-backed `reminders`)
    const _remTimers = new Map();
    function scheduleReminderTimeout(r){
      if(_remTimers.has(r.id)) return;
      const now = Date.now(), t = new Date(r.when).getTime();
      const ms = t - now; if(ms <= 0) return;
      const id = setTimeout(()=>{ const a=$('#sfx-splash'); a && a.play().catch(()=>{}); const toastEl=$('#toast'); if(toastEl){ toastEl.textContent=r.msg; toastEl.style.opacity='1'; setTimeout(()=>{ toastEl.style.opacity='0'; toastEl.textContent='Settings saved ✔'; },3000); } _remTimers.delete(r.id); }, ms);
      _remTimers.set(r.id, id);
    }

    function scheduleTick(){
      setInterval(()=>{
        const now = Date.now();
        for(const [id, r] of reminders){
          if(!r.fired && now >= r.when){ r.fired = true; saveReminders(); try{ document.getElementById('sfx-splash')?.play?.(); }catch{}; toast(r.text||"⏰ Time’s up!"); if('Notification' in window && Notification.permission === 'granted'){ new Notification('Reminder', { body: r.text || 'Time!' }); } }
        }
      }, 15_000);
    }
    scheduleTick();
    (async ()=>{ if ('Notification' in window && Notification.permission==='default'){ try{ await Notification.requestPermission(); }catch{} }})();

    // Hook up Save button (new reminders)
    const remTimeEl = document.getElementById('remTime');
    const remTextEl = document.getElementById('remText');
    document.getElementById('remSaveBtn')?.addEventListener('click', ()=>{
      if(!remTimeEl?.value) return toast('Choose a time.');
      const [h,m] = remTimeEl.value.split(':').map(Number); const now = new Date(); const target = new Date(); target.setHours(h,m,0,0); if(target.getTime()<=now.getTime()) target.setDate(target.getDate()+1);
      const id = crypto.randomUUID(); reminders.set(id, { id, when: target.getTime(), text: remTextEl?.value?.trim() || 'Reminder', fired:false }); saveReminders(); toast("Alright, I'll remind you then Mr. Johnson! 😊");
    });

    // ===== Favicon helpers =====
    function setFaviconFromSvg(svgString){
      let link = document.querySelector('link#favicon');
      if(!link){ link = document.createElement('link'); link.id='favicon'; link.rel='icon'; link.type='image/svg+xml'; document.head.appendChild(link); }
      link.href = 'data:image/svg+xml;utf8,' + encodeURIComponent(svgString);
    }

    function svgFavicon({bg1='#1e293b', bg2='#0f172a', frame='#6ee7b7', sand='#f2d16b'}){
      return `
  <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'>
    <defs>
      <linearGradient id='bg' x1='0' y1='0' x2='0' y2='1'>
        <stop offset='0' stop-color='${bg1}'/><stop offset='1' stop-color='${bg2}'/>
      </linearGradient>
    </defs>
    <rect x='2' y='2' width='60' height='60' rx='14' fill='url(#bg)'/>
    <rect x='2' y='2' width='60' height='60' rx='14' fill='none' stroke='#ffffff22'/>
    <path d='M18 12h28v15c-8 5-8 5-14 11-6-6-6-6-14-11V12zm0 40V37c8-5 8-5 14-11 6 6 6 6 14 11v15H18z'
          fill='none' stroke='${frame}' stroke-width='3' stroke-linejoin='round'/>
    <rect x='22' y='14' width='20' height='10' rx='2' fill='${sand}'/>
    <rect x='22' y='40' width='20' height='10' rx='2' fill='${sand}'/>
    <circle cx='32' cy='32' r='1.5' fill='${sand}'/>
  </svg>`;
    }

    function updateFavicon(){
      // season palette
      let palette = {
        summer: { bg1:'#12361f', bg2:'#0b2416', frame:'#34d399', sand:'#f2d16b' },
        autumn: { bg1:'#3b1a0f', bg2:'#240e07', frame:'#fb923c', sand:'#8b5e3c' },
        winter: { bg1:'#0b1e3b', bg2:'#081429', frame:'#60a5fa', sand:'#cfd8dc' },
      }[state.season] || { bg1:'#1e293b', bg2:'#0f172a', frame:'#a78bfa', sand:'#f2d16b' };

      // night tweak
      if(state.timeOfDay==='night'){ palette.bg1 = '#0b1220'; palette.bg2 = '#070b14'; }

      // rain tweak
      if(state.weather==='rain'){ palette.sand = '#79c0ff'; }

      setFaviconFromSvg(svgFavicon(palette));
    }
  // Firebase removed: using localStorage-based helpers instead

    // ===== State =====
    const state = {
      season: 'summer',                 // summer | autumn | winter
      timeOfDay: 'day',                 // day | night (auto by clock)
      weather: 'clear',                 // clear | rain (scheduled)
      slideIndex: 1,
      slideOn: true,
  slideSec: 20,                    // default seconds (user can raise but never go below 20)
      tz: 'Africa/Johannesburg',
      // rain defaults
      rainMode: 'fixed-slots',   // fixed-slots | clock-2h | runtime-2h | random | off
      creditsHours: 0,           // temporary placeholder "currency"
      rainTest: false,   // when true, allow settings during rain
      rainCycleMs: 2*60*60*1000, // keep for runtime mode
      rainDurationMs: 45*60*1000,
      rainTimeout: null, clearTimeoutId: null,
      xMatchTheme: true,
      xColor: '#ffffff',
      // Pomodoro
      workMin: 25, shortMin: 5, longMin: 15, longEvery: 4, autostart: true,
      mode: 'work',                     // work | short | long
      sessionNum: 1,
      totalSec: 25*60,                  // remaining seconds for current session
      timerId: null,
      // inactivity
      inactive: false,
      // calendar
      calDate: new Date()
    };

// BG globals must exist before any clock-driven background change can run
let _bgActive = 'A';
let _bgTransitioning = false;

    // ===== El helpers =====
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    // ===== Nav switching =====
    const show = id => {
      ['#timerView','#calendarView','#settingsView'].forEach(s => $(s).classList.add('hidden'));
      $(id).classList.remove('hidden');
    };
    $('#goTimer'   ).onclick = ()=> show('#timerView');
    $('#goCalendar').onclick = ()=> { show('#calendarView'); renderCalendar(); };
    $('#goSettings').onclick = ()=> show('#settingsView');

    // === Particles v2 (continuous background + mouse trail) ===
    const fx = document.getElementById('fx');
    const ctx = fx.getContext('2d', { alpha:true });
    let P = [];              // active particles
    let MAX = 120;           // target count (varies by theme)
    let MODE = 'leaves';     // leaves | snow | rain | fireflies
    function resizeFx(){ fx.width = innerWidth; fx.height = innerHeight; }
    resizeFx(); addEventListener('resize', resizeFx);

    // Mouse trail (sprinkles on move)
    document.addEventListener('mousemove', e=>{
      for(let i=0;i<2;i++){ spawn(e.clientX, e.clientY, true); }
    });

    function spawn(x = Math.random()*fx.width, y = -10, gentle=false){
      if(MODE==='rain'){
        P.push({x, y, vx:0, vy: 8+Math.random()*6, r:1, a:0.5});
      }else if(MODE==='snow'){
        P.push({x, y, vx:(Math.random()-.5)*0.6, vy: 0.6+Math.random()*0.8, r: 1.5+Math.random()*1.5, a:0.9, wob:Math.random()*6.28});
      }else if(MODE==='fireflies'){
        P.push({x, y: Math.random()*fx.height, vx:(Math.random()-.5)*0.3, vy:(Math.random()-.5)*0.3, r:2+Math.random()*2, a:0.7, flick:Math.random()*6.28});
      }else{ // leaves
        const brown = (state.season==='autumn');
        const col = brown ? '#a35420' : '#3fb34e';
        P.push({x, y, vx:(Math.random()-.5)*0.8, vy: 0.8+Math.random()*1.2, w:4, h:4, col, wob:Math.random()*6.28});
      }
      // keep cap reasonable
      if(!gentle && P.length>MAX) P.splice(0, P.length-MAX);
    }

    function tickParticles(){
      ctx.clearRect(0,0,fx.width,fx.height);
      // spawn to maintain density (skip for fireflies; they persist)
      if(MODE!=='fireflies'){
        while(P.length<MAX) spawn();
      }else if(P.length<MAX){ spawn(); }

      for(let i=P.length-1;i>=0;i--){
        const p = P[i];
        if(MODE==='rain'){
          p.y += p.vy; if(p.y>fx.height+10) { P.splice(i,1); continue; }
          ctx.globalAlpha = p.a; ctx.strokeStyle = '#7fc3ff'; ctx.lineWidth=1;
          ctx.beginPath(); ctx.moveTo(p.x, p.y-8); ctx.lineTo(p.x, p.y); ctx.stroke();
        }else if(MODE==='snow'){
          p.wob += 0.02; p.x += p.vx + Math.sin(p.wob)*0.2; p.y += p.vy;
          if(p.y>fx.height+6) { P.splice(i,1); continue; }
          ctx.globalAlpha = p.a; ctx.fillStyle = '#ffffff'; ctx.beginPath();
          ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
        }else if(MODE==='fireflies'){
          p.flick += 0.05; p.x += p.vx; p.y += p.vy;
          if(p.x<0||p.x>fx.width) p.vx*=-1; if(p.y<0||p.y>fx.height) p.vy*=-1;
          const glow = (Math.sin(p.flick)*0.5+0.5)*0.6 + 0.3;
          ctx.shadowBlur = 12; ctx.shadowColor = '#ffd86b';
          ctx.globalAlpha = glow; ctx.fillStyle = '#fff7ae';
          ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
          ctx.shadowBlur = 0;
        }else{ // leaves
          p.wob += 0.03; p.x += p.vx + Math.sin(p.wob)*0.5; p.y += p.vy;
          if(p.y>fx.height+6) { P.splice(i,1); continue; }
          ctx.globalAlpha = .9; ctx.fillStyle = p.col;
          ctx.fillRect(p.x, p.y, p.w, p.h);
        }
      }
      ctx.globalAlpha = 1;
      requestAnimationFrame(tickParticles);
    }
    tickParticles();

    // switcher called when theme/weather/time changes
    function setParticleTheme(){
      if(state.weather==='rain'){ MODE='rain'; MAX = 240; P.length=0; return; }
      if(state.timeOfDay==='night'){ MODE='fireflies'; MAX = 60; P.length=0; return; }
      if(state.season==='winter'){ MODE='snow'; MAX = 140; P.length=0; return; }
      MODE='leaves'; MAX = 120; P.length=0; // summer/autumn leaves
    }
    // call whenever theme changes:
    setParticleTheme();

    // ===== Perpetual clock + day/night switch =====
    function tickClock(){
      const now = new Date();
      const fmt = new Intl.DateTimeFormat('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false,timeZone:state.tz});
      $('#clock').textContent = fmt.format(now);
      const hour = Number(new Intl.DateTimeFormat('en-GB',{hour:'2-digit',hour12:false,timeZone:state.tz}).format(now));
      const was = state.timeOfDay;
      state.timeOfDay = (hour>=6 && hour<18) ? 'day' : 'night';
      if (state.timeOfDay !== was){
        applyTheme(); setParticleTheme();
        // If a fade is mid-flight or not initialized yet, just set instantly
        if (typeof _bgTransitioning === 'undefined') { setBackground(); }
        else { refreshBackground(); }
      }
    }
    setInterval(tickClock, 1000); tickClock();

    // ===== Background manager (single source of truth) =====
    /* === Background manager (single source of truth) === */
    const ONE_MIN = 60000;
    const cacheBust = () => `?t=${Math.floor(Date.now()/ONE_MIN)}`;

    let cur = document.getElementById('bgA');
    let next = document.getElementById('bgB');
    cur.classList.add('show');

    function prefixForState(){
      return (state.weather === 'rain') ? 'rain-bg' : `${state.season}-${state.timeOfDay}`;
    }

    // discover max available slides (cached 24h)
    const MAX_LS_KEY = 'sf_max_slides_v1';
    let maxCache = JSON.parse(localStorage.getItem(MAX_LS_KEY)||'{}');
    async function exists(url){
      try{ const r=await fetch(url,{method:'HEAD',cache:'no-store'}); return r.ok; }catch{return false;}
    }
    async function discoverMax(prefix){
      const c = maxCache[prefix];
      if (c && Date.now() < c.ttl) return c.n;
      let lo=1, hi=8;
      while (await exists(cdn(`assets/images/${prefix}-${hi}.png`))) { lo=hi; hi<<=1; if (hi>512) break; }
      while (lo+1<hi){
        const mid=(lo+hi)>>1;
        if (await exists(cdn(`assets/images/${prefix}-${mid}.png`))) lo=mid; else hi=mid;
      }
      maxCache[prefix] = { n: lo, ttl: Date.now()+86400000 };
      localStorage.setItem(MAX_LS_KEY, JSON.stringify(maxCache));
      return lo;
    }

    // queue & timing
    let currentPrefix = null, currentMax = 8, slideIdx = 1;
    let queue = []; // {i,url,img,readyMs}
    const decodeSamples = [];
    const avg = a => a.length ? a.reduce((s,v)=>s+v,0)/a.length : 0;

    async function makeUrl(i){
      const p = prefixForState();
      if (p !== currentPrefix){
        currentPrefix = p;
        currentMax = await discoverMax(p);
        queue.length = 0;
      }
      const j = ((i-1) % currentMax) + 1;
      return cdn(`assets/images/${currentPrefix}-${j}.png`) + cacheBust();
    }

    async function preloadItem(i){
      let url;
      if (state.weather==='rain'){
        const j = 1 + Math.floor(Math.random()*currentMax);
        url = cdn(`assets/images/${currentPrefix}-${j}.png`) + cacheBust();
      } else {
        url = await makeUrl(i);
      }
      const img = new Image();
      const t0 = performance.now();
      img.src = url;
      try{
        if (img.decode) await img.decode();
        else await new Promise(r=>{img.onload=r;img.onerror=r;});
      }catch{}
      const readyMs = Math.max(120, performance.now()-t0);
      decodeSamples.push(readyMs); if (decodeSamples.length>8) decodeSamples.shift();
      return { i, url, img, readyMs };
    }

    async function fillQueue(){
      while (queue.length < 2){
        const last = queue.at(-1)?.i ?? slideIdx;
        queue.push(await preloadItem(last+1));
      }
    }

    async function refreshBackground(){
      if (!queue.length) await fillQueue();
      const it = queue.shift();
      next.style.backgroundImage = `url("${it.url}")`;
      next.classList.add('show'); cur.classList.remove('show');
      [cur, next] = [next, cur];
      slideIdx = it.i;
      fillQueue();
    }

    async function setBackground(){ // first paint, no cross-fade
      const url = await makeUrl(slideIdx);
      const css = `url("${url}")`;
      document.getElementById('bgA').style.backgroundImage = css;
      document.getElementById('bgB').style.backgroundImage = css;
    }

    function minIntervalMs(){ return Math.max(900, Math.ceil(avg(decodeSamples) + 250)); }
    let slideTimer = null;     // existing
    let preloadTimeout = null; // new
    let preloadPulse = null;   // new
    let currentDelayMs = 20000;

    function schedulePreload(){
      clearTimeout(preloadTimeout);
      // Ensure the next image is decoded ≥10s before the swap
      const when = Math.max(0, currentDelayMs - 10000);
      preloadTimeout = setTimeout(()=> { fillQueue().catch(()=>{}); }, when);
    }
    function startSlideshow(){
      clearInterval(slideTimer);
      clearInterval(preloadPulse);
      if (!state.slideOn) return;

      const delay = Math.max(state.slideSec*1000, minIntervalMs());
      currentDelayMs = delay;

      // Swap on a fixed cadence
      slideTimer = setInterval(()=>{ slideIdx++; refreshBackground(); schedulePreload(); }, delay);

      // Safety: keep the queue warm every 15s regardless of user interval
      preloadPulse = setInterval(()=> { fillQueue().catch(()=>{}); }, 15000);

      // And ensure we have the next image ≥10s before the first swap
      schedulePreload();
    }
    function stopSlideshow(){
      clearInterval(slideTimer);
      clearInterval(preloadPulse);
      clearTimeout(preloadTimeout);
      slideTimer = null; preloadPulse = null; preloadTimeout = null;
    }

    (async ()=>{ try{ await setBackground(); startSlideshow(); refreshBackground().catch(()=>{}); }catch(e){ /* non-fatal */ } })();

    // ===== Theme application =====
    function applyTheme(){
      const root = document.documentElement;
      let primary, sand;
      if(state.season==='summer'){ primary='#4CAF50'; sand='#FFC107'; }
      else if(state.season==='autumn'){ primary='#FF5722'; sand='#8B5E3C'; }
      else /* winter */ { primary='#2196F3'; sand='#CFD8DC'; }
  root.style.setProperty('--ui-primary-color', primary);
  root.style.setProperty('--primary', primary);
  // Set the X color: theme-matched or manual
  root.style.setProperty('--x-color', state.xMatchTheme ? primary : state.xColor);
  // If raining, tint sand bluish
  if(state.weather==='rain'){ sand = '#79c0ff'; }
      root.style.setProperty('--ui-sand-color', sand);
      document.body.classList.toggle('night', state.timeOfDay==='night');
      document.body.classList.toggle('rain',  state.weather==='rain');
      // lock settings during rain
      $('#rainBlocker').classList.toggle('hidden', state.weather!=='rain' || state.rainTest);
      setParticleTheme();
      // Number color by theme (always white at night; seasonal only by day)
      const countdown = $('#countdown');
      if(countdown){
        if(state.timeOfDay==='night'){
          countdown.style.color = '#ffffff';        // always white at night
        }else if(state.weather==='rain'){
          countdown.style.color = '#cfe9ff';
        }else if(state.season==='winter'){
          countdown.style.color = '#000000';
        }else{
          countdown.style.color = '#ffffff';
        }
      }
      // update favicon to match current theme
      try{ updateFavicon(); }catch(e){ /* non-fatal */ }
    }

    // Shock blocker
    const _rb = $('#rainBlocker');
    if(_rb){
      _rb.addEventListener('click', ()=>{
        $('#settingsView').classList.add('shocked');
        setTimeout(()=> $('#settingsView').classList.remove('shocked'), 500);
        const a=$('#sfx-splash'); if(a){ a.currentTime=0; a.play().catch(()=>{}); } // cheeky zap ;)
      });
    }

    // ===== Rain scheduler (multiple modes) =====
    function scheduleRainCycle(){
      // clear any previous timers
      if(state.rainTimeout){ clearTimeout(state.rainTimeout); state.rainTimeout=null; }
      if(state.clearTimeoutId){ clearTimeout(state.clearTimeoutId); state.clearTimeoutId=null; }

      if(state.rainMode === 'runtime-2h') return scheduleRuntimeEvery2h();
      if(state.rainMode === 'clock-2h')   return scheduleClockEvery2h();
      if(state.rainMode === 'random')     return scheduleRandomToday();
      if(state.rainMode === 'fixed-slots')return scheduleFixedSlots();
      // off => do nothing
    }

    function scheduleRuntimeEvery2h(){
      state.rainTimeout = setTimeout(()=>{
        startRain();
        state.clearTimeoutId = setTimeout(stopRain, state.rainDurationMs);
        state.rainTimeout = setTimeout(scheduleRuntimeEvery2h, state.rainCycleMs - state.rainDurationMs);
      }, state.rainCycleMs);
    }

    function startRain(){
      state.weather='rain'; applyTheme(); setParticleTheme(); refreshBackground(); startRainAudio();
      $$('.glass, button').forEach(b=> b.addEventListener('click', rainRippleOnce, {once:false}));
    }
    function stopRain(){
      state.weather='clear'; applyTheme(); setParticleTheme(); refreshBackground(); stopRainAudio();
      $$('.glass, button').forEach(b=> b.removeEventListener('click', rainRippleOnce));
    }

    function toggleTestRain(){
      if (state.weather==='rain') {
        state.weather='clear'; applyTheme(); setParticleTheme(); refreshBackground(); stopRainAudio();
      } else {
        state.weather='rain';  applyTheme(); setParticleTheme(); refreshBackground(); startRainAudio();
      }
    }

    function nowInTz(tz){ return new Date(new Intl.DateTimeFormat('en-GB',{timeZone:tz, hour12:false}).format ? Date.now() : Date.now()); }
    // Build a Date today in tz at hh:mm
    function dateAt(h, m, tz){
      const now = new Date();
      const parts = new Intl.DateTimeFormat('en-GB',{timeZone:tz,hour:'2-digit',minute:'2-digit',second:'2-digit',year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(now)
        .reduce((o,p)=> (o[p.type]=p.value, o), {});
      const y = Number(parts.year), mo = Number(parts.month)-1, d = Number(parts.day);
      // Create local time for that tz's wallclock, then adjust by tz offset difference
      const targetLocal = new Date(y, mo, d, h, m, 0, 0);
      // Compute the next occurrence in real time:
      return targetLocal;
    }
    function msUntil(dt){ return Math.max(0, dt.getTime() - Date.now()); }

    const FIXED_SLOTS = [ // 24h format
      [10,0],[12,0],[14,0],[16,0],[18,0],[20,0],[22,0],[0,0]
    ];
    function nextFixedSlotDate(){
      const tz = state.tz;
      const today = new Date();
      // build candidate dates for today
      const cands = FIXED_SLOTS.map(([h,m])=> dateAt(h,m,tz))
        .map(d => (d.getTime() < Date.now() ? new Date(d.getTime()+86400000) : d));
      // earliest upcoming
      return cands.sort((a,b)=>a-b)[0];
    }
    function scheduleFixedSlots(){
      const startAt = nextFixedSlotDate();
      state.rainTimeout = setTimeout(()=>{
        startRain();
        state.clearTimeoutId = setTimeout(()=>{
          stopRain();
          scheduleFixedSlots(); // schedule the next slot after stopping
        }, state.rainDurationMs);
      }, msUntil(startAt));
    }

    function nextClock2hBoundary(){
      const tz = state.tz;
      const now = new Date();
      const parts = new Intl.DateTimeFormat('en-GB',{timeZone:tz,hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(now)
        .reduce((o,p)=> (o[p.type]=p.value, o), {});
      const y=+parts.year, mo=+parts.month-1, d=+parts.day, hh=+parts.hour, mm=+parts.minute;
      const nextHour = (Math.floor(hh/2)+1)*2;
      const carry = nextHour>=24 ? 1 : 0;
      const h = nextHour%24;
      const start = new Date(y,mo,d + carry,h,0,0,0);
      return start;
    }
    function scheduleClockEvery2h(){
      const startAt = nextClock2hBoundary();
      state.rainTimeout = setTimeout(()=>{
        startRain();
        state.clearTimeoutId = setTimeout(()=>{
          stopRain();
          scheduleClockEvery2h(); // re-align to next boundary
        }, state.rainDurationMs);
      }, msUntil(startAt));
    }

    function scheduleRandomToday(){
      const tz = state.tz;
      // pick a random minute in the next 24h window
      const startInMs = Math.floor(Math.random() * 24*60)*60*1000;
      const startAt = new Date(Date.now() + startInMs);
      state.rainTimeout = setTimeout(()=>{
        startRain();
        state.clearTimeoutId = setTimeout(()=>{
          stopRain();
          scheduleRandomToday();
        }, state.rainDurationMs);
      }, msUntil(startAt));
    }
    // Reminders & calendar tasks are stored locally using KV/readTasks/writeTasks
    function ymKey(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
    function ddKey(day){ return String(day).padStart(2,'0'); }
    function rainRippleOnce(e){
      const el = e.currentTarget;
      el.classList.add('ripple','pulse');
      const r = el.getBoundingClientRect(); const d = Math.max(r.width,r.height)*1.8;
      el.style.setProperty('--rsize', d+'px'); el.style.setProperty('--rx', (e.clientX-r.left)+'px'); el.style.setProperty('--ry',(e.clientY-r.top)+'px');
      setTimeout(()=> el.classList.remove('pulse'), 620);
    }
    function startRainAudio(){ const a=$('#sfx-rain'); if(!a) return; a.currentTime=0; a.play().catch(()=>{}); }
    function stopRainAudio(){ const a=$('#sfx-rain'); if(!a) return; a.pause(); }

    // Inactivity (2 min): hide big panel, show dock at bottom
    let idle;
    function renderDock(){
      $('#dockMode').textContent = (state.mode==='work' ? 'Work' : state.mode==='short' ? 'Short' : 'Long');
      const mm = t=> String(Math.floor(t/60)).padStart(2,'0');
      const ss = t=> String(Math.floor(t%60)).padStart(2,'0');
      $('#dockTime').textContent = `${mm(state.totalSec)}:${ss(state.totalSec)}`;
    }
    function collapseToDock(){
      state.inactive = true;
      $('#timerView').style.display = 'none';
      $('#dockTimer').classList.remove('hidden'); renderDock();
    }
    function expandFromDock(){
      state.inactive = false;
      $('#timerView').style.display = ''; 
      $('#dockTimer').classList.add('hidden');
    }
    function resetIdle(){
      clearTimeout(idle);
      if(state.inactive) expandFromDock();
      idle = setTimeout(collapseToDock, 120000);
    }
    ['mousemove','keydown','click','scroll','touchstart'].forEach(ev => document.addEventListener(ev, resetIdle));
    resetIdle();

    // keep dock time fresh
    setInterval(()=>{ if(state.inactive) renderDock(); }, 1000);

    // ===== Side nav auto-hide (3s) =====
    let navTimer;
    function showNav(){ $('#sideNav').classList.remove('hiddenish'); clearTimeout(navTimer); navTimer=setTimeout(()=>$('#sideNav').classList.add('hiddenish'),3000); }
    document.addEventListener('mousemove', e => { if(window.innerWidth - e.clientX < 120) showNav(); });
    showNav();

    // ===== Pomodoro state machine =====
    function readSettings(){
      // Read current form values (if present) else keep defaults
      const v = id => document.getElementById(id)?.value;
      const cb = id => document.getElementById(id)?.checked;
      state.workMin   = Number(v('setWork')  ?? state.workMin)   || state.workMin;
      state.shortMin  = Number(v('setShort') ?? state.shortMin)  || state.shortMin;
      state.longMin   = Number(v('setLong')  ?? state.longMin)   || state.longMin;
      state.longEvery = Number(v('setInterval') ?? state.longEvery) || state.longEvery;
      state.autostart = cb('setAutostart') ?? state.autostart;
      state.season    = v('setSeason') ?? state.season;
      state.tz        = v('setTZ') ?? state.tz;
      state.slideOn   = document.getElementById('setSlide')?.checked ?? state.slideOn;
      state.slideSec = Math.max(20, Number(v('setSlideInt') ?? state.slideSec) || state.slideSec);
      state.rainMode = (document.getElementById('setRainMode')?.value) || state.rainMode;
      state.creditsHours = Math.max(0, Number(document.getElementById('setCredits')?.value ?? state.creditsHours) || state.creditsHours);
      state.rainTest = !!document.getElementById('setRainTest')?.checked;
      
      const testWasOn = document.documentElement.dataset.rt === '1';
      document.documentElement.dataset.rt = state.rainTest ? '1' : '0';
      if (state.rainTest !== testWasOn) toggleTestRain();
      
      state.xMatchTheme = !!document.getElementById('setXMatchTheme')?.checked;
      const picked = document.getElementById('setXColor')?.value;
      if (picked) state.xColor = picked;
      
      // enable/disable the color input when matching theme
      const xColorInput = document.getElementById('setXColor');
      if (xColorInput){ 
        xColorInput.disabled = state.xMatchTheme;
        if (!state.xMatchTheme) state.xColor = xColorInput.value;
      }

      // Guard the "off" mode behind credits (cost = 3)
      if (state.rainMode === 'off') {
        if (state.creditsHours < 3) {
          toast('Not enough credits to turn rain off (need 3).');
          state.rainMode = 'fixed-slots';
        } else {
          state.creditsHours -= 3;
          toast('3 credits spent — rain disabled.');
        }
      }
      document.documentElement.style.setProperty('--scrim', ((document.getElementById('setDim')?.value ?? 28)/100));
    }
    function durationFor(mode){
      if(mode==='work') return state.workMin*60;
      if(mode==='short') return state.shortMin*60;
      return state.longMin*60;
    }
    function updateTimerUI(){
      const mm = t=> String(Math.floor(t/60)).padStart(2,'0');
      const ss = t=> String(t%60).padStart(2,'0');
      $('#countdown').textContent = `${mm(state.totalSec)}:${ss(state.totalSec)}`;
      $('#minTime').textContent   = `${mm(state.totalSec)}:${ss(state.totalSec)}`;
      $('#modeLabel').textContent = (state.mode==='work' ? 'Work' : (state.mode==='short' ? 'Short Break' : 'Long Break'));
      $('#minMode').textContent   = $('#modeLabel').textContent;
      $('#sessionLabel').textContent = `Session ${state.sessionNum} of ${state.longEvery}`;
      $('#minSess').textContent      = `${state.sessionNum} of ${state.longEvery}`;
      // hourglass
      updateHourglass(durationFor(state.mode), state.totalSec);
    }
    function switchMode(){
      const hg = document.getElementById('hourglass');
      if(hg){ hg.classList.add('flip'); setTimeout(()=> hg.classList.remove('flip'), 650); }

      if(state.mode==='work'){
        // Completed a work session
        if(state.sessionNum % state.longEvery === 0){ state.mode='long'; } else { state.mode='short'; }
      }else{
        // Moving back to work
        state.sessionNum = (state.mode==='long') ? 1 : state.sessionNum+1;
        state.mode='work';
      }
      state.totalSec = durationFor(state.mode);
      updateTimerUI();
    }
    function startNextSession(){
      switchMode();
      if(state.autostart) startTimer();
    }
    function onCompleteBeep(){ const a=$('#sfx-splash'); if(a){ a.currentTime=0; a.play().catch(()=>{});} }
    function startTimer(){
      if(state.timerId) return;
      const hg = document.getElementById('hourglass');
      if(hg){ hg.classList.add('flip'); setTimeout(()=> hg.classList.remove('flip'), 650); }
      $('#btnStart').hidden = true; $('#btnPause').hidden = false;
      state.timerId = setInterval(()=>{
        state.totalSec--;
        if(state.totalSec<=0){
          clearInterval(state.timerId); state.timerId=null;
          onCompleteBeep();
          startNextSession();
        }
        updateTimerUI();
      },1000);
    }
    function pauseTimer(){ if(state.timerId){ clearInterval(state.timerId); state.timerId=null; } $('#btnStart').hidden=false; $('#btnPause').hidden=true; }
    function resetTimer(){
      pauseTimer();
      state.mode='work'; state.sessionNum=1; state.totalSec=durationFor('work'); updateTimerUI();
    }
    $('#btnStart').onclick=startTimer; $('#btnPause').onclick=pauseTimer; $('#btnReset').onclick=resetTimer;

    // ===== Hourglass SVG updater (proportional) =====
    function updateHourglass(total, left){
      const top = document.getElementById('sandTop');
      const bot = document.getElementById('sandBot');
      const stream = document.getElementById('sandStream');
      if(!top||!bot) return;

      const p = 1 - (left/Math.max(1,total)); // 0..1 poured
      const topH = 56*(1-p); // top shrinks
      const botH = 56*(p);   // bottom grows
      top.setAttribute('height', Math.max(0, topH));
      bot.setAttribute('y', 180 - botH - 0);   // anchored to bottom glass
      bot.setAttribute('height', Math.max(0, botH));
      stream.style.display = (p>0 && p<1) ? 'block' : 'none';
    }

    // ===== Settings submit =====
    $('#settings')?.addEventListener('submit', e=>{
      e.preventDefault();
  readSettings(); applyTheme(); refreshBackground(); stopSlideshow(); startSlideshow();
      
      // Save settings to localStorage
      saveSettings({
        season: state.season, tz: state.tz, slideOn: state.slideOn, slideSec: state.slideSec,
        rainMode: state.rainMode, creditsHours: state.creditsHours, xMatchTheme: state.xMatchTheme, xColor: state.xColor
      });
      
      const t = $('#toast'); if(t){ t.style.opacity = '1'; setTimeout(()=> t.style.opacity='0', 1400); }
    });

  // ==== Reminders (simple local scheduler) ====
  const remModal = $('#remModal'), remTime = $('#remTime'), remText = $('#remText');
    $('#btnReminder')?.addEventListener('click', ()=> {
      // prime with 5 minutes from now
      const now = new Date();
      now.setMinutes(now.getMinutes()+5);
      remTime.value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  remText.value = 'Time to switch focus';
      remModal.classList.remove('hidden');
    });
    $('#remCancel')?.addEventListener('click', ()=> remModal.classList.add('hidden'));
    // ===== Reminders panel (Firestore-backed) =====
    const clockBtn = $('#clockBtn'), remPanel = $('#remPanel'), remList = $('#remList');
    clockBtn?.addEventListener('click', ()=> remPanel.classList.toggle('hidden'));
    document.addEventListener('click', (e)=>{
      if(!remPanel.contains(e.target) && !clockBtn.contains(e.target)) remPanel.classList.add('hidden');
    });

    // Create / Edit modal reuse (we’ll reuse the same modal from #timerView)
    $('#remNew')?.addEventListener('click', ()=> {
      $('#btnReminder')?.click(); // open the modal we added earlier
    });

    // Render reminders list from local Map
    async function loadAndRenderReminders(){
      const items = [...reminders.values()];
      remList.innerHTML = items.length ? '' : '<div class="opacity-70">No reminders yet.</div>';
      items.sort((a,b)=> new Date(a.when) - new Date(b.when));
      for(const r of items){
        const row = document.createElement('div');
        row.className = 'glass rounded-lg p-2 flex items-center justify-between';
        row.innerHTML = `
          <div>
            <div class="font-medium">${new Date(r.when).toLocaleString()}</div>
            <div class="opacity-80">${r.msg}</div>
          </div>
          <div class="flex gap-2">
            <button class="glass px-2 py-1 rounded" data-act="edit">Edit</button>
            <button class="glass px-2 py-1 rounded" data-act="del">Del</button>
          </div>
        `;
        row.querySelector('[data-act="edit"]').onclick = ()=> openEditReminder(r);
        row.querySelector('[data-act="del"]').onclick  = async()=>{ reminders.delete(r.id); saveReminders(); await loadAndRenderReminders(); };
        remList.appendChild(row);
        scheduleReminderTimeout(r); // ensure it will fire
      }
    }

    function openEditReminder(r){
      remTime.value = new Date(r.when).toTimeString().slice(0,5);
      remText.value  = r.msg;
      remModal.classList.remove('hidden');
      // save will overwrite (we use r.id)
      $('#remSaveBtn').onclick = async()=>{
        const [hh,mm] = (remTime.value||'').split(':').map(Number);
        if(Number.isNaN(hh)||Number.isNaN(mm)) return remTime.focus();
        const now = new Date(); const target = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0);
        if(target<=now) target.setDate(target.getDate()+1);
        const id = r.id || crypto.randomUUID();
        reminders.set(id, { id, when: target.toISOString(), msg: remText.value.trim()||'Reminder' });
        saveReminders();
        remModal.classList.add('hidden'); await loadAndRenderReminders();
      };
    }

    // When saving from the "Set Reminder" modal (new reminder path)
    const originalRemSave = $('#remSaveBtn')?.onclick; // in case defined
    $('#remSaveBtn').onclick = async()=>{
      const [hh,mm] = (remTime.value||'').split(':').map(Number);
      if(Number.isNaN(hh)||Number.isNaN(mm)) return remTime.focus();
      const now = new Date(); const target = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0);
      if(target<=now) target.setDate(target.getDate()+1);
      const id = crypto.randomUUID();
      reminders.set(id, { id, when: target.toISOString(), msg: remText.value.trim()||'Reminder' });
      saveReminders();
      remModal.classList.add('hidden');
      await loadAndRenderReminders();
    };

    // scheduleReminderTimeout is defined earlier and reused

  // ===== Calendar =====
  // Call this after you render each day cell:
    function wireDayCell(cell){ // cell must have data-date="YYYY-MM-DD"
      const date = cell.dataset.date;
      // right-click toggles an X with a draw animation
      cell.addEventListener('contextmenu', (e)=>{
        e.preventDefault();
        if(!date) return; // guard
        const isCrossed = crossed.has(date);
        if (isCrossed){
          crossed.delete(date);
          cell.classList.remove('crossed','cross-anim');
        } else {
          crossed.add(date);
          cell.classList.add('crossed','cross-anim');
          setTimeout(()=> cell.classList.remove('cross-anim'), 400);
          celebrate();
        }
        persistCrossed();
      });
      // left-click to open tasks
      cell.addEventListener('click', ()=> openTasks(date));
      // initialize visual
      cell.classList.toggle('crossed', crossed.has(date));
    }

    // Simple celebrate popup
    const praise = [
      "All done! You crushed it! 🎉",
      "Nice! Streak maintained. 🔥",
      "That’s a wrap—great focus! ✅",
      "Boom! Tasks completed. 💥",
      "Chef’s kiss of productivity. 👌"
    ];
    function celebrate(){ toast(praise[Math.floor(Math.random()*praise.length)]); }

  // --- Per-day tasks (localStorage) ---
  // (duplicate removed — using readDayTasks/writeDayTasks)

    const tasksModal = document.getElementById('dayTasksModal');
    const tasksList = document.getElementById('tasksList');
    const tasksDateLabel = document.getElementById('tasksDateLabel');
    document.getElementById('tasksClose').onclick = ()=> tasksModal.style.display='none';

    let activeDateISO = null;

    function openTasks(dateISO){
      activeDateISO = dateISO;
      tasksDateLabel.textContent = `Tasks — ${dateISO}`;
      renderTasks();
      tasksModal.style.display='grid';
    }

    function renderTasks(){
      const items = readDayTasks(activeDateISO);
      tasksList.innerHTML = '';
      items.forEach((t,i)=>{
        const row = document.createElement('div');
        row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center';
        row.innerHTML = `
          <input type="checkbox" ${t.done?'checked':''} data-i="${i}">
          <div style="flex:1;${t.done?'text-decoration:line-through;opacity:.7':''}">${t.text}</div>
          <button data-del="${i}" style="background:#374151;border:0;color:#fff;padding:.3rem .6rem;border-radius:8px">Del</button>
        `;
        tasksList.appendChild(row);
      });
      // wire
      tasksList.querySelectorAll('input[type=checkbox]').forEach(cb=>{
        cb.onchange = ()=>{
          const i = +cb.dataset.i; const arr = readDayTasks(activeDateISO);
          arr[i].done = cb.checked; writeDayTasks(activeDateISO, arr); renderTasks();
        };
      });
      tasksList.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.onclick = ()=>{
          const i = +btn.dataset.del; const arr = readDayTasks(activeDateISO);
          arr.splice(i,1); writeDayTasks(activeDateISO, arr); renderTasks();
        };
      });
    }

    document.getElementById('taskAdd').onclick = ()=>{
      const input = document.getElementById('taskText');
      const txt = input.value.trim(); if(!txt) return;
  const arr = readDayTasks(activeDateISO); arr.push({text:txt, done:false});
  writeDayTasks(activeDateISO, arr); input.value=''; renderTasks();
    };

    const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    function renderCalendar(){
      const grid = $('#calGrid'); grid.innerHTML='';
      const d = new Date(state.calDate.getFullYear(), state.calDate.getMonth(), 1);
      const month = d.getMonth(), year = d.getFullYear();
      $('#calTitle').textContent = new Intl.DateTimeFormat('en-GB',{month:'long', year:'numeric'}).format(d);
      // headers
      weekdays.forEach(w => {
        const h = document.createElement('div'); h.textContent = w; h.className = 'text-xs opacity-70';
        grid.appendChild(h);
      });
      // pad before first day
      const start = (d.getDay()+7)%7; for(let i=0;i<start;i++){ const pad = document.createElement('div'); grid.appendChild(pad); }
      // days
      const daysInMonth = new Date(year, month+1, 0).getDate();
      for(let day=1; day<=daysInMonth; day++){
        const cell = document.createElement('div');
        // keep existing 'day' class for compatibility; add 'day-cell' to host overlay
        cell.className = 'relative p-3 h-20 glass rounded-lg select-none day day-cell';
        cell.innerHTML = `<div class="text-sm opacity-80">${day}</div>`;
        
        const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
        svg.setAttribute('class','day-x');
        svg.setAttribute('viewBox','0 0 100 100');
        svg.innerHTML = `
          <line class="cross a" x1="15" y1="15" x2="85" y2="85"></line>
          <line class="cross b" x1="85" y1="15" x2="15" y2="85"></line>`;
        cell.appendChild(svg);
        
        // set data-date as YYYY-MM-DD
        const mm = String(month+1).padStart(2,'0');
        const dd = String(day).padStart(2,'0');
        const iso = `${year}-${mm}-${dd}`;
        cell.dataset.date = iso;

        // right-click toggle (draw animation + persistence)
        cell.addEventListener('contextmenu', (e)=>{
          e.preventDefault();
          const d = cell.dataset.date;
          const nowCrossed = !crossed.has(d);
          cell.classList.toggle('crossed', nowCrossed);
          if (nowCrossed){
            crossed.add(d);
            cell.classList.add('cross-anim'); setTimeout(()=>cell.classList.remove('cross-anim'), 260);
            celebrate(); // your toast
          } else {
            crossed.delete(d);
          }
          // play drawing sound
          const draw = document.getElementById('sfx-drawing');
          if (draw){ draw.currentTime = 0; draw.play().catch(()=>{}); }
          persistCrossed();
        });

        // left-click opens tasks
        cell.addEventListener('click', ()=> openTasks(iso));

        // initial state
        cell.classList.toggle('crossed', crossed.has(iso));

        grid.appendChild(cell);
      }
    }
    $('#prevMonth').onclick = ()=>{ state.calDate.setMonth(state.calDate.getMonth()-1); renderCalendar(); }
    $('#nextMonth').onclick = ()=>{ state.calDate.setMonth(state.calDate.getMonth()+1); renderCalendar(); }
    $('#taskClose').onclick = ()=> $('#taskModal').classList.add('hidden');



    // ===== Boot =====
  (async ()=>{
    // Merge saved settings with defaults before first readSettings()
    const savedSettings = loadSettings({});
    Object.assign(state, {
      season: savedSettings.season ?? state.season,
      tz: savedSettings.tz ?? state.tz,
      slideOn: savedSettings.slideOn ?? state.slideOn,
      slideSec: savedSettings.slideSec ?? state.slideSec,
      rainMode: savedSettings.rainMode ?? state.rainMode,
      creditsHours: savedSettings.creditsHours ?? state.creditsHours,
      xMatchTheme: savedSettings.xMatchTheme ?? state.xMatchTheme,
      xColor: savedSettings.xColor ?? state.xColor
    });
    
    readSettings(); applyTheme(); try{ updateFavicon(); }catch(e){}
    await setBackground(); // initial, non-animated set
    startSlideshow(); renderCalendar(); scheduleRainCycle(); updateTimerUI();
    // kick off first refresh in background (non-blocking)
    refreshBackground().catch(()=>{});
  })();
  loadAndRenderReminders().catch(console.error);
  </script>
  <!-- Day Tasks modal (local per-day tasks) -->
  <div id="dayTasksModal" style="position:fixed;inset:0;display:none;place-items:center;background:#0008;z-index:70">
    <div style="width:520px;background:#111827ee;color:#fff;border-radius:14px;padding:20px;box-shadow:0 20px 60px #0006">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <strong id="tasksDateLabel">Tasks</strong>
        <button id="tasksClose" style="background:#374151;border:0;color:#fff;padding:.4rem .7rem;border-radius:8px">Close</button>
      </div>
      <div id="tasksList" style="display:grid;gap:8px;margin-bottom:12px"></div>
      <div style="display:flex;gap:8px">
        <input id="taskText" placeholder="New task…" style="flex:1;padding:.6rem;border-radius:8px;border:1px solid #374151;background:#111827;color:#fff">
        <button id="taskAdd" class="btn">Add</button>
      </div>
    </div>
  </div>

  <!-- Docked mini-timer -->
  <div id="dockTimer" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-40 hidden">
    <div class="glass rounded-full px-4 py-2 flex items-center gap-3 shadow-lg">
      <span id="dockMode" class="text-xs opacity-80"></span>
      <span id="dockTime" class="text-2xl font-mono font-bold"></span>
    </div>
  </div>
</body>
</html>