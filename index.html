<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StudyFlow</title>

  <!-- Tailwind + Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <link rel="preload" as="image" href="https://cdn.jsdelivr.net/gh/NateJ-coder/Study-Flow-Manager@main/timer-assets/assets/images/summer-day-1.png">
  <link rel="preload" as="audio" href="https://cdn.jsdelivr.net/gh/NateJ-coder/Study-Flow-Manager@main/timer-assets/assets/audio/splash.mp3">

  <!-- Base theme vars -->
  <style>
    :root{
      --primary:#4A3DF2;           /* main accent (overridden by season) */
      --x-color:#ffffff;           /* calendar X color (user setting)   */
      --sand:#f2d16b;              /* hourglass sand (season-linked)    */
      --scrim:0.28;                /* bg dim overlay                    */
      --ui-primary-color:var(--primary);
      --ui-sand-color:var(--sand);
    }
    .glass{background:rgba(255,255,255,0.18); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,.18)}
    .view{animation:fade .25s} @keyframes fade{from{opacity:0}to{opacity:1}}
    /* Calendar cross animation */
    @keyframes x1{to{stroke-dashoffset:0}} @keyframes x2{to{stroke-dashoffset:0}}
    .cross{stroke:var(--x-color); stroke-width:8; stroke-linecap:round; fill:none; stroke-dasharray:120; stroke-dashoffset:120}
    .cross.a{animation:x1 .35s ease-out forwards} .cross.b{animation:x2 .35s .15s ease-out forwards}
    /* Inactivity collapse */
    #minimalTimer{display:none}
    /* Rain ‚Äúshock‚Äù */
    @keyframes shake{0%,100%{transform:translate(0)}10%,30%,50%,70%,90%{transform:translate(-3px)}20%,40%,60%,80%{transform:translate(3px)}}
    .shocked{animation:shake .45s}
    /* Ripple pulse on click (used in rain mode) */
    .ripple{position:relative;overflow:hidden}
    .ripple::before{
      content:""; position:absolute; opacity:0; pointer-events:none;
      border:2px solid #fff; border-radius:9999px; transform:scale(0);
      left:var(--rx); top:var(--ry); width:var(--rsize); height:var(--rsize);
      margin-left:calc(var(--rsize) * -0.5); margin-top:calc(var(--rsize) * -0.5);
    }
    .ripple.pulse::before{opacity:.7;animation:rip .6s ease-out}
    @keyframes rip{to{transform:scale(1);opacity:0}}
    /* Auto-hide side nav */
    #sideNav{transition:opacity .2s} #sideNav.hiddenish{opacity:0}
    /* Night tint */
    .night { filter: brightness(.9) contrast(1.05) }
    .rain  { filter: brightness(.8) }
    /* Wet effect when raining */
    .rain .glass { filter:saturate(1.15) brightness(0.95) drop-shadow(0 10px 16px rgba(0,0,0,.5)); border-color:rgba(255,255,255,.35); }
    @keyframes flipY { 0%{transform:rotateY(0)} 100%{transform:rotateY(180deg)} }
    #hourglass.flip { animation: flipY .6s ease; transform-origin:50% 50%; }
    /* Remove border on the main timer panel, add a softer drop shadow */
    #timerView.glass { border: 0 !important; box-shadow: 0 24px 80px rgba(0,0,0,.35); }

    /* dark form controls for Settings */
    #settings select,
    #settings input[type="number"],
    #settings input[type="time"],
    #settings input[type="text"],
    #settings input[type="color"]{
      background: rgba(0,0,0,.65) !important;
      color: #fff !important;
      border: 1px solid rgba(255,255,255,.18);
    }
    #settings select option{
      background:#111; color:#fff;
    }
    #settings label { color: #fff; }
  </style>

  <!-- Firebase (paste your config below in the JS where marked) -->
  <style>
  #toastHost{position:fixed;right:16px;bottom:16px;z-index:9999;display:grid;gap:10px}
  .toast{background:#111827dd;color:#fff;padding:.8rem 1rem;border-radius:10px;box-shadow:0 10px 30px #0006;opacity:0;transform:translateY(10px);animation:toastIn .18s forwards}
  @keyframes toastIn{to{opacity:1;transform:none}}
  </style>
  <style>
  .calendar .day.crossed::after{
    content:"‚úï"; position:absolute; inset:0; display:grid; place-items:center;
    font-weight:900; font-size:2rem; color:#ef4444cc; text-shadow:0 2px 8px #0008;
    pointer-events:none;
  }
  </style>
  <style>
  /* Ensure day cells can host overlay */
  #calGrid .day{ position: relative; }

  /* Visible X when crossed (drawn with two pseudo elements) */
  #calGrid .day.crossed::before,
  #calGrid .day.crossed::after{
    content:""; position:absolute; left:14%; right:14%; top:50%;
    height:3px; border-radius:2px; background: var(--x-color, #ef4444);
    box-shadow: 0 2px 8px rgba(0,0,0,.35);
    transform-origin: left center;
  }
  #calGrid .day.crossed::before{ transform: rotate(45deg); }
  #calGrid .day.crossed::after { transform: rotate(-45deg); }

  /* Animate when crossing (add/remove the 'cross-anim' class just for the draw) */
  #calGrid .day.cross-anim::before{ transform: rotate(45deg) scaleX(0); animation:drawX .18s ease-out forwards; }
  #calGrid .day.cross-anim::after { transform: rotate(-45deg) scaleX(0); animation:drawX .18s ease-out .12s forwards; }
  @keyframes drawX{ to { transform: scaleX(1) rotate(0deg); } }
  </style>
  <style>
  /* Cross-fade background layers */
  .bg-layer{
    position: fixed; inset: 0; z-index: -1;
    background-position: center; background-size: cover; background-repeat: no-repeat;
    opacity: 0; transition: opacity .45s ease; will-change: opacity;
  }
  .bg-layer.show{ opacity: 1; }
  </style>
</head>
<body class="min-h-screen bg-gray-900 text-gray-50 overflow-x-hidden relative">
  <div id="toastHost" aria-live="polite"></div>

  <!-- Background layers & scrim (two layers for cross-fade) -->
  <div id="bgA" class="bg-layer"></div>
  <div id="bgB" class="bg-layer"></div>
  <div id="scrim" class="fixed inset-0 bg-black" style="opacity:var(--scrim)"></div>

  <!-- Particles canvas (leaves/snow/fireflies/rain) -->
  <canvas id="fx" class="fixed inset-0 pointer-events-none z-10"></canvas>

  <!-- Header -->
  <header class="relative z-20 flex items-center justify-between p-4 md:p-6">
    <h1 class="text-xl font-bold tracking-wide">StudyFlow</h1>
    <div class="relative">
      <button id="clockBtn" class="flex items-center gap-1 text-lg opacity-80">
        <span id="clock">--:--</span>
        <i data-lucide="chevron-down" class="w-5 h-5"></i>
      </button>

      <!-- Reminders panel -->
      <div id="remPanel" class="absolute right-0 mt-2 w-[min(92vw,360px)] z-40 glass rounded-xl p-3 hidden">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Reminders</h3>
          <button id="remNew" class="px-3 py-1 rounded-full bg-[color:var(--primary)] text-white text-sm">New</button>
        </div>
        <div id="remList" class="space-y-2 text-sm"></div>
      </div>
    </div>
  </header>

  <!-- Side nav (auto-hides) -->
  <nav id="sideNav" class="z-30 fixed top-1/2 -translate-y-1/2 right-4 flex flex-col gap-2">
    <button id="goTimer"   class="glass p-2 rounded-full" title="Timer"><i data-lucide="hourglass"></i></button>
    <button id="goCalendar" class="glass p-2 rounded-full" title="Calendar"><i data-lucide="calendar"></i></button>
    <button id="goSettings" class="glass p-2 rounded-full" title="Settings"><i data-lucide="settings"></i></button>
  </nav>

  <!-- Main Views -->
  <main class="relative z-20 p-4 md:p-8 grid place-items-center">
    <!-- TIMER -->
    <section id="timerView" class="view w-full max-w-xl glass rounded-2xl p-6 space-y-6">
      <div class="flex items-center justify-between">
        <h2 id="modeLabel" class="text-2xl font-semibold text-[color:var(--primary)]">Work</h2>
        <p id="sessionLabel" class="opacity-70">Session 1 of 4</p>
      </div>

      <!-- Hourglass -->
      <div class="mx-auto" style="width:120px;height:200px">
        <svg id="hourglass" viewBox="0 0 120 200" class="w-full h-full block">
          <!-- Frame -->
          <defs>
            <linearGradient id="frame" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="var(--ui-primary-color)"/>
              <stop offset="1" stop-color="#99bbff"/>
            </linearGradient>
            <linearGradient id="sand" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0" stop-color="var(--ui-sand-color)"/>
              <stop offset="1" stop-color="#e5c066"/>
            </linearGradient>
            <clipPath id="topGlass"><path d="M20 20 H100 V80 C78 92 70 96 60 108 C50 96 42 92 20 80 Z"/></clipPath>
            <clipPath id="botGlass"><path d="M20 180 V120 C42 108 50 104 60 92 C70 104 78 108 100 120 V180 Z"/></clipPath>
          </defs>
          <path d="M20 20 H100 V80 C78 92 70 96 60 108 C50 96 42 92 20 80 Z" fill="none" stroke="url(#frame)" stroke-width="4" />
          <path d="M20 180 V120 C42 108 50 104 60 92 C70 104 78 108 100 120 V180 Z" fill="none" stroke="url(#frame)" stroke-width="4" />
          <!-- Sand (top/bottom) -->
          <rect id="sandTop" x="22" y="22" width="76" height="56" fill="url(#sand)" clip-path="url(#topGlass)"/>
          <rect id="sandBot" x="22" y="124" width="76" height="56" fill="url(#sand)" clip-path="url(#botGlass)"/>
          <!-- Stream -->
          <line id="sandStream" x1="60" y1="108" x2="60" y2="120" stroke="url(#sand)" stroke-width="2" stroke-linecap="round" style="opacity:.9;display:none"/>
        </svg>
      </div>

      <!-- Countdown (full) -->
      <div id="fullTimer" class="text-center">
        <div id="countdown" class="text-7xl font-mono font-extrabold">25:00</div>
        <div class="mt-6 flex items-center justify-center gap-3">
          <button id="btnStart" class="px-5 py-2 rounded-full bg-[color:var(--primary)] text-white font-semibold">Start</button>
          <button id="btnPause" class="px-5 py-2 rounded-full glass" hidden>Pause</button>
          <button id="btnReset" class="p-2 rounded-full glass" title="Reset"><i data-lucide="rotate-ccw"></i></button>
          <button id="btnReminder" class="text-sm opacity-80">Set Reminder</button>
        </div>
      </div>

      <!-- Countdown (minimal, appears after 2 min inactivity) -->
      <div id="minimalTimer" class="text-center">
        <div id="minMode" class="opacity-80">Work</div>
        <div id="minTime" class="text-5xl font-mono font-extrabold">25:00</div>
        <div id="minSess" class="opacity-60 text-sm mt-2">1 of 4</div>
      </div>

  <audio id="sfx-splash"   preload="auto"></audio>
  <audio id="sfx-drawing"  preload="auto"></audio>
  <audio id="sfx-rain"     preload="auto" loop></audio>

      <!-- Reminder Modal -->
      <div id="remModal" class="hidden fixed inset-0 bg-black/60 z-40 grid place-items-center">
        <div class="glass p-4 rounded-xl w-[min(92vw,420px)]">
          <h3 class="font-semibold mb-3">Set a Reminder</h3>
          <div class="space-y-3">
            <label class="block text-sm">
              Time
              <input id="remTime" type="time" class="w-full mt-1 p-2 bg-white/10 rounded-lg">
            </label>
            <label class="block text-sm">
              Message
              <input id="remText" type="text" placeholder="Stretch / Switch tasks / etc." class="w-full mt-1 p-2 bg-white/10 rounded-lg">
            </label>
          </div>
          <div class="mt-4 flex justify-end gap-2">
            <button id="remCancel" class="glass px-4 py-2 rounded-lg">Cancel</button>
            <button id="remSaveBtn" class="px-5 py-2 rounded-full bg-[color:var(--primary)] text-white">Save</button>
          </div>
        </div>
      </div>
    </section>

    <!-- CALENDAR -->
    <section id="calendarView" class="view w-full max-w-3xl glass rounded-2xl p-6 hidden">
      <div class="flex items-center justify-between mb-4">
        <button id="prevMonth" class="glass p-2 rounded-full" title="Prev"><i data-lucide="chevron-left"></i></button>
        <h2 id="calTitle" class="text-xl font-semibold">‚Äî</h2>
        <button id="nextMonth" class="glass p-2 rounded-full" title="Next"><i data-lucide="chevron-right"></i></button>
      </div>
      <div id="calGrid" class="grid grid-cols-7 gap-2"></div>
      <!-- tiny modal placeholder -->
      <div id="taskModal" class="hidden fixed inset-0 bg-black/60 grid place-items-center z-40">
        <div class="glass p-4 rounded-xl w-[min(92vw,480px)]">
          <h3 class="font-semibold mb-2">Tasks for <span id="taskDate"></span></h3>
          <div id="taskBody" class="space-y-2 text-sm"></div>
          <div class="mt-4 text-right"><button id="taskClose" class="glass px-4 py-2 rounded-lg">Close</button></div>
        </div>
      </div>
    </section>

  <!-- SETTINGS -->
  <section id="settingsView" class="view w-full max-w-xl glass rounded-2xl p-6 hidden relative max-h-[75vh] overflow-auto">
      <div id="rainBlocker" class="absolute inset-0 hidden cursor-not-allowed z-10" title="It's raining! Don't touch the electronics! You will get shocked!"></div>
      <h2 class="text-2xl font-semibold mb-4">Settings</h2>
      <form id="settings" class="space-y-5">
        <fieldset class="border-t border-white/20 pt-4">
          <legend class="text-[color:var(--primary)] font-medium">Timer</legend>
          <div class="grid grid-cols-2 gap-3">
            <label>Work (min) <input id="setWork" type="number" min="1" class="w-full mt-1 p-2 bg-white/10 rounded-lg"></label>
            <label>Short (min) <input id="setShort" type="number" min="1" class="w-full mt-1 p-2 bg-white/10 rounded-lg"></label>
            <label>Long (min)  <input id="setLong"  type="number" min="1" class="w-full mt-1 p-2 bg-white/10 rounded-lg"></label>
            <label>Long every N sessions <input id="setInterval" type="number" min="2" class="w-full mt-1 p-2 bg-white/10 rounded-lg"></label>
          </div>
          <label class="flex items-center gap-2 mt-3">
            <input id="setAutostart" type="checkbox" class="h-5 w-5 accent-[color:var(--primary)]"> Auto-start next session
          </label>
        </fieldset>

        <fieldset class="border-t border-white/20 pt-4">
          <legend class="text-[color:var(--primary)] font-medium">Theme & Background</legend>
          <div class="grid grid-cols-2 gap-3">
            <label>Season
              <select id="setSeason" class="w-full mt-1 p-2 bg-white/10 rounded-lg">
                <option value="summer">Summer</option>
                <option value="autumn">Autumn</option>
                <option value="winter">Winter</option>
              </select>
            </label>
            <label>Timezone
              <select id="setTZ" class="w-full mt-1 p-2 bg-white/10 rounded-lg">
                <option value="Africa/Johannesburg">Africa/Johannesburg</option>
                <option value="UTC">UTC</option>
                <option value="Europe/London">Europe/London</option>
                <option value="America/New_York">America/New_York</option>
                <option value="Asia/Tokyo">Asia/Tokyo</option>
              </select>
            </label>
            <label>Slideshow <input id="setSlide" type="checkbox" checked class="h-5 w-5 accent-[color:var(--primary)]"></label>
            <label>Slide interval (sec) <input id="setSlideInt" type="number" min="3" class="w-full mt-1 p-2 bg-white/10 rounded-lg"></label>
            <label>X color <input id="setX" type="color" class="w-full h-10 mt-1 rounded-lg"></label>
            <label>Dim background (%) <input id="setDim" type="range" min="0" max="70" step="1" class="w-full mt-1"></label>
          </div>
        </fieldset>

        <div class="text-right">
          <button class="px-5 py-2 rounded-full bg-[color:var(--primary)] text-white">Save</button>
        </div>
      </form>
    </section>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded-full glass opacity-0 pointer-events-none transition-opacity">
    Settings saved ‚úî
  </div>

  <!-- Core App -->
  <script type="module">
// --- CDN helper (put near the top of your script) ---
const JSDELIVR_BASE = "https://cdn.jsdelivr.net/gh/NateJ-coder/Study-Flow-Manager@main";
const cdn = (p) => `${JSDELIVR_BASE}/${p.replace(/^\.?\//,'').split('/').map(encodeURIComponent).join('/')}`;
const ASSET_ROOT = "assets"; // you flattened to /assets

// --- fast background swap with cancellation ---
let bgAbort;
const ONE_MIN = 60_000;
// small cache-bust rounded to the minute (avoids hammering cache while ensuring new uploads show up)
const cacheBust = () => `?t=${Math.floor(Date.now()/ONE_MIN)}`;

async function swapBackground(url){
  if (bgAbort) bgAbort.abort();
  const ctrl = new AbortController(); bgAbort = ctrl;

  // Start loading the next image, but don't block the UI forever
  const img = new Image();
  const loadP = new Promise((res, rej) => { img.onload = res; img.onerror = rej; });
  img.src = url + cacheBust();

  // If it loads, swap; if it takes too long, just set the URL and let the browser stream it
  const timeout = new Promise(res => setTimeout(res, 1200)); // 1.2s soft limit
  try { await Promise.race([loadP, timeout]); } catch {}

  if (ctrl.signal.aborted) return;

  const imgSrc = img.src;
  const A = document.getElementById('bgA');
  const B = document.getElementById('bgB');
  const urlCss = `url('${imgSrc}')`;

  // reuse the same cross-fade guard from the app
  _bgTransitioning = true;
  if(_bgActive==='A'){
    if(B) B.style.backgroundImage = urlCss;
    if(A) A.style.opacity = '0'; if(B) B.style.opacity = '1'; _bgActive='B';
  }else{
    if(A) A.style.backgroundImage = urlCss;
    if(B) B.style.opacity = '0'; if(A) A.style.opacity = '1'; _bgActive='A';
  }
  setTimeout(()=>{ _bgTransitioning = false; }, 760);
}

// --- discover max slide index per prefix (cached) ---
const MAX_LS_KEY = 'sf_max_slides_v1';
let maxCache = JSON.parse(localStorage.getItem(MAX_LS_KEY) || '{}');

// --- Fast existence check (no HEAD) ---
// Ask for only the first byte. If server ignores Range, it's still fine
async function exists(url) {
  try {
    const r = await fetch(url, {
      method: 'GET',
      headers: { 'Range': 'bytes=0-0' },
      cache: 'no-store',
    });
    // 206 = partial accepted, 200 = full (still OK), 304 = cached OK
    return r.status === 206 || r.status === 200 || r.status === 304;
  } catch { return false; }
}

async function discoverMax(prefix){ // e.g. "summer-day" or "rain-bg"
  const cached = maxCache[prefix];
  if (cached && Date.now() < cached.ttl) return cached.n;

  // exponential up, binary down (quick even for big sets)
  let lo = 1, hi = 8;
  while (await exists(cdn(`${ASSET_ROOT}/images/${prefix}-${hi}.png`))) {
    lo = hi; hi <<= 1; if (hi > 512) break;
  }
  while (lo + 1 < hi) {
    const mid = (lo + hi) >> 1;
    if (await exists(cdn(`${ASSET_ROOT}/images/${prefix}-${mid}.png`))) lo = mid; else hi = mid;
  }

  maxCache[prefix] = { n: lo, ttl: Date.now() + 24*60*60*1000 }; // cache 24h
  localStorage.setItem(MAX_LS_KEY, JSON.stringify(maxCache));
  return lo;
}

let currentPrefix = null, currentMax = 8;

function prefixForState(){
  return (state.weather === 'rain')
    ? 'rain-bg'
    : `${state.season}-${state.timeOfDay}`;
}

async function updateMaxIfNeeded(){
  const p = prefixForState();
  if (p !== currentPrefix) {
    currentPrefix = p;
    currentMax = await discoverMax(p); // e.g., 13 if you uploaded 13 images
  }
}

async function nextBackgroundUrl(){
  await updateMaxIfNeeded();
  const i = ((state.slideIndex - 1) % currentMax) + 1;
  return cdn(`${ASSET_ROOT}/images/${currentPrefix}-${i}.png`);
}

// preload -> crossfade (no jank)
let cur = document.getElementById('bgA');
let next = document.getElementById('bgB');
cur.classList.add('show');

async function refreshBackground(){
  const urlBase = await nextBackgroundUrl();
  const url = urlBase + cacheBust();

  // preload (race against a short timeout so we don't block forever)
  const img = new Image();
  const ready = new Promise(res => { img.onload = res; img.onerror = res; });
  img.src = url;
  await Promise.race([ready, new Promise(res=>setTimeout(res, 900))]); // don't block too long

  next.style.backgroundImage = `url("${url}")`;
  next.classList.add('show');
  cur.classList.remove('show');
  [cur, next] = [next, cur];
}

// Point audio to CDN during init
document.getElementById('sfx-splash').src = cdn(`${ASSET_ROOT}/audio/splash.mp3`);
document.getElementById('sfx-drawing').src = cdn(`${ASSET_ROOT}/audio/drawing.mp3`);
document.getElementById('sfx-rain').src    = cdn(`${ASSET_ROOT}/audio/rainfall.mp3`);

// --- Toast helper ---
function toast(msg, ms=2800){
  const host = document.getElementById('toastHost');
  if(!host) return;
  const el = document.createElement('div');
  el.className='toast'; el.textContent = msg;
  host.appendChild(el);
  setTimeout(()=> el.remove(), ms);
}

// --- Local Reminders (no Firestore needed) ---
const LS_KEY = 'sf_reminders_v1';
const reminders = new Map(JSON.parse(localStorage.getItem(LS_KEY)||'[]'));

function saveReminders(){
  localStorage.setItem(LS_KEY, JSON.stringify([...reminders.entries()]));
}

function scheduleTick(){
  setInterval(()=> {
    const now = Date.now();
    for(const [id, r] of reminders){
      if(!r.fired && now >= r.when){
        r.fired = true; saveReminders();
        try { document.getElementById('sfx-splash')?.play?.(); } catch{}
        toast(r.text || "‚è∞ Time‚Äôs up!");
        if ('Notification' in window && Notification.permission === 'granted'){
          new Notification('Reminder', { body: r.text || 'Time!' });
        }
      }
    }
  }, 15_000);
}
scheduleTick();

(async ()=>{ if ('Notification' in window && Notification.permission==='default'){ try{ await Notification.requestPermission(); }catch{} }})();

// Hook up Save button
const remTimeEl = document.getElementById('remTime');
const remTextEl = document.getElementById('remText');
document.getElementById('remSaveBtn')?.addEventListener('click', ()=>{
  if(!remTimeEl?.value) return toast('Choose a time.');
  const [h,m] = remTimeEl.value.split(':').map(Number);
  const now = new Date();
  const target = new Date();
  target.setHours(h, m, 0, 0);
  if(target.getTime() <= now.getTime()) target.setDate(target.getDate()+1);
  const id = crypto.randomUUID();
  reminders.set(id, { id, when: target.getTime(), text: remTextEl?.value?.trim() || 'Reminder', fired: false });
  saveReminders();
  toast("Alright, I'll remind you then Mr. Johnson! üòä");
});

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDocs, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ===== Icons =====
    lucide.createIcons();

    // ===== Firebase (paste your config) =====
    const firebaseConfig = {
      apiKey: "AIzaSyDiY_fxXuLNSTgpPIiHTkmvSAlT-Owqkgc",
      authDomain: "studyflowapp-2dfd0.firebaseapp.com",
      projectId: "studyflowapp-2dfd0",
      storageBucket: "studyflowapp-2dfd0.firebasestorage.app",
      messagingSenderId: "292997866503",
      appId: "1:292997866503:web:a999c0ef9d3f06b61136a2",
      measurementId: "G-CEJ384DE17"
    };

    // ===== Favicon helpers =====
    function setFaviconFromSvg(svgString){
      let link = document.querySelector('link#favicon');
      if(!link){ link = document.createElement('link'); link.id='favicon'; link.rel='icon'; link.type='image/svg+xml'; document.head.appendChild(link); }
      link.href = 'data:image/svg+xml;utf8,' + encodeURIComponent(svgString);
    }

    function svgFavicon({bg1='#1e293b', bg2='#0f172a', frame='#6ee7b7', sand='#f2d16b'}){
      return `
  <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'>
    <defs>
      <linearGradient id='bg' x1='0' y1='0' x2='0' y2='1'>
        <stop offset='0' stop-color='${bg1}'/><stop offset='1' stop-color='${bg2}'/>
      </linearGradient>
    </defs>
    <rect x='2' y='2' width='60' height='60' rx='14' fill='url(#bg)'/>
    <rect x='2' y='2' width='60' height='60' rx='14' fill='none' stroke='#ffffff22'/>
    <path d='M18 12h28v15c-8 5-8 5-14 11-6-6-6-6-14-11V12zm0 40V37c8-5 8-5 14-11 6 6 6 6 14 11v15H18z'
          fill='none' stroke='${frame}' stroke-width='3' stroke-linejoin='round'/>
    <rect x='22' y='14' width='20' height='10' rx='2' fill='${sand}'/>
    <rect x='22' y='40' width='20' height='10' rx='2' fill='${sand}'/>
    <circle cx='32' cy='32' r='1.5' fill='${sand}'/>
  </svg>`;
    }

    function updateFavicon(){
      // season palette
      let palette = {
        summer: { bg1:'#12361f', bg2:'#0b2416', frame:'#34d399', sand:'#f2d16b' },
        autumn: { bg1:'#3b1a0f', bg2:'#240e07', frame:'#fb923c', sand:'#8b5e3c' },
        winter: { bg1:'#0b1e3b', bg2:'#081429', frame:'#60a5fa', sand:'#cfd8dc' },
      }[state.season] || { bg1:'#1e293b', bg2:'#0f172a', frame:'#a78bfa', sand:'#f2d16b' };

      // night tweak
      if(state.timeOfDay==='night'){ palette.bg1 = '#0b1220'; palette.bg2 = '#070b14'; }

      // rain tweak
      if(state.weather==='rain'){ palette.sand = '#79c0ff'; }

      setFaviconFromSvg(svgFavicon(palette));
    }
  // init Firebase app + Firestore
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
    // (Optional) Load SDKs later as needed. Config present for future Firestore/calendar storage. :contentReference[oaicite:2]{index=2}

    // ===== State =====
    const state = {
      season: 'summer',                 // summer | autumn | winter
      timeOfDay: 'day',                 // day | night (auto by clock)
      weather: 'clear',                 // clear | rain (scheduled)
      slideIndex: 1,
      slideOn: true,
  slideSec: 15,                    // friendlier default (seconds); user can change in Settings
      tz: 'Africa/Johannesburg',
      // Pomodoro
      workMin: 25, shortMin: 5, longMin: 15, longEvery: 4, autostart: true,
      mode: 'work',                     // work | short | long
      sessionNum: 1,
      totalSec: 25*60,                  // remaining seconds for current session
      timerId: null,
      // inactivity
      inactive: false,
      // rain cycle
      rainCycleMs: 2*60*60*1000,        // every 2h
      rainDurationMs: 45*60*1000,       // rains 45 min
      rainTimeout: null, clearTimeoutId: null,
      // calendar
      calDate: new Date()
    };

// BG globals must exist before any clock-driven background change can run
let _bgActive = 'A';
let _bgTransitioning = false;

    // ===== El helpers =====
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    // ===== Nav switching =====
    const show = id => {
      ['#timerView','#calendarView','#settingsView'].forEach(s => $(s).classList.add('hidden'));
      $(id).classList.remove('hidden');
    };
    $('#goTimer'   ).onclick = ()=> show('#timerView');
    $('#goCalendar').onclick = ()=> { show('#calendarView'); renderCalendar(); };
    $('#goSettings').onclick = ()=> show('#settingsView');

    // ===== Perpetual clock + day/night switch =====
    function tickClock(){
      const now = new Date();
      const fmt = new Intl.DateTimeFormat('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false,timeZone:state.tz});
      $('#clock').textContent = fmt.format(now);
      const hour = Number(new Intl.DateTimeFormat('en-GB',{hour:'2-digit',hour12:false,timeZone:state.tz}).format(now));
      const was = state.timeOfDay;
      state.timeOfDay = (hour>=6 && hour<18) ? 'day' : 'night';
      if (state.timeOfDay !== was){
        applyTheme(); setParticleTheme();
        // If a fade is mid-flight or not initialized yet, just set instantly
        if (typeof _bgTransitioning === 'undefined') { setBackground(); }
        else { refreshBackground(); }
      }
    }
    setInterval(tickClock, 1000); tickClock();

    // ===== Background slideshow & pathing =====
    // legacy bgPath left for backwards compat (not used by new flow)
    function bgPath(){
      if (state.weather === 'rain') {
        const i = ((state.slideIndex - 1) % 9) + 1;
        return cdn(`${ASSET_ROOT}/images/rain-bg-${i}.png`);
      }
      const i = ((state.slideIndex - 1) % 8) + 1;
      return cdn(`${ASSET_ROOT}/images/${state.season}-${state.timeOfDay}-${i}.png`);
    }

  // Background helpers with preloading + transition guard
    function preloadImage(src){
      return new Promise((res)=>{
        const img = new Image();
        img.onload = () => res(img);
        img.onerror = () => res(img); // resolve on error to avoid blocking
        img.src = src;
      });
    }

    // replace old preload/set helpers with async-aware refreshBackground + swapBackground
    async function setBackground(){ // instant (used at boot)
      // set both layers to the current background without a visible cross-fade
      try{
        const url = await nextBackgroundUrl();
        const urlCss = `url('${url + cacheBust()}')`;
        const A = document.getElementById('bgA');
        const B = document.getElementById('bgB');
        if(A) A.style.backgroundImage = urlCss;
        if(B) B.style.backgroundImage = urlCss;
      }catch(e){ /* non-fatal */ }
    }
    function startSlideshow(){
      stopSlideshow();
      if(!state.slideOn) return;
      state._slideTimer = setInterval(()=>{ state.slideIndex++; refreshBackground(); }, state.slideSec*1000);
    }
    function stopSlideshow(){ if(state._slideTimer){ clearInterval(state._slideTimer); state._slideTimer=null; } }

    // ===== Theme application =====
    function applyTheme(){
      const root = document.documentElement;
      let primary, sand;
      if(state.season==='summer'){ primary='#4CAF50'; sand='#FFC107'; }
      else if(state.season==='autumn'){ primary='#FF5722'; sand='#8B5E3C'; }
      else /* winter */ { primary='#2196F3'; sand='#CFD8DC'; }
  root.style.setProperty('--ui-primary-color', primary);
  // If raining, tint sand bluish
  if(state.weather==='rain'){ sand = '#79c0ff'; }
      root.style.setProperty('--ui-sand-color', sand);
      document.body.classList.toggle('night', state.timeOfDay==='night');
      document.body.classList.toggle('rain',  state.weather==='rain');
      // lock settings during rain
      $('#rainBlocker').classList.toggle('hidden', state.weather!=='rain');
      setParticleTheme();
      // Number color by theme (always white at night; seasonal only by day)
      const countdown = $('#countdown');
      if(countdown){
        if(state.timeOfDay==='night'){
          countdown.style.color = '#ffffff';        // always white at night
        }else if(state.weather==='rain'){
          countdown.style.color = '#cfe9ff';
        }else if(state.season==='winter'){
          countdown.style.color = '#000000';
        }else{
          countdown.style.color = '#ffffff';
        }
      }
      // update favicon to match current theme
      try{ updateFavicon(); }catch(e){ /* non-fatal */ }
    }

    // Shock blocker
    const _rb = $('#rainBlocker');
    if(_rb){
      _rb.addEventListener('click', ()=>{
        $('#settingsView').classList.add('shocked');
        setTimeout(()=> $('#settingsView').classList.remove('shocked'), 500);
        const a=$('#sfx-splash'); if(a){ a.currentTime=0; a.play().catch(()=>{}); } // cheeky zap ;)
      });
    }

    // ===== Rain scheduler (every 2h, lasts 45 min) =====
    function scheduleRainCycle(){
      // Clear old timers
      if(state.rainTimeout){ clearTimeout(state.rainTimeout); state.rainTimeout=null; }
      if(state.clearTimeoutId){ clearTimeout(state.clearTimeoutId); state.clearTimeoutId=null; }
      // Next start in 2h from app open
      state.rainTimeout = setTimeout(()=> {
    // Start rain
  state.weather='rain'; applyTheme(); setParticleTheme(); refreshBackground(); startRainAudio();
        // Wet ripple on all .glass buttons while raining
        $$('.glass, button').forEach(b=> b.addEventListener('click', rainRippleOnce, {once:false}));
        // Stop after 45 min
        state.clearTimeoutId = setTimeout(()=>{
          state.weather='clear'; applyTheme(); setParticleTheme(); refreshBackground(); stopRainAudio();
          $$('.glass, button').forEach(b=> b.removeEventListener('click', rainRippleOnce));
        }, state.rainDurationMs);
        // Schedule next in additional 75 min (remaining of 2h window) so cadence stays every 2h
        state.rainTimeout = setTimeout(scheduleRainCycle, state.rainCycleMs - state.rainDurationMs);
      }, state.rainCycleMs);
    }
    // ===== Firestore helpers: Reminders & Calendar tasks =====
    async function saveReminderFS(r){
      const id = r.id || crypto.randomUUID();
      const ref = doc(collection(db,'reminders'), id);
      await setDoc(ref, { id, when:r.when, msg:r.msg });
      return id;
    }
    async function loadRemindersFS(){
      const snap = await getDocs(collection(db,'reminders'));
      const arr = []; snap.forEach(d=> arr.push(d.data())); return arr;
    }
    async function deleteReminderFS(id){
      await deleteDoc(doc(collection(db,'reminders'), id));
    }

    // calendar helpers
    function ymKey(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
    function ddKey(day){ return String(day).padStart(2,'0'); }
    async function loadTasksForDay(year,month,day){
      const col = collection(db, 'calendar', `${year}-${String(month+1).padStart(2,'0')}`, 'days', ddKey(day), 'tasks');
      const snap = await getDocs(col); const arr=[]; snap.forEach(s=>arr.push(s.data())); return arr;
    }
    async function addTask(year,month,day,text){
      const id = crypto.randomUUID();
      const ref = doc(db, 'calendar', `${year}-${String(month+1).padStart(2,'0')}`, 'days', ddKey(day), 'tasks', id);
      await setDoc(ref, { id, text, done:false });
    }
    async function toggleTask(year,month,day,id,done){
      const ref = doc(db, 'calendar', `${year}-${String(month+1).padStart(2,'0')}`, 'days', ddKey(day), 'tasks', id);
      const snap = await getDoc(ref); if(!snap.exists()) return;
      const data = snap.data(); await setDoc(ref, {...data, done});
    }
    async function deleteTask(year,month,day,id){
      const ref = doc(db, 'calendar', `${year}-${String(month+1).padStart(2,'0')}`, 'days', ddKey(day), 'tasks', id);
      await deleteDoc(ref);
    }
    async function moveIncompleteToNext(year,month,day){
      const tasks = await loadTasksForDay(year,month,day);
      const next = new Date(year,month,day+1);
      for(const t of tasks){
        if(!t.done){ await addTask(next.getFullYear(), next.getMonth(), next.getDate(), t.text); }
      }
    }
    function rainRippleOnce(e){
      const el = e.currentTarget;
      el.classList.add('ripple','pulse');
      const r = el.getBoundingClientRect(); const d = Math.max(r.width,r.height)*1.8;
      el.style.setProperty('--rsize', d+'px'); el.style.setProperty('--rx', (e.clientX-r.left)+'px'); el.style.setProperty('--ry',(e.clientY-r.top)+'px');
      setTimeout(()=> el.classList.remove('pulse'), 620);
    }
    function startRainAudio(){ const a=$('#sfx-rain'); if(!a) return; a.currentTime=0; a.play().catch(()=>{}); }
    function stopRainAudio(){ const a=$('#sfx-rain'); if(!a) return; a.pause(); }

    // Inactivity (2 min): hide big panel, show dock at bottom
    let idle;
    function renderDock(){
      $('#dockMode').textContent = (state.mode==='work' ? 'Work' : state.mode==='short' ? 'Short' : 'Long');
      const mm = t=> String(Math.floor(t/60)).padStart(2,'0');
      const ss = t=> String(Math.floor(t%60)).padStart(2,'0');
      $('#dockTime').textContent = `${mm(state.totalSec)}:${ss(state.totalSec)}`;
    }
    function collapseToDock(){
      state.inactive = true;
      $('#timerView').style.display = 'none';
      $('#dockTimer').classList.remove('hidden'); renderDock();
    }
    function expandFromDock(){
      state.inactive = false;
      $('#timerView').style.display = ''; 
      $('#dockTimer').classList.add('hidden');
    }
    function resetIdle(){
      clearTimeout(idle);
      if(state.inactive) expandFromDock();
      idle = setTimeout(collapseToDock, 120000);
    }
    ['mousemove','keydown','click','scroll','touchstart'].forEach(ev => document.addEventListener(ev, resetIdle));
    resetIdle();

    // keep dock time fresh
    setInterval(()=>{ if(state.inactive) renderDock(); }, 1000);

    // ===== Side nav auto-hide (3s) =====
    let navTimer;
    function showNav(){ $('#sideNav').classList.remove('hiddenish'); clearTimeout(navTimer); navTimer=setTimeout(()=>$('#sideNav').classList.add('hiddenish'),3000); }
    document.addEventListener('mousemove', e => { if(window.innerWidth - e.clientX < 120) showNav(); });
    showNav();

    // ===== Pomodoro state machine =====
    function readSettings(){
      // Read current form values (if present) else keep defaults
      const v = id => document.getElementById(id)?.value;
      const cb = id => document.getElementById(id)?.checked;
      state.workMin   = Number(v('setWork')  ?? state.workMin)   || state.workMin;
      state.shortMin  = Number(v('setShort') ?? state.shortMin)  || state.shortMin;
      state.longMin   = Number(v('setLong')  ?? state.longMin)   || state.longMin;
      state.longEvery = Number(v('setInterval') ?? state.longEvery) || state.longEvery;
      state.autostart = cb('setAutostart') ?? state.autostart;
      state.season    = v('setSeason') ?? state.season;
      state.tz        = v('setTZ') ?? state.tz;
      state.slideOn   = document.getElementById('setSlide')?.checked ?? state.slideOn;
      state.slideSec  = Number(v('setSlideInt') ?? state.slideSec) || state.slideSec;
      document.documentElement.style.setProperty('--scrim', ((document.getElementById('setDim')?.value ?? 28)/100));
      const xCol = document.getElementById('setX')?.value; if(xCol) document.documentElement.style.setProperty('--x-color', xCol);
    }
    function durationFor(mode){
      if(mode==='work') return state.workMin*60;
      if(mode==='short') return state.shortMin*60;
      return state.longMin*60;
    }
    function updateTimerUI(){
      const mm = t=> String(Math.floor(t/60)).padStart(2,'0');
      const ss = t=> String(t%60).padStart(2,'0');
      $('#countdown').textContent = `${mm(state.totalSec)}:${ss(state.totalSec)}`;
      $('#minTime').textContent   = `${mm(state.totalSec)}:${ss(state.totalSec)}`;
      $('#modeLabel').textContent = (state.mode==='work' ? 'Work' : (state.mode==='short' ? 'Short Break' : 'Long Break'));
      $('#minMode').textContent   = $('#modeLabel').textContent;
      $('#sessionLabel').textContent = `Session ${state.sessionNum} of ${state.longEvery}`;
      $('#minSess').textContent      = `${state.sessionNum} of ${state.longEvery}`;
      // hourglass
      updateHourglass(durationFor(state.mode), state.totalSec);
    }
    function switchMode(){
      const hg = document.getElementById('hourglass');
      if(hg){ hg.classList.add('flip'); setTimeout(()=> hg.classList.remove('flip'), 650); }

      if(state.mode==='work'){
        // Completed a work session
        if(state.sessionNum % state.longEvery === 0){ state.mode='long'; } else { state.mode='short'; }
      }else{
        // Moving back to work
        state.sessionNum = (state.mode==='long') ? 1 : state.sessionNum+1;
        state.mode='work';
      }
      state.totalSec = durationFor(state.mode);
      updateTimerUI();
    }
    function startNextSession(){
      switchMode();
      if(state.autostart) startTimer();
    }
    function onCompleteBeep(){ const a=$('#sfx-splash'); if(a){ a.currentTime=0; a.play().catch(()=>{});} }
    function startTimer(){
      if(state.timerId) return;
      const hg = document.getElementById('hourglass');
      if(hg){ hg.classList.add('flip'); setTimeout(()=> hg.classList.remove('flip'), 650); }
      $('#btnStart').hidden = true; $('#btnPause').hidden = false;
      state.timerId = setInterval(()=>{
        state.totalSec--;
        if(state.totalSec<=0){
          clearInterval(state.timerId); state.timerId=null;
          onCompleteBeep();
          startNextSession();
        }
        updateTimerUI();
      },1000);
    }
    function pauseTimer(){ if(state.timerId){ clearInterval(state.timerId); state.timerId=null; } $('#btnStart').hidden=false; $('#btnPause').hidden=true; }
    function resetTimer(){
      pauseTimer();
      state.mode='work'; state.sessionNum=1; state.totalSec=durationFor('work'); updateTimerUI();
    }
    $('#btnStart').onclick=startTimer; $('#btnPause').onclick=pauseTimer; $('#btnReset').onclick=resetTimer;

    // ===== Hourglass SVG updater (proportional) =====
    function updateHourglass(total, left){
      const top = document.getElementById('sandTop');
      const bot = document.getElementById('sandBot');
      const stream = document.getElementById('sandStream');
      if(!top||!bot) return;

      const p = 1 - (left/Math.max(1,total)); // 0..1 poured
      const topH = 56*(1-p); // top shrinks
      const botH = 56*(p);   // bottom grows
      top.setAttribute('height', Math.max(0, topH));
      bot.setAttribute('y', 180 - botH - 0);   // anchored to bottom glass
      bot.setAttribute('height', Math.max(0, botH));
      stream.style.display = (p>0 && p<1) ? 'block' : 'none';
    }

    // ===== Settings submit =====
    $('#settings')?.addEventListener('submit', e=>{
      e.preventDefault();
  readSettings(); applyTheme(); refreshBackground(); stopSlideshow(); startSlideshow();
      const t = $('#toast'); if(t){ t.style.opacity = '1'; setTimeout(()=> t.style.opacity='0', 1400); }
    });

  // ==== Reminders (simple local scheduler) ====
  const remModal = $('#remModal'), remTime = $('#remTime'), remText = $('#remText');
    $('#btnReminder')?.addEventListener('click', ()=> {
      // prime with 5 minutes from now
      const now = new Date();
      now.setMinutes(now.getMinutes()+5);
      remTime.value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  remText.value = 'Time to switch focus';
      remModal.classList.remove('hidden');
    });
    $('#remCancel')?.addEventListener('click', ()=> remModal.classList.add('hidden'));
    // ===== Reminders panel (Firestore-backed) =====
    const clockBtn = $('#clockBtn'), remPanel = $('#remPanel'), remList = $('#remList');
    clockBtn?.addEventListener('click', ()=> remPanel.classList.toggle('hidden'));
    document.addEventListener('click', (e)=>{
      if(!remPanel.contains(e.target) && !clockBtn.contains(e.target)) remPanel.classList.add('hidden');
    });

    // Create / Edit modal reuse (we‚Äôll reuse the same modal from #timerView)
    $('#remNew')?.addEventListener('click', ()=> {
      $('#btnReminder')?.click(); // open the modal we added earlier
    });

    // Render reminders list from Firestore
    async function loadAndRenderReminders(){
      const items = await loadRemindersFS(); // from ¬ß4
      remList.innerHTML = items.length ? '' : '<div class="opacity-70">No reminders yet.</div>';
      items.sort((a,b)=> new Date(a.when) - new Date(b.when));
      for(const r of items){
        const row = document.createElement('div');
        row.className = 'glass rounded-lg p-2 flex items-center justify-between';
        row.innerHTML = `
          <div>
            <div class="font-medium">${new Date(r.when).toLocaleString()}</div>
            <div class="opacity-80">${r.msg}</div>
          </div>
          <div class="flex gap-2">
            <button class="glass px-2 py-1 rounded" data-act="edit">Edit</button>
            <button class="glass px-2 py-1 rounded" data-act="del">Del</button>
          </div>
        `;
        row.querySelector('[data-act="edit"]').onclick = ()=> openEditReminder(r);
        row.querySelector('[data-act="del"]').onclick  = async()=>{ await deleteReminderFS(r.id); await loadAndRenderReminders(); };
        remList.appendChild(row);
        scheduleReminderTimeout(r); // ensure it will fire
      }
    }

    function openEditReminder(r){
      remTime.value = new Date(r.when).toTimeString().slice(0,5);
      remText.value  = r.msg;
      remModal.classList.remove('hidden');
      // save will overwrite (we use r.id)
      $('#remSaveBtn').onclick = async()=>{
        const [hh,mm] = (remTime.value||'').split(':').map(Number);
        if(Number.isNaN(hh)||Number.isNaN(mm)) return remTime.focus();
        const now = new Date(); const target = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0);
        if(target<=now) target.setDate(target.getDate()+1);
        await saveReminderFS({id:r.id, when:target.toISOString(), msg:remText.value.trim()||'Reminder'});
        remModal.classList.add('hidden'); await loadAndRenderReminders();
      };
    }

    // When saving from the "Set Reminder" modal (new reminder path)
    const originalRemSave = $('#remSaveBtn')?.onclick; // in case defined
    $('#remSaveBtn').onclick = async()=>{
      const [hh,mm] = (remTime.value||'').split(':').map(Number);
      if(Number.isNaN(hh)||Number.isNaN(mm)) return remTime.focus();
      const now = new Date(); const target = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0);
      if(target<=now) target.setDate(target.getDate()+1);
      await saveReminderFS({when:target.toISOString(), msg:remText.value.trim()||'Reminder'});
      remModal.classList.add('hidden');
      await loadAndRenderReminders();
    };

    // schedule firing + toast + sound
    const _remTimers = new Map();
    function scheduleReminderTimeout(r){
      // don‚Äôt double-schedule
      if(_remTimers.has(r.id)) return;
      const now = Date.now(), t = new Date(r.when).getTime();
      const ms = t - now;
      if(ms <= 0) return; // past reminder; ignore or handle as "missed"
      const id = setTimeout(async()=>{
        const a=$('#sfx-splash'); a && a.play().catch(()=>{});
        const toast = $('#toast'); if(toast){ toast.textContent=r.msg; toast.style.opacity='1'; setTimeout(()=>{ toast.style.opacity='0'; toast.textContent='Settings saved ‚úî'; }, 3000); }
        _remTimers.delete(r.id);
      }, ms);
      _remTimers.set(r.id, id);
    }

    // ===== Calendar =====
    // --- Calendar cross-out store ---
    const X_KEY = 'sf_crossed_days_v1';
    const crossed = new Set(JSON.parse(localStorage.getItem(X_KEY) || '[]'));
    function persistCrossed(){ localStorage.setItem(X_KEY, JSON.stringify([...crossed])); }

    // Call this after you render each day cell:
    function wireDayCell(cell){ // cell must have data-date="YYYY-MM-DD"
      const date = cell.dataset.date;
      // right-click toggles an X with a draw animation
      cell.addEventListener('contextmenu', (e)=>{
        e.preventDefault();
        if(!date) return; // guard
        const isCrossed = crossed.has(date);
        if (isCrossed){
          crossed.delete(date);
          cell.classList.remove('crossed','cross-anim');
        } else {
          crossed.add(date);
          cell.classList.add('crossed','cross-anim');
          setTimeout(()=> cell.classList.remove('cross-anim'), 400);
          celebrate();
        }
        persistCrossed();
      });
      // left-click to open tasks
      cell.addEventListener('click', ()=> openTasks(date));
      // initialize visual
      cell.classList.toggle('crossed', crossed.has(date));
    }

    // Simple celebrate popup
    const praise = [
      "All done! You crushed it! üéâ",
      "Nice! Streak maintained. üî•",
      "That‚Äôs a wrap‚Äîgreat focus! ‚úÖ",
      "Boom! Tasks completed. üí•",
      "Chef‚Äôs kiss of productivity. üëå"
    ];
    function celebrate(){ toast(praise[Math.floor(Math.random()*praise.length)]); }

    // --- Per-day tasks (localStorage) ---
    function keyFor(dateISO){ return `sf_tasks_${dateISO}`; }
    function readTasks(dateISO){ return JSON.parse(localStorage.getItem(keyFor(dateISO))||'[]'); }
    function writeTasks(dateISO, arr){ localStorage.setItem(keyFor(dateISO), JSON.stringify(arr)); }

    const tasksModal = document.getElementById('dayTasksModal');
    const tasksList = document.getElementById('tasksList');
    const tasksDateLabel = document.getElementById('tasksDateLabel');
    document.getElementById('tasksClose').onclick = ()=> tasksModal.style.display='none';

    let activeDateISO = null;

    function openTasks(dateISO){
      activeDateISO = dateISO;
      tasksDateLabel.textContent = `Tasks ‚Äî ${dateISO}`;
      renderTasks();
      tasksModal.style.display='grid';
    }

    function renderTasks(){
      const items = readTasks(activeDateISO);
      tasksList.innerHTML = '';
      items.forEach((t,i)=>{
        const row = document.createElement('div');
        row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center';
        row.innerHTML = `
          <input type="checkbox" ${t.done?'checked':''} data-i="${i}">
          <div style="flex:1;${t.done?'text-decoration:line-through;opacity:.7':''}">${t.text}</div>
          <button data-del="${i}" style="background:#374151;border:0;color:#fff;padding:.3rem .6rem;border-radius:8px">Del</button>
        `;
        tasksList.appendChild(row);
      });
      // wire
      tasksList.querySelectorAll('input[type=checkbox]').forEach(cb=>{
        cb.onchange = ()=>{
          const i = +cb.dataset.i; const arr = readTasks(activeDateISO);
          arr[i].done = cb.checked; writeTasks(activeDateISO, arr); renderTasks();
        };
      });
      tasksList.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.onclick = ()=>{
          const i = +btn.dataset.del; const arr = readTasks(activeDateISO);
          arr.splice(i,1); writeTasks(activeDateISO, arr); renderTasks();
        };
      });
    }

    document.getElementById('taskAdd').onclick = ()=>{
      const input = document.getElementById('taskText');
      const txt = input.value.trim(); if(!txt) return;
      const arr = readTasks(activeDateISO); arr.push({text:txt, done:false});
      writeTasks(activeDateISO, arr); input.value=''; renderTasks();
    };

    const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    function renderCalendar(){
      const grid = $('#calGrid'); grid.innerHTML='';
      const d = new Date(state.calDate.getFullYear(), state.calDate.getMonth(), 1);
      const month = d.getMonth(), year = d.getFullYear();
      $('#calTitle').textContent = new Intl.DateTimeFormat('en-GB',{month:'long', year:'numeric'}).format(d);
      // headers
      weekdays.forEach(w => {
        const h = document.createElement('div'); h.textContent = w; h.className = 'text-xs opacity-70';
        grid.appendChild(h);
      });
      // pad before first day
      const start = (d.getDay()+7)%7; for(let i=0;i<start;i++){ const pad = document.createElement('div'); grid.appendChild(pad); }
      // days
      const daysInMonth = new Date(year, month+1, 0).getDate();
      for(let day=1; day<=daysInMonth; day++){
        const cell = document.createElement('div');
        // keep existing 'day' class for compatibility; add 'day-cell' to host overlay
        cell.className = 'relative p-3 h-20 glass rounded-lg select-none day day-cell';
        cell.innerHTML = `<div class="text-sm opacity-80">${day}</div>`;
        // set data-date as YYYY-MM-DD
        const mm = String(month+1).padStart(2,'0');
        const dd = String(day).padStart(2,'0');
        const iso = `${year}-${mm}-${dd}`;
        cell.dataset.date = iso;

        // append overlay X element (works regardless of pseudo-element rules)
        const x = document.createElement('span');
        x.className = 'day-x'; x.textContent = '‚úï';
        cell.appendChild(x);

        // wire left/right click + initial visual
        wireDayCell(cell);
        grid.appendChild(cell);
      }
    }
    $('#prevMonth').onclick = ()=>{ state.calDate.setMonth(state.calDate.getMonth()-1); renderCalendar(); }
    $('#nextMonth').onclick = ()=>{ state.calDate.setMonth(state.calDate.getMonth()+1); renderCalendar(); }
    $('#taskClose').onclick = ()=> $('#taskModal').classList.add('hidden');

    // === Particles v2 (continuous background + mouse trail) ===
    const fx = document.getElementById('fx');
    const ctx = fx.getContext('2d', { alpha:true });
    let P = [];              // active particles
    let MAX = 120;           // target count (varies by theme)
    let MODE = 'leaves';     // leaves | snow | rain | fireflies
    function resizeFx(){ fx.width = innerWidth; fx.height = innerHeight; }
    resizeFx(); addEventListener('resize', resizeFx);

    // Mouse trail (sprinkles on move)
    document.addEventListener('mousemove', e=>{
      for(let i=0;i<2;i++){ spawn(e.clientX, e.clientY, true); }
    });

    function spawn(x = Math.random()*fx.width, y = -10, gentle=false){
      if(MODE==='rain'){
        P.push({x, y, vx:0, vy: 8+Math.random()*6, r:1, a:0.5});
      }else if(MODE==='snow'){
        P.push({x, y, vx:(Math.random()-.5)*0.6, vy: 0.6+Math.random()*0.8, r: 1.5+Math.random()*1.5, a:0.9, wob:Math.random()*6.28});
      }else if(MODE==='fireflies'){
        P.push({x, y: Math.random()*fx.height, vx:(Math.random()-.5)*0.3, vy:(Math.random()-.5)*0.3, r:2+Math.random()*2, a:0.7, flick:Math.random()*6.28});
      }else{ // leaves
        const brown = (state.season==='autumn');
        const col = brown ? '#a35420' : '#3fb34e';
        P.push({x, y, vx:(Math.random()-.5)*0.8, vy: 0.8+Math.random()*1.2, w:4, h:4, col, wob:Math.random()*6.28});
      }
      // keep cap reasonable
      if(!gentle && P.length>MAX) P.splice(0, P.length-MAX);
    }

    function tickParticles(){
      ctx.clearRect(0,0,fx.width,fx.height);
      // spawn to maintain density (skip for fireflies; they persist)
      if(MODE!=='fireflies'){
        while(P.length<MAX) spawn();
      }else if(P.length<MAX){ spawn(); }

      for(let i=P.length-1;i>=0;i--){
        const p = P[i];
        if(MODE==='rain'){
          p.y += p.vy; if(p.y>fx.height+10) { P.splice(i,1); continue; }
          ctx.globalAlpha = p.a; ctx.strokeStyle = '#7fc3ff'; ctx.lineWidth=1;
          ctx.beginPath(); ctx.moveTo(p.x, p.y-8); ctx.lineTo(p.x, p.y); ctx.stroke();
        }else if(MODE==='snow'){
          p.wob += 0.02; p.x += p.vx + Math.sin(p.wob)*0.2; p.y += p.vy;
          if(p.y>fx.height+6) { P.splice(i,1); continue; }
          ctx.globalAlpha = p.a; ctx.fillStyle = '#ffffff'; ctx.beginPath();
          ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
        }else if(MODE==='fireflies'){
          p.flick += 0.05; p.x += p.vx; p.y += p.vy;
          if(p.x<0||p.x>fx.width) p.vx*=-1; if(p.y<0||p.y>fx.height) p.vy*=-1;
          const glow = (Math.sin(p.flick)*0.5+0.5)*0.6 + 0.3;
          ctx.shadowBlur = 12; ctx.shadowColor = '#ffd86b';
          ctx.globalAlpha = glow; ctx.fillStyle = '#fff7ae';
          ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
          ctx.shadowBlur = 0;
        }else{ // leaves
          p.wob += 0.03; p.x += p.vx + Math.sin(p.wob)*0.5; p.y += p.vy;
          if(p.y>fx.height+6) { P.splice(i,1); continue; }
          ctx.globalAlpha = .9; ctx.fillStyle = p.col;
          ctx.fillRect(p.x, p.y, p.w, p.h);
        }
      }
      ctx.globalAlpha = 1;
      requestAnimationFrame(tickParticles);
    }
    tickParticles();

    // switcher called when theme/weather/time changes
    function setParticleTheme(){
      if(state.weather==='rain'){ MODE='rain'; MAX = 240; P.length=0; return; }
      if(state.timeOfDay==='night'){ MODE='fireflies'; MAX = 60; P.length=0; return; }
      if(state.season==='winter'){ MODE='snow'; MAX = 140; P.length=0; return; }
      MODE='leaves'; MAX = 120; P.length=0; // summer/autumn leaves
    }
    // call whenever theme changes:
    setParticleTheme();

    // ===== Boot =====
  (async ()=>{
    readSettings(); applyTheme(); try{ updateFavicon(); }catch(e){}
    await setBackground(); // initial, non-animated set
    startSlideshow(); renderCalendar(); scheduleRainCycle(); updateTimerUI();
    // kick off first refresh in background (non-blocking)
    refreshBackground().catch(()=>{});
  })();
  loadAndRenderReminders().catch(console.error);
  </script>
  <!-- Day Tasks modal (local per-day tasks) -->
  <div id="dayTasksModal" style="position:fixed;inset:0;display:none;place-items:center;background:#0008;z-index:70">
    <div style="width:520px;background:#111827ee;color:#fff;border-radius:14px;padding:20px;box-shadow:0 20px 60px #0006">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <strong id="tasksDateLabel">Tasks</strong>
        <button id="tasksClose" style="background:#374151;border:0;color:#fff;padding:.4rem .7rem;border-radius:8px">Close</button>
      </div>
      <div id="tasksList" style="display:grid;gap:8px;margin-bottom:12px"></div>
      <div style="display:flex;gap:8px">
        <input id="taskText" placeholder="New task‚Ä¶" style="flex:1;padding:.6rem;border-radius:8px;border:1px solid #374151;background:#111827;color:#fff">
        <button id="taskAdd" class="btn">Add</button>
      </div>
    </div>
  </div>

  <!-- Docked mini-timer -->
  <div id="dockTimer" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-40 hidden">
    <div class="glass rounded-full px-4 py-2 flex items-center gap-3 shadow-lg">
      <span id="dockMode" class="text-xs opacity-80"></span>
      <span id="dockTime" class="text-2xl font-mono font-bold"></span>
    </div>
  </div>
</body>
</html>